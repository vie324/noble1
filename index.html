<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LuxeMetrics - 高級エステサロン経営ダッシュボード</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Recharts Dependencies -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    <!-- Recharts (Chart Library) - Pinned version for stability -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>

    <!-- Babel (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Config for Tailwind (Luxury Gold Theme) -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Enable dark mode with class strategy
            theme: {
                extend: {
                    colors: {
                        gold: {
                            50: '#fbf9f1',
                            100: '#f5f0db',
                            200: '#ede0b3',
                            300: '#e3cc83',
                            400: '#d9b656',
                            500: '#d4af37', // Brand Primary
                            600: '#b48e26',
                            700: '#906d1f',
                            800: '#775820',
                            900: '#624920',
                        },
                        brown: {
                            50: '#f7f5f3',
                            800: '#4a3b32', // Brand Text
                            900: '#2d241e',
                        },
                        accent: {
                            500: '#c084fc', // Subtle accent for charts
                        }
                    },
                    fontFamily: {
                        sans: ['"Yu Mincho"', '"Hiragino Mincho ProN"', '"MS PMincho"', 'serif'], // Serif for luxury feel
                        ui: ['"Helvetica Neue"', 'Arial', 'sans-serif'], // UI font
                    }
                }
            }
        }
    </script>
    <style>
        /* Base Styles */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body {
            background-color: #f7f5f3; /* brown-50 */
            color: #4a3b32; /* brown-800 */
            font-family: "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 0;
            overscroll-behavior-y: contain;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dark Mode Styles - Optimized for Eye Comfort and Visibility */
        .dark body {
            background-color: #1a1a1a;
            color: #e5e5e5;
        }

        /* Background Colors - Softer and More Visible */
        .dark .bg-brown-50,
        .dark .bg-\[#f9f8f4\] {
            background-color: #1a1a1a !important;
        }

        .dark .bg-white {
            background-color: #2d2d2d !important;
        }

        .dark .bg-gray-50 {
            background-color: #2a2a2a !important;
        }

        .dark .bg-gray-100 {
            background-color: #333333 !important;
        }

        .dark .bg-gray-200 {
            background-color: #3d3d3d !important;
        }

        /* Text Colors - High Contrast for Readability */
        .dark .text-brown-800 {
            color: #f0f0f0 !important;
        }

        .dark .text-gray-900 {
            color: #f5f5f5 !important;
        }

        .dark .text-gray-800 {
            color: #e8e8e8 !important;
        }

        .dark .text-gray-700 {
            color: #d8d8d8 !important;
        }

        .dark .text-gray-600 {
            color: #c0c0c0 !important;
        }

        .dark .text-gray-500 {
            color: #a8a8a8 !important;
        }

        .dark .text-gray-400 {
            color: #909090 !important;
        }

        .dark .text-gray-300 {
            color: #787878 !important;
        }

        /* Border Colors - Clear and Visible */
        .dark .border-gray-100 {
            border-color: #3d3d3d !important;
        }

        .dark .border-gray-200 {
            border-color: #4a4a4a !important;
        }

        .dark .border-gray-300 {
            border-color: #555555 !important;
        }

        .dark .border-gold-100 {
            border-color: #6a5228 !important;
        }

        .dark .border-gold-200 {
            border-color: #8a6a38 !important;
        }

        .dark .divide-gray-100 > * + * {
            border-color: #3d3d3d !important;
        }

        /* Gold Accent Colors - Brighter and More Vibrant */
        .dark .bg-gold-50 {
            background-color: #3a3020 !important;
        }

        .dark .bg-gold-100 {
            background-color: #4a3d28 !important;
        }

        .dark .text-gold-600 {
            color: #f0c955 !important;
        }

        .dark .text-gold-500 {
            color: #f5d45e !important;
        }

        /* Form Inputs - Clear and Readable */
        .dark input,
        .dark select,
        .dark textarea {
            background-color: #333333 !important;
            border-color: #555555 !important;
            color: #e8e8e8 !important;
        }

        .dark input:focus,
        .dark select:focus,
        .dark textarea:focus {
            background-color: #3a3a3a !important;
            border-color: #d4af37 !important;
        }

        .dark input::placeholder,
        .dark textarea::placeholder {
            color: #808080 !important;
        }

        /* Hover States - Visible Feedback */
        .dark .hover\:bg-gray-100:hover {
            background-color: #333333 !important;
        }

        .dark .hover\:bg-gray-50:hover {
            background-color: #2a2a2a !important;
        }

        .dark .hover\:bg-white:hover {
            background-color: #353535 !important;
        }

        .dark .hover\:bg-gold-50:hover {
            background-color: #4a3d28 !important;
        }

        /* Charts and Data Visualization */
        .dark .recharts-cartesian-grid-horizontal line,
        .dark .recharts-cartesian-grid-vertical line {
            stroke: #444444 !important;
        }

        .dark .recharts-text {
            fill: #c0c0c0 !important;
        }

        .dark .recharts-tooltip-wrapper {
            background-color: #2d2d2d !important;
        }

        /* Color Variants for Data Display - More Vibrant */
        .dark .bg-blue-50 {
            background-color: #263548 !important;
        }

        .dark .bg-blue-100 {
            background-color: #2f4158 !important;
        }

        .dark .bg-purple-50 {
            background-color: #3a2848 !important;
        }

        .dark .bg-purple-100 {
            background-color: #483458 !important;
        }

        .dark .bg-emerald-50 {
            background-color: #264232 !important;
        }

        .dark .bg-emerald-100 {
            background-color: #2f5040 !important;
        }

        .dark .bg-amber-50 {
            background-color: #423528 !important;
        }

        .dark .bg-amber-100 {
            background-color: #524335 !important;
        }

        .dark .bg-rose-50 {
            background-color: #422630 !important;
        }

        .dark .bg-rose-100 {
            background-color: #52323e !important;
        }

        .dark .bg-orange-50 {
            background-color: #422f26 !important;
        }

        .dark .bg-orange-100 {
            background-color: #523d32 !important;
        }

        .dark .bg-yellow-50 {
            background-color: #423c26 !important;
        }

        .dark .bg-yellow-100 {
            background-color: #524a32 !important;
        }

        .dark .text-blue-700 {
            color: #7db3ff !important;
        }

        .dark .text-purple-700 {
            color: #c8a6ff !important;
        }

        .dark .text-emerald-700 {
            color: #7de4b8 !important;
        }

        .dark .text-amber-700 {
            color: #ffc85d !important;
        }

        .dark .text-rose-700 {
            color: #ff9fb3 !important;
        }

        /* Border Colors for Data Cards - More Visible */
        .dark .border-blue-200 {
            border-color: #3a5580 !important;
        }

        .dark .border-blue-300 {
            border-color: #4a70a0 !important;
        }

        .dark .border-purple-200 {
            border-color: #553a80 !important;
        }

        .dark .border-purple-300 {
            border-color: #704aa0 !important;
        }

        .dark .border-emerald-200 {
            border-color: #3a8058 !important;
        }

        .dark .border-emerald-300 {
            border-color: #4aa070 !important;
        }

        .dark .border-amber-200 {
            border-color: #806a3a !important;
        }

        .dark .border-amber-300 {
            border-color: #a08a4a !important;
        }

        .dark .border-rose-200 {
            border-color: #803a50 !important;
        }

        .dark .border-rose-300 {
            border-color: #a04a68 !important;
        }

        .dark .border-orange-200 {
            border-color: #805a3a !important;
        }

        .dark .border-orange-300 {
            border-color: #a0754a !important;
        }

        .dark .border-yellow-200 {
            border-color: #80753a !important;
        }

        .dark .border-yellow-300 {
            border-color: #a0954a !important;
        }

        /* Shadows - Softer and More Visible */
        .dark .shadow-sm {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.4) !important;
        }

        .dark .shadow {
            box-shadow: 0 2px 4px 0 rgba(0, 0, 0, 0.3), 0 1px 2px -1px rgba(0, 0, 0, 0.3) !important;
        }

        .dark .shadow-md {
            box-shadow: 0 4px 8px -1px rgba(0, 0, 0, 0.35), 0 2px 4px -2px rgba(0, 0, 0, 0.35) !important;
        }

        .dark .shadow-lg {
            box-shadow: 0 10px 20px -3px rgba(0, 0, 0, 0.4), 0 4px 8px -4px rgba(0, 0, 0, 0.4) !important;
        }

        .dark .shadow-2xl {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5) !important;
        }

        /* Backdrop and Overlays */
        .dark .bg-black\/50 {
            background-color: rgba(0, 0, 0, 0.85) !important;
        }

        .dark .bg-white\/20 {
            background-color: rgba(255, 255, 255, 0.12) !important;
        }

        .dark .bg-white\/95 {
            background-color: rgba(45, 45, 45, 0.95) !important;
        }

        /* Header and Navigation */
        .dark header {
            background-color: rgba(45, 45, 45, 0.95) !important;
            border-bottom-color: #4a4a4a !important;
        }

        /* Icons - Better Visibility */
        .dark svg {
            opacity: 1;
        }

        /* Additional Card Styles for Better Separation */
        .dark .bg-gradient-to-br {
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        /* Gradient Backgrounds - More Vibrant in Dark Mode */
        .dark .from-gold-50 {
            --tw-gradient-from: #4a3d28 !important;
        }

        .dark .to-gold-100 {
            --tw-gradient-to: #5a4d38 !important;
        }

        .dark .from-blue-50 {
            --tw-gradient-from: #2f4158 !important;
        }

        .dark .to-blue-100 {
            --tw-gradient-to: #3f5168 !important;
        }

        .dark .from-rose-50 {
            --tw-gradient-from: #52323e !important;
        }

        .dark .to-rose-100 {
            --tw-gradient-to: #62424e !important;
        }

        .dark .from-amber-50 {
            --tw-gradient-from: #524335 !important;
        }

        .dark .to-amber-100 {
            --tw-gradient-to: #625345 !important;
        }

        .dark .from-emerald-50 {
            --tw-gradient-from: #2f5040 !important;
        }

        .dark .to-emerald-100 {
            --tw-gradient-to: #3f6050 !important;
        }

        .dark .from-gray-50 {
            --tw-gradient-from: #2a2a2a !important;
        }

        .dark .to-gray-100 {
            --tw-gradient-to: #3a3a3a !important;
        }

        /* Alert/Notification Cards */
        .dark .from-rose-600 {
            --tw-gradient-from: #a04a68 !important;
        }

        .dark .to-rose-700 {
            --tw-gradient-to: #b05a78 !important;
        }

        .dark .from-emerald-600 {
            --tw-gradient-from: #4aa070 !important;
        }

        .dark .to-emerald-700 {
            --tw-gradient-to: #5ab080 !important;
        }

        /* Button Styles - Better Visibility */
        .dark .bg-gold-500 {
            background-color: #c9a847 !important;
        }

        .dark .hover\:bg-gold-600:hover {
            background-color: #d9b857 !important;
        }

        .dark .bg-gold-600 {
            background-color: #d9b857 !important;
        }

        .dark .hover\:bg-gold-700:hover {
            background-color: #e9c867 !important;
        }

        .dark .bg-emerald-500 {
            background-color: #4aba80 !important;
        }

        .dark .hover\:bg-emerald-600:hover {
            background-color: #5aca90 !important;
        }

        .dark .bg-blue-500 {
            background-color: #5a9aff !important;
        }

        .dark .hover\:bg-blue-600:hover {
            background-color: #6aaaff !important;
        }

        .dark .hover\:bg-blue-50:hover {
            background-color: #3f5168 !important;
        }

        .dark .bg-rose-500 {
            background-color: #ff6a8a !important;
        }

        .dark .hover\:bg-rose-600:hover {
            background-color: #ff7a9a !important;
        }

        /* Table and List Styles */
        .dark table thead {
            background-color: #3a3a3a !important;
        }

        .dark table tbody tr:hover {
            background-color: #353535 !important;
        }

        /* Progress Bars */
        .dark .bg-emerald-500,
        .dark .bg-gold-500 {
            opacity: 0.9;
        }

        h1, h2, h3, .serif {
            font-family: "Yu Mincho", "Hiragino Mincho ProN", "MS PMincho", serif;
        }

        /* Mobile Typography & Layout */
        @media (max-width: 768px) {
            body {
                font-size: 16px; /* Prevent zoom on input focus */
                line-height: 1.6;
            }

            input, select, textarea {
                font-size: 16px !important; /* Prevent iOS zoom */
            }

            /* Larger touch targets */
            button, a, input[type="button"], input[type="submit"], select {
                min-height: 48px;
            }

            /* Improve scroll performance */
            * {
                -webkit-overflow-scrolling: touch;
            }

            /* Enhanced Mobile Typography */
            .mobile-title {
                font-size: 1.375rem !important; /* 22px */
                font-weight: 700 !important;
                line-height: 1.3 !important;
                letter-spacing: -0.01em !important;
            }

            .mobile-subtitle {
                font-size: 0.9375rem !important; /* 15px */
                line-height: 1.5 !important;
                font-weight: 500 !important;
            }

            .mobile-metric {
                font-size: 2.25rem !important; /* 36px */
                font-weight: 800 !important;
                line-height: 1.1 !important;
                letter-spacing: -0.02em !important;
            }

            .mobile-label {
                font-size: 0.8125rem !important; /* 13px */
                font-weight: 600 !important;
                line-height: 1.4 !important;
            }

            .mobile-body {
                font-size: 0.9375rem !important; /* 15px */
                line-height: 1.6 !important;
            }

            /* Mobile Card Spacing */
            .mobile-card {
                padding: 1rem !important;
                margin-bottom: 0.875rem !important;
                border-radius: 12px !important;
            }

            /* Compact Header */
            .mobile-header {
                height: 56px !important;
                padding: 0 0.75rem !important;
            }

            /* Button Optimization */
            .mobile-btn {
                padding: 0.875rem 1rem !important;
                font-size: 1rem !important;
                font-weight: 600 !important;
                border-radius: 10px !important;
                min-height: 48px !important;
            }

            /* Tab Optimization */
            .mobile-tab {
                padding: 0.625rem 0.875rem !important;
                font-size: 0.875rem !important;
                font-weight: 600 !important;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #d4af37;
            border-radius: 4px;
        }

        /* Range Input */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
        }
        input[type=range]:focus {
            outline: none;
        }

        /* Glass Panel */
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        /* Touch Feedback */
        .touch-feedback:active {
            transform: scale(0.97);
            transition: transform 0.1s ease-in-out;
        }

        /* Loading Skeleton */
        @keyframes skeleton-pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .skeleton {
            animation: skeleton-pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            background-color: #e5e7eb;
        }

        /* Smooth Scroll */
        html {
            scroll-behavior: smooth;
        }

        /* Safe Area Support */
        .safe-top {
            padding-top: env(safe-area-inset-top);
        }

        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Performance: Hardware Acceleration */
        .hw-accelerate {
            transform: translateZ(0);
            will-change: transform;
        }

        /* Accessibility */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High Contrast Mode */
        @media (prefers-contrast: high) {
            body {
                color: #000;
            }
            button {
                border: 2px solid currentColor;
            }
        }
    </style>

    <!--
    ╔═══════════════════════════════════════════════════════════════════════════╗
    ║                                                                           ║
    ║  LuxeMetrics - エステサロン経営ダッシュボード                               ║
    ║  Copyright (c) 2026 [あなたの会社名またはお名前]                            ║
    ║  All Rights Reserved.                                                     ║
    ║                                                                           ║
    ║  このソフトウェアは著作権法により保護されています。                          ║
    ║  無断での複製、改変、配布、商用利用を固く禁止します。                        ║
    ║                                                                           ║
    ║  This software is protected by copyright law.                            ║
    ║  Unauthorized copying, modification, distribution,                       ║
    ║  or commercial use is strictly prohibited.                               ║
    ║                                                                           ║
    ║  不正利用は法的措置の対象となる場合があります。                              ║
    ║  Unauthorized use may result in legal action.                            ║
    ║                                                                           ║
    ╚═══════════════════════════════════════════════════════════════════════════╝
    -->
</head>
<body>
    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <!-- コード保護スクリプト（レベル2: 著作権 + 基本防御）                    -->
    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <script>
        (function() {
            'use strict';

            // 著作権情報
            const COPYRIGHT = {
                owner: 'あなたの会社名またはお名前',  // ← ここを変更してください
                year: 2026,
                product: 'LuxeMetrics',
                version: '1.0'
            };

            // コンソールに警告を表示
            console.log('%c⚠️ 警告 / WARNING', 'color: red; font-size: 20px; font-weight: bold;');
            console.log(`%c━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
このアプリケーションは著作権法により保護されています。

Copyright (c) ${COPYRIGHT.year} ${COPYRIGHT.owner}
Product: ${COPYRIGHT.product} v${COPYRIGHT.version}

無断での複製、改変、配布、商用利用を固く禁止します。

This software is protected by copyright law.
Unauthorized copying, modification, or distribution
is strictly prohibited.

不正利用は法的措置の対象となる場合があります。
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`, 'font-size: 14px; line-height: 1.6;');

            // 右クリック禁止
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                alert('⚠️ 右クリックは無効化されています。\n\nThis action is disabled.');
                return false;
            });

            // キーボードショートカット禁止
            document.addEventListener('keydown', function(e) {
                // Ctrl+U (ソース表示)
                if (e.ctrlKey && e.keyCode === 85) {
                    e.preventDefault();
                    alert('⚠️ この操作は無効化されています。\n\nThis action is disabled.');
                    return false;
                }
                // Ctrl+S (保存)
                if (e.ctrlKey && e.keyCode === 83) {
                    e.preventDefault();
                    alert('⚠️ この操作は無効化されています。\n\nThis action is disabled.');
                    return false;
                }
                // Ctrl+Shift+I (デベロッパーツール)
                if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
                    e.preventDefault();
                    alert('⚠️ この操作は無効化されています。\n\nThis action is disabled.');
                    return false;
                }
                // F12 (デベロッパーツール)
                if (e.keyCode === 123) {
                    e.preventDefault();
                    alert('⚠️ この操作は無効化されています。\n\nThis action is disabled.');
                    return false;
                }
                // Ctrl+Shift+J (コンソール)
                if (e.ctrlKey && e.shiftKey && e.keyCode === 74) {
                    e.preventDefault();
                    alert('⚠️ この操作は無効化されています。\n\nThis action is disabled.');
                    return false;
                }
                // Ctrl+Shift+C (要素の検証)
                if (e.ctrlKey && e.shiftKey && e.keyCode === 67) {
                    e.preventDefault();
                    alert('⚠️ この操作は無効化されています。\n\nThis action is disabled.');
                    return false;
                }
            });

            // デベロッパーツール検知
            let devtoolsOpen = false;
            const element = new Image();

            Object.defineProperty(element, 'id', {
                get: function() {
                    if (!devtoolsOpen) {
                        devtoolsOpen = true;

                        // 警告画面を表示
                        setTimeout(() => {
                            document.body.innerHTML = `
                                <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-family: 'Arial', sans-serif;">
                                    <div style="text-align: center; color: white; padding: 60px 40px; background: rgba(0,0,0,0.4); border-radius: 20px; max-width: 700px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); backdrop-filter: blur(10px);">
                                        <div style="font-size: 80px; margin-bottom: 20px; animation: pulse 2s infinite;">⚠️</div>
                                        <h1 style="font-size: 42px; margin-bottom: 20px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">アクセス制限</h1>
                                        <div style="width: 80px; height: 4px; background: white; margin: 0 auto 30px; border-radius: 2px;"></div>
                                        <p style="font-size: 20px; line-height: 1.8; margin-bottom: 30px;">
                                            このアプリケーションは著作権により保護されています。<br>
                                            デベロッパーツールの使用は禁止されています。
                                        </p>
                                        <div style="background: rgba(255,255,255,0.1); padding: 25px; border-radius: 10px; margin: 30px 0;">
                                            <p style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">Copyright Information</p>
                                            <p style="font-size: 14px; opacity: 0.9;">
                                                <strong>Copyright © ${COPYRIGHT.year} ${COPYRIGHT.owner}</strong><br>
                                                ${COPYRIGHT.product} v${COPYRIGHT.version}<br>
                                                All Rights Reserved.
                                            </p>
                                        </div>
                                        <p style="font-size: 14px; margin-top: 30px; opacity: 0.8; line-height: 1.6;">
                                            不正な利用は法的措置の対象となる場合があります。<br>
                                            Unauthorized use may result in legal action.
                                        </p>
                                    </div>
                                </div>
                                <style>
                                    @keyframes pulse {
                                        0%, 100% { transform: scale(1); opacity: 1; }
                                        50% { transform: scale(1.1); opacity: 0.8; }
                                    }
                                </style>
                            `;
                        }, 100);
                    }
                }
            });

            // 定期的にデベロッパーツールをチェック
            setInterval(function() {
                console.log(element);
                console.clear();
            }, 1000);

            // ページ読み込み完了時のメッセージ
            window.addEventListener('load', function() {
                console.log(`%c✓ ${COPYRIGHT.product} が正常に読み込まれました`, 'color: green; font-size: 14px; font-weight: bold;');
            });

        })();
    </script>
    <!-- ═══════════════════════════════════════════════════════════════════ -->

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        // Recharts might be undefined if script fails, handle gracefully
        const RechartsLib = window.Recharts || {};
        const { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line, AreaChart, Area } = RechartsLib;

        // --- Mock Data Generators ---

        // 店舗マスタ
        const stores = [
            { id: 1, name: "新宿店", code: "shinjuku" },
            { id: 2, name: "新宿南口店", code: "shinjuku_south" }
        ];

        // メニューマスタ
        const menus = [
            { id: 1, name: "剥離ありハーブピーリング(顔)", price: 18000, cost: 3000, availableStores: [1, 2] },
            { id: 2, name: "剥離なしハーブピーリング(顔)", price: 15000, cost: 2500, availableStores: [1, 2] },
            { id: 3, name: "剥離なしハーブピーリング(ボディ)", price: 20000, cost: 3500, availableStores: [1, 2] },
            { id: 4, name: "よもぎ蒸し", price: 8000, cost: 1500, availableStores: [2] }, // 新宿南口店のみ
            { id: 5, name: "セルフホワイトニング", price: 5000, cost: 800, availableStores: [2] } // 新宿南口店のみ
        ];

        // 全角数字を半角数字に変換するヘルパー関数
        const convertToHalfWidth = (str) => {
            if (!str) return str;
            return str.replace(/[０-９]/g, (s) => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
        };

        // 数値入力用の変換ハンドラー
        const normalizeNumberInput = (value) => {
            const halfWidth = convertToHalfWidth(String(value));
            return halfWidth.replace(/[^0-9.-]/g, ''); // 数字、マイナス、小数点のみ許可
        };

        // 初期スタッフデータ（仮データ - 自由に編集可能）
        const initialStaffData = [
            {
                id: 1,
                name: '田中美咲',
                employmentType: '正社員',
                role: '店長',
                storeId: 1,
                availableMenus: [1, 2, 3],
                sales: 850000,
                target: 1000000,
                nomination: 25,
                retention: 75,
                reviewScore: 4.8
            },
            {
                id: 2,
                name: '佐藤花子',
                employmentType: '正社員',
                role: 'スタッフ',
                storeId: 1,
                availableMenus: [1, 2],
                sales: 620000,
                target: 800000,
                nomination: 18,
                retention: 68,
                reviewScore: 4.5
            },
            {
                id: 3,
                name: '鈴木彩香',
                employmentType: 'アルバイト',
                role: 'スタッフ',
                storeId: 2,
                availableMenus: [2, 4, 5],
                sales: 480000,
                target: 600000,
                nomination: 12,
                retention: 65,
                reviewScore: 4.3
            }
        ];
        // スタッフデータ構造: { id, name, employmentType, role, storeId, availableMenus, sales, target, nomination, retention, reviewScore }

        // 回数券マスターデータ（仮データ - 自由に編集可能）
        const initialTicketMasterData = [
            { id: 1, name: '5回券', sessions: 5, price: 85000, validMonths: 6, description: 'お得な5回セット' },
            { id: 2, name: '10回券', sessions: 10, price: 160000, validMonths: 12, description: '10回セット・1年間有効' }
        ];
        // 回数券マスター構造: { id, name, sessions, price, validMonths, description }

        // 顧客データ（仮データ - 自由に編集可能）
        const initialCustomerData = [
            {
                id: 1,
                name: '山田太郎',
                phone: '090-1234-5678',
                email: 'yamada@example.com',
                purchaseDate: '2025-12-01',
                ticketMasterId: 1,
                remainingSessions: 3,
                expiryDate: '2026-06-01',
                storeId: 1
            },
            {
                id: 2,
                name: '高橋愛',
                phone: '080-9876-5432',
                email: 'takahashi@example.com',
                purchaseDate: '2025-11-15',
                ticketMasterId: 2,
                remainingSessions: 7,
                expiryDate: '2026-11-15',
                storeId: 1
            },
            {
                id: 3,
                name: '佐藤健',
                phone: '090-5555-1234',
                email: 'sato@example.com',
                purchaseDate: '2025-12-20',
                ticketMasterId: 1,
                remainingSessions: 1,
                expiryDate: '2026-02-15', // 有効期限間近
                storeId: 2
            },
            {
                id: 4,
                name: '田中美香',
                phone: '080-7777-9999',
                email: 'tanaka@example.com',
                purchaseDate: '2025-12-25',
                ticketMasterId: 1,
                remainingSessions: 4,
                expiryDate: '2026-01-31', // 有効期限間近
                storeId: 1
            }
        ];
        // 顧客データ構造: { id, name, phone, email, purchaseDate, ticketMasterId, remainingSessions, expiryDate, storeId }

        // 媒体別データ（仮データ - 自由に編集可能）
        const initialMediaSourcesData = [
            { id: 1, name: 'ホットペッパー', newVisits: 45, repeatRate: 35, cpa: 8500, sales: 680000, adCost: 382500 },
            { id: 2, name: 'Instagram', newVisits: 28, repeatRate: 52, cpa: 3200, sales: 420000, adCost: 89600 },
            { id: 3, name: '紹介', newVisits: 15, repeatRate: 78, cpa: 0, sales: 320000, adCost: 0 }
        ];
        // 媒体データ構造: { id, name, newVisits, repeatRate, cpa, sales, adCost }

        // 日次売上データ（仮データ - 自由に編集可能）
        const initialDailySalesData = [
            {
                date: '2026-01-15',
                storeId: 1,
                staffId: 1,
                storeName: '新宿店',
                spotSales: 120000,
                ticketSales: 85000,
                ticketUsage: 54000,
                product: 28000,
                accountingSales: 287000,
                cashIn: 233000
            },
            {
                date: '2026-01-16',
                storeId: 1,
                staffId: 2,
                storeName: '新宿店',
                spotSales: 95000,
                ticketSales: 0,
                ticketUsage: 72000,
                product: 15000,
                accountingSales: 182000,
                cashIn: 110000
            },
            {
                date: '2026-01-15',
                storeId: 2,
                staffId: 3,
                storeName: '新宿南口店',
                spotSales: 78000,
                ticketSales: 160000,
                ticketUsage: 40000,
                product: 22000,
                accountingSales: 300000,
                cashIn: 260000
            }
        ];
        // 日次売上構造: { date, storeId, staffId, storeName, spotSales, ticketSales, ticketUsage, product, accountingSales, cashIn }

        // メニュー別売上データ（仮データ - 自由に編集可能）
        const initialMenuSalesData = [
            { menuId: 1, menuName: '剥離ありハーブピーリング(顔)', count: 8, sales: 144000, date: '2026-01-15', storeId: 1, staffId: 1 },
            { menuId: 2, menuName: '剥離なしハーブピーリング(顔)', count: 12, sales: 180000, date: '2026-01-15', storeId: 1, staffId: 2 },
            { menuId: 4, menuName: 'よもぎ蒸し', count: 6, sales: 48000, date: '2026-01-15', storeId: 2, staffId: 3 },
            { menuId: 5, menuName: 'セルフホワイトニング', count: 10, sales: 50000, date: '2026-01-16', storeId: 2, staffId: 3 }
        ];
        // メニュー売上構造: { menuId, menuName, count, sales, date, storeId, staffId }

        // --- Google Apps Script連携関数 ---

        // GASのWebアプリURLを設定（デプロイ後に実際のURLに変更してください）
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxmSKXpHDEVbHeKEIHrtk_DoQfXIsMXBExfa7CzhpkizuC_wf-UY5YqXn0Ctc4u6lbq/exec';

        /**
         * スプレッドシートにデータを保存
         */
        const saveToSpreadsheet = async (action, data) => {
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // GASの制限により必要
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: action,
                        ...data
                    })
                });

                // no-corsモードではレスポンスを読み取れないため、成功と仮定
                console.log('データ送信完了:', action);
                return { success: true, message: 'データを送信しました' };
            } catch (error) {
                console.error('スプレッドシート保存エラー:', error);
                return { success: false, message: error.toString() };
            }
        };

        /**
         * 日次売上データを保存
         */
        const saveDailySalesData = (dailySalesData) => {
            return saveToSpreadsheet('saveDailySales', { salesData: dailySalesData });
        };

        /**
         * メニュー別売上データを保存
         */
        const saveMenuSalesData = (menuSalesData) => {
            return saveToSpreadsheet('saveMenuSales', { menuData: menuSalesData });
        };

        /**
         * スタッフ実績データを保存
         */
        const saveStaffPerformanceData = (staffData) => {
            return saveToSpreadsheet('saveStaffPerformance', { staffData: staffData });
        };

        // --- Helper Components ---

        const Icon = ({ name, size = 20, color = "currentColor", className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} width={size} height={size} stroke={color} className={className}></i>;
        };

        const Card = ({ children, className = "", mobileOptimized = false }) => (
            <div className={`bg-white rounded-lg shadow-sm border border-gold-200 ${mobileOptimized ? 'mobile-card' : 'p-6'} ${className}`}>
                {children}
            </div>
        );

        const KpiCard = ({ title, value, subValue, trend, icon, color = "bg-gold-500", mobileOptimized = false }) => (
            <Card className={`hover:shadow-md transition-shadow relative overflow-hidden ${mobileOptimized ? 'touch-feedback' : ''}`} mobileOptimized={mobileOptimized}>
                {!mobileOptimized && (
                    <div className="absolute top-0 right-0 p-4 opacity-10">
                        <Icon name={icon} size={64} className="text-gold-900" />
                    </div>
                )}
                <div className={`flex justify-between items-start relative z-10 ${mobileOptimized ? 'mb-3' : 'mb-4'}`}>
                    <div className={`rounded-lg ${color} text-white shadow-md ${mobileOptimized ? 'p-2.5' : 'p-3'}`}>
                        <Icon name={icon} size={mobileOptimized ? 20 : 24} />
                    </div>
                    {trend && (
                        <span className={`font-medium ${trend > 0 ? 'text-emerald-600' : 'text-rose-500'} flex items-center bg-white/80 px-2 py-1 rounded-full ${mobileOptimized ? 'text-xs' : 'text-sm'}`}>
                            {trend > 0 ? '+' : ''}{trend}% 
                            <Icon name={trend > 0 ? 'trending-up' : 'trending-down'} size={14} className="ml-1" />
                        </span>
                    )}
                </div>
                <h3 className={`text-gray-600 font-medium serif relative z-10 ${mobileOptimized ? 'mobile-label' : 'text-sm'}`}>{title}</h3>
                <div className={`flex items-baseline relative z-10 ${mobileOptimized ? 'mt-2' : 'mt-1'}`}>
                    <span className={`font-bold text-brown-800 ${mobileOptimized ? 'mobile-metric' : 'text-2xl'}`}>{value}</span>
                </div>
                <p className={`text-gray-500 relative z-10 ${mobileOptimized ? 'mobile-subtitle mt-1.5' : 'text-xs text-gray-400 mt-1'}`}>{subValue}</p>
            </Card>
        );

        // --- Main Sections ---

        const DashboardView = ({ staffList, dailySalesData, menuSalesData, mediaSourcesData = [], customerList = [], onNavigate, mobileOptimized = false, storeData = [] }) => {
            const [viewMode, setViewMode] = useState('all'); // 'all', 'store_1', 'store_2', 'staff_{id}'
            const [selectedStaffId, setSelectedStaffId] = useState(null);
            const [periodMode, setPeriodMode] = useState('month'); // 'month', '3months', '6months', 'year', 'specific'
            const [selectedMonth, setSelectedMonth] = useState(() => {
                const today = new Date();
                return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            });

            // モバイルレイアウト用のスタイルクラス
            const cardGridClass = mobileOptimized ? 'grid-cols-1' : 'grid-cols-1 md:grid-cols-2 xl:grid-cols-4';
            const cardPadding = mobileOptimized ? 'mobile-card' : 'p-6';
            const fontSize = {
                title: mobileOptimized ? 'mobile-title' : 'text-lg',
                subtitle: mobileOptimized ? 'mobile-subtitle' : 'text-sm',
                metric: mobileOptimized ? 'mobile-metric' : 'text-3xl',
                label: mobileOptimized ? 'mobile-label' : 'text-sm',
                body: mobileOptimized ? 'mobile-body' : 'text-base',
            };
            const buttonClass = mobileOptimized ? 'mobile-btn touch-feedback' : '';
            const tabClass = mobileOptimized ? 'mobile-tab touch-feedback' : '';

            // 安全な配列チェック
            const safeCustomerList = Array.isArray(customerList) ? customerList : [];
            const safeStaffList = Array.isArray(staffList) ? staffList : [];
            const safeDailySalesData = Array.isArray(dailySalesData) ? dailySalesData : [];
            const safeStoreData = Array.isArray(storeData) && storeData.length > 0 ? storeData : stores;

            // 月を変更する関数
            const changeMonth = (offset) => {
                const [year, month] = selectedMonth.split('-').map(Number);
                const date = new Date(year, month - 1 + offset, 1);
                setSelectedMonth(`${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`);
            };

            // 期間でフィルタリングされた売上データ
            const periodFilteredSales = useMemo(() => {
                if (safeDailySalesData.length === 0) return [];

                if (periodMode === 'specific') {
                    // 特定月モード：選択された月のデータのみ
                    const [year, month] = selectedMonth.split('-').map(Number);
                    return safeDailySalesData.filter(d => {
                        if (!d.date) return false;
                        const saleDate = new Date(d.date);
                        return saleDate.getFullYear() === year && (saleDate.getMonth() + 1) === month;
                    });
                } else {
                    // 期間モード：過去の期間
                    const today = new Date();
                    const filterDate = new Date();

                    switch(periodMode) {
                        case 'month':
                            filterDate.setMonth(today.getMonth() - 1);
                            break;
                        case '3months':
                            filterDate.setMonth(today.getMonth() - 3);
                            break;
                        case '6months':
                            filterDate.setMonth(today.getMonth() - 6);
                            break;
                        case 'year':
                            filterDate.setFullYear(today.getFullYear() - 1);
                            break;
                        default:
                            filterDate.setMonth(today.getMonth() - 1);
                    }

                    return safeDailySalesData.filter(d => {
                        const saleDate = new Date(d.date);
                        return saleDate >= filterDate;
                    });
                }
            }, [safeDailySalesData, periodMode, selectedMonth]);

            // フィルタリングされた売上データ
            const filteredDailySales = useMemo(() => {
                if (!periodFilteredSales || periodFilteredSales.length === 0) return [];
                if (viewMode === 'all') return periodFilteredSales;

                // 動的な店舗フィルタリング
                if (viewMode.startsWith('store_')) {
                    const storeId = parseInt(viewMode.replace('store_', ''));
                    return periodFilteredSales.filter(d => d.storeId === storeId);
                }

                if (viewMode === 'staff' && selectedStaffId) {
                    return periodFilteredSales.filter(d => d.staffId === selectedStaffId);
                }

                return periodFilteredSales;
            }, [periodFilteredSales, viewMode, selectedStaffId]);

            // 月次集計データ
            const monthlyData = useMemo(() => {
                if (!periodFilteredSales || periodFilteredSales.length === 0) return [];

                const monthMap = {};
                periodFilteredSales.forEach(entry => {
                    const date = new Date(entry.date);
                    const monthKey = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}`;

                    if (!monthMap[monthKey]) {
                        monthMap[monthKey] = {
                            month: monthKey,
                            accountingSales: 0,
                            cashIn: 0,
                            ticketSales: 0,
                            ticketUsage: 0,
                            spotSales: 0,
                            product: 0
                        };
                    }

                    monthMap[monthKey].accountingSales += entry.accountingSales || 0;
                    monthMap[monthKey].cashIn += entry.cashIn || 0;
                    monthMap[monthKey].ticketSales += entry.ticketSales || 0;
                    monthMap[monthKey].ticketUsage += entry.ticketUsage || 0;
                    monthMap[monthKey].spotSales += entry.spotSales || 0;
                    monthMap[monthKey].product += entry.product || 0;
                });

                return Object.values(monthMap).sort((a, b) => a.month.localeCompare(b.month));
            }, [periodFilteredSales]);

            const filteredStaffList = useMemo(() => {
                if (viewMode === 'all' || viewMode === 'staff') return staffList;
                if (viewMode === 'store_1') return staffList.filter(s => s.storeId === 1);
                if (viewMode === 'store_2') return staffList.filter(s => s.storeId === 2);
                return staffList;
            }, [staffList, viewMode]);

            // 合計計算
            const totalAccountingSales = filteredDailySales.reduce((acc, curr) => acc + (curr.accountingSales || 0), 0);
            const totalCashIn = filteredDailySales.reduce((acc, curr) => acc + (curr.cashIn || 0), 0);
            const totalTicketUsage = filteredDailySales.reduce((acc, curr) => acc + (curr.ticketUsage || 0), 0);
            const totalTicketSales = filteredDailySales.reduce((acc, curr) => acc + (curr.ticketSales || 0), 0);

            // 有効期限が近い顧客を計算（30日以内）
            const expiringCustomers = useMemo(() => {
                const today = new Date();
                const thirtyDaysLater = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);

                return safeCustomerList.filter(customer => {
                    if (!customer.expiryDate) return false;
                    const expiryDate = new Date(customer.expiryDate);
                    return expiryDate >= today && expiryDate <= thirtyDaysLater && customer.remainingSessions > 0;
                });
            }, [safeCustomerList]);

            if (!window.Recharts) return <div>Loading Charts... (If this persists, please refresh)</div>;

            // データが空の場合の表示
            const hasData = (Array.isArray(safeStaffList) && safeStaffList.length > 0) || safeDailySalesData.length > 0;

            if (!hasData) {
                return (
                    <div className="flex flex-col items-center justify-center py-20">
                        <div className="bg-white rounded-xl p-12 shadow-lg border border-gold-200 text-center max-w-2xl">
                            <div className="w-20 h-20 bg-gold-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                <Icon name="sparkles" size={40} className="text-gold-600" />
                            </div>
                            <h2 className="text-2xl font-bold text-brown-800 mb-4 serif">エステサロンダッシュボードへようこそ！</h2>
                            <p className="text-gray-600 mb-8 leading-relaxed">
                                まだデータが登録されていません。<br/>
                                以下の手順でダッシュボードを使い始めましょう。
                            </p>
                            <div className="text-left space-y-4 bg-gold-50 rounded-lg p-6 mb-8">
                                <div className="flex items-start">
                                    <span className="bg-gold-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 flex-shrink-0">1</span>
                                    <div>
                                        <p className="font-bold text-brown-800">スタッフを登録</p>
                                        <p className="text-sm text-gray-600">左メニューの「スタッフ管理」から登録してください</p>
                                    </div>
                                </div>
                                <div className="flex items-start">
                                    <span className="bg-gold-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 flex-shrink-0">2</span>
                                    <div>
                                        <p className="font-bold text-brown-800">回数券マスターを設定</p>
                                        <p className="text-sm text-gray-600">「顧客・回数券管理」から回数券を登録してください</p>
                                    </div>
                                </div>
                                <div className="flex items-start">
                                    <span className="bg-gold-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold mr-3 flex-shrink-0">3</span>
                                    <div>
                                        <p className="font-bold text-brown-800">データを保存</p>
                                        <p className="text-sm text-gray-600">右上の「保存」ボタンでスプレッドシートに保存できます</p>
                                    </div>
                                </div>
                            </div>
                            <p className="text-xs text-gray-500">
                                💡 ヒント: スプレッドシートにデータがある場合は、右上の「読み込み」ボタンで取得できます
                            </p>
                        </div>
                    </div>
                );
            }

            // タブボタンコンポーネント
            const ViewTab = ({ id, label }) => (
                <button
                    onClick={() => setViewMode(id)}
                    className={`font-medium rounded-lg transition-all ${tabClass} ${
                        viewMode === id
                            ? 'bg-gold-500 text-white shadow-md'
                            : 'bg-white text-gray-600 hover:bg-gold-50 border border-gray-200'
                    } ${mobileOptimized ? 'px-3.5 py-2.5 text-sm font-semibold' : 'px-6 py-2.5 text-sm'}`}
                >
                    {label}
                </button>
            );

            const PeriodTab = ({ id, label }) => (
                <button
                    onClick={() => setPeriodMode(id)}
                    className={`font-medium rounded transition-all ${tabClass} ${
                        periodMode === id
                            ? 'bg-blue-500 text-white shadow'
                            : 'bg-white text-gray-600 hover:bg-blue-50 border border-gray-200'
                    } ${mobileOptimized ? 'px-3.5 py-2.5 text-sm font-semibold' : 'px-4 py-2 text-sm'}`}
                >
                    {label}
                </button>
            );

            return (
                <div className={mobileOptimized ? 'space-y-4' : 'space-y-6'}>
                    {/* 店舗/スタッフ切り替えタブ */}
                    <div className={`bg-white rounded-lg shadow-sm border border-gold-200 ${mobileOptimized ? 'p-3' : 'p-4'}`}>
                        <div className="flex items-center justify-between flex-wrap gap-4">
                            <h3 className={`font-bold text-gray-600 serif ${fontSize.subtitle}`}>表示切替</h3>
                            <div className={`flex gap-2 items-center ${mobileOptimized ? 'flex-wrap' : ''}`}>
                                <ViewTab id="all" label="全店舗合計" />
                                {safeStoreData.map(store => (
                                    <ViewTab key={store.id} id={`store_${store.id}`} label={store.name} />
                                ))}
                                <ViewTab id="staff" label="スタッフ別" />
                                {viewMode === 'staff' && (
                                    <select
                                        value={selectedStaffId || ''}
                                        onChange={(e) => setSelectedStaffId(Number(e.target.value))}
                                        className="ml-2 px-4 py-2 border border-gray-300 rounded-lg text-sm focus:border-gold-500 outline-none bg-white"
                                    >
                                        <option value="">スタッフを選択</option>
                                        {safeStaffList.map(staff => {
                                            const staffStore = safeStoreData.find(s => s.id === staff.storeId);
                                            return (
                                                <option key={staff.id} value={staff.id}>
                                                    {staff.name} ({staffStore ? staffStore.name : '店舗不明'})
                                                </option>
                                            );
                                        })}
                                    </select>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* 期間選択タブ */}
                    <div className={`bg-white rounded-lg shadow-sm border border-blue-200 ${mobileOptimized ? 'p-3' : 'p-4'}`}>
                        <div className="flex items-center justify-between flex-wrap gap-4">
                            <h3 className={`font-bold text-gray-600 serif ${fontSize.subtitle}`}>表示期間</h3>
                            <div className="flex items-center gap-4 flex-wrap">
                                <div className={`flex gap-2 ${mobileOptimized ? 'flex-wrap' : ''}`}>
                                    <PeriodTab id="specific" label="月選択" />
                                    <PeriodTab id="month" label="今月" />
                                    <PeriodTab id="3months" label="過去3ヶ月" />
                                    <PeriodTab id="6months" label="過去6ヶ月" />
                                    <PeriodTab id="year" label="過去1年" />
                                </div>
                                {periodMode === 'specific' && (
                                    <div className="flex items-center gap-2 bg-blue-50 px-3 py-2 rounded-lg border border-blue-200">
                                        <button
                                            onClick={() => changeMonth(-1)}
                                            className="p-1 hover:bg-blue-100 rounded transition-colors"
                                            title="前月"
                                        >
                                            <Icon name="chevron-left" size={18} />
                                        </button>
                                        <input
                                            type="month"
                                            value={selectedMonth}
                                            onChange={(e) => setSelectedMonth(e.target.value)}
                                            className="px-2 py-1 border border-blue-300 rounded text-sm focus:outline-none focus:border-blue-500 bg-white"
                                        />
                                        <button
                                            onClick={() => changeMonth(1)}
                                            className="p-1 hover:bg-blue-100 rounded transition-colors"
                                            title="次月"
                                        >
                                            <Icon name="chevron-right" size={18} />
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Top KPI Cards - Split Sales Types */}
                    <div className={`grid gap-4 ${cardGridClass}`}>
                        <KpiCard
                            title="会計上売上 (役務消化込)"
                            value={`¥${totalAccountingSales.toLocaleString()}`}
                            subValue={`消化額: ¥${totalTicketUsage.toLocaleString()}`}
                            trend={5.2}
                            icon="file-text"
                            color="bg-gold-600"
                            mobileOptimized={mobileOptimized}
                        />
                        <KpiCard
                            title="キャッシュイン (入金総額)"
                            value={`¥${totalCashIn.toLocaleString()}`}
                            subValue={`回数券販売: ¥${totalTicketSales.toLocaleString()}`}
                            trend={12.8}
                            icon="coins"
                            color="bg-emerald-600"
                            mobileOptimized={mobileOptimized}
                        />
                        <KpiCard
                            title="回数券未消化残高"
                            value="¥4,250,000"
                            subValue="前月比 +¥50,000 (負債増)"
                            trend={-1.2}
                            icon="layers"
                            color="bg-brown-800"
                            mobileOptimized={mobileOptimized}
                        />
                        <KpiCard
                            title="平均リピート率"
                            value="72.4%"
                            subValue="新規定着率: 45%"
                            trend={2.1}
                            icon="repeat"
                            color="bg-rose-500"
                            mobileOptimized={mobileOptimized}
                        />
                    </div>

                    <div className={`grid gap-6 ${mobileOptimized ? 'grid-cols-1' : 'grid-cols-1 lg:grid-cols-3'}`}>
                        {/* Main Chart: Sales Breakdown */}
                        <div className={mobileOptimized ? '' : 'lg:col-span-2'}>
                            <Card mobileOptimized={mobileOptimized}>
                                <div className={`flex justify-between items-center ${mobileOptimized ? 'mb-3' : 'mb-6'}`}>
                                    <div>
                                        <h2 className={`font-bold text-brown-800 serif ${fontSize.title}`}>売上構造分析</h2>
                                        {!mobileOptimized && (
                                            <p className={`text-gray-500 ${fontSize.subtitle}`}>月次推移でキャッシュイン(現金)と会計上売上(PL)の乖離を確認</p>
                                        )}
                                    </div>
                                </div>
                                <ResponsiveContainer width="100%" height={mobileOptimized ? 220 : 280}>
                                    <BarChart data={monthlyData}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e5e7eb" />
                                        <XAxis dataKey="month" tick={{fontSize: mobileOptimized ? 9 : 10, angle: -45, textAnchor: 'end'}} height={60} />
                                        <YAxis tick={{fontSize: mobileOptimized ? 9 : 10}} tickFormatter={(val) => `¥${val/10000}万`} />
                                        <Tooltip
                                            formatter={(value) => `¥${value.toLocaleString()}`}
                                            contentStyle={{
                                                backgroundColor: '#fff',
                                                borderColor: '#d4af37',
                                                fontSize: mobileOptimized ? '13px' : '14px',
                                                padding: mobileOptimized ? '6px 10px' : '8px 12px'
                                            }}
                                        />
                                        <Legend wrapperStyle={{fontSize: mobileOptimized ? '11px' : '12px'}} />
                                        <Bar dataKey="spotSales" name="都度払い" stackId="a" fill="#d4af37" />
                                        <Bar dataKey="product" name="物販" stackId="a" fill="#b48e26" />
                                        <Bar dataKey="ticketUsage" name="回数券消化(売上)" stackId="a" fill="#4a3b32" />
                                        <Bar dataKey="ticketSales" name="回数券販売(入金)" fill="#10b981" radius={[4, 4, 0, 0]} opacity={0.3} />
                                    </BarChart>
                                </ResponsiveContainer>

                                {/* 売上構造の詳細テーブル */}
                                <div className={`border-t border-gray-200 ${mobileOptimized ? 'mt-4 pt-4' : 'mt-6 pt-6'}`}>
                                    <h3 className={`font-bold text-brown-800 mb-4 ${mobileOptimized ? 'text-sm' : 'text-base'}`}>期間合計の内訳</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        {/* 都度払い */}
                                        <div className="bg-gradient-to-br from-gold-50 to-gold-100 border border-gold-200 rounded-lg p-4">
                                            <div className="flex items-center mb-2">
                                                <div className="w-3 h-3 rounded-full bg-[#d4af37] mr-2"></div>
                                                <span className="text-xs text-gray-600 font-medium">都度払い</span>
                                            </div>
                                            <p className="text-xl font-bold text-brown-800 mb-1">
                                                ¥{filteredDailySales.reduce((sum, d) => sum + (d.spotSales || 0), 0).toLocaleString()}
                                            </p>
                                            <p className="text-xs text-gray-500">
                                                {totalAccountingSales > 0 ?
                                                    `${Math.round((filteredDailySales.reduce((sum, d) => sum + (d.spotSales || 0), 0) / totalAccountingSales) * 100)}%` :
                                                    '0%'
                                                } of 会計上売上
                                            </p>
                                        </div>

                                        {/* 物販 */}
                                        <div className="bg-gradient-to-br from-amber-50 to-amber-100 border border-amber-200 rounded-lg p-4">
                                            <div className="flex items-center mb-2">
                                                <div className="w-3 h-3 rounded-full bg-[#b48e26] mr-2"></div>
                                                <span className="text-xs text-gray-600 font-medium">物販</span>
                                            </div>
                                            <p className="text-xl font-bold text-brown-800 mb-1">
                                                ¥{filteredDailySales.reduce((sum, d) => sum + (d.product || 0), 0).toLocaleString()}
                                            </p>
                                            <p className="text-xs text-gray-500">
                                                {totalAccountingSales > 0 ?
                                                    `${Math.round((filteredDailySales.reduce((sum, d) => sum + (d.product || 0), 0) / totalAccountingSales) * 100)}%` :
                                                    '0%'
                                                } of 会計上売上
                                            </p>
                                        </div>

                                        {/* 回数券消化 */}
                                        <div className="bg-gradient-to-br from-gray-50 to-gray-100 border border-gray-300 rounded-lg p-4">
                                            <div className="flex items-center mb-2">
                                                <div className="w-3 h-3 rounded-full bg-[#4a3b32] mr-2"></div>
                                                <span className="text-xs text-gray-600 font-medium">回数券消化</span>
                                            </div>
                                            <p className="text-xl font-bold text-brown-800 mb-1">
                                                ¥{totalTicketUsage.toLocaleString()}
                                            </p>
                                            <p className="text-xs text-gray-500">
                                                {totalAccountingSales > 0 ?
                                                    `${Math.round((totalTicketUsage / totalAccountingSales) * 100)}%` :
                                                    '0%'
                                                } of 会計上売上
                                            </p>
                                        </div>

                                        {/* 回数券販売 */}
                                        <div className="bg-gradient-to-br from-emerald-50 to-emerald-100 border border-emerald-200 rounded-lg p-4">
                                            <div className="flex items-center mb-2">
                                                <div className="w-3 h-3 rounded-full bg-[#10b981] mr-2"></div>
                                                <span className="text-xs text-gray-600 font-medium">回数券販売</span>
                                            </div>
                                            <p className="text-xl font-bold text-emerald-700 mb-1">
                                                ¥{totalTicketSales.toLocaleString()}
                                            </p>
                                            <p className="text-xs text-gray-500">
                                                現金収入（売上外）
                                            </p>
                                        </div>
                                    </div>

                                    {/* 合計サマリー */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                        <div className="bg-gradient-to-br from-rose-50 to-rose-100 border-2 border-rose-300 rounded-lg p-4">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <p className="text-xs text-gray-600 font-medium mb-1">会計上売上（PL）</p>
                                                    <p className="text-2xl font-bold text-brown-800">¥{totalAccountingSales.toLocaleString()}</p>
                                                </div>
                                                <Icon name="file-text" size={28} className="text-rose-300" />
                                            </div>
                                            <p className="text-xs text-gray-500 mt-2">
                                                都度払い + 物販 + 回数券消化
                                            </p>
                                        </div>
                                        <div className="bg-gradient-to-br from-blue-50 to-blue-100 border-2 border-blue-300 rounded-lg p-4">
                                            <div className="flex items-center justify-between">
                                                <div>
                                                    <p className="text-xs text-gray-600 font-medium mb-1">キャッシュイン（現金）</p>
                                                    <p className="text-2xl font-bold text-blue-700">¥{totalCashIn.toLocaleString()}</p>
                                                </div>
                                                <Icon name="dollar-sign" size={28} className="text-blue-300" />
                                            </div>
                                            <p className="text-xs text-gray-500 mt-2">
                                                都度払い + 物販 + 回数券販売
                                            </p>
                                        </div>
                                    </div>

                                    {/* 乖離説明 */}
                                    {totalAccountingSales !== totalCashIn && (
                                        <div className="mt-4 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                                            <div className="flex items-start">
                                                <Icon name="info" size={16} className="text-amber-600 mr-2 mt-0.5 flex-shrink-0" />
                                                <div className="text-xs text-gray-700">
                                                    <p className="font-bold text-amber-800 mb-1">売上とキャッシュインの乖離について</p>
                                                    <p>
                                                        <span className="font-bold">差額: ¥{Math.abs(totalAccountingSales - totalCashIn).toLocaleString()}</span>
                                                        {totalCashIn > totalAccountingSales ? ' キャッシュインが多い' : ' 会計上売上が多い'}
                                                    </p>
                                                    <p className="mt-1 text-gray-600">
                                                        回数券販売は現金収入ですが、会計上は前受金（負債）として処理されます。
                                                        回数券消化時に売上として計上されるため、PLとキャッシュフローに差が生じます。
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </Card>
                        </div>

                        {/* Side Widgets */}
                        <div className="space-y-6">
                            {/* Media Performance Mini */}
                            <Card>
                                <h3 className="text-lg font-bold text-brown-800 mb-4 serif">媒体別 新規集客状況</h3>
                                <div className="space-y-4">
                                    {(mediaSourcesData || []).slice(0, 3).map(media => (
                                        <div key={media.id} className="flex flex-col">
                                            <div className="flex justify-between text-sm mb-1">
                                                <span className="font-medium text-gray-700">{media.name}</span>
                                                <span className="font-bold text-gold-600">{media.newVisits}人</span>
                                            </div>
                                            <div className="w-full h-2 bg-gray-100 rounded-full overflow-hidden">
                                                <div 
                                                    className="h-full bg-gold-500" 
                                                    style={{width: `${(media.newVisits / 50) * 100}%`}}
                                                ></div>
                                            </div>
                                            <div className="flex justify-between text-xs text-gray-400 mt-1">
                                                <span>CPA: ¥{media.cpa.toLocaleString()}</span>
                                                <span>定着率: {media.repeatRate}%</span>
                                            </div>
                                        </div>
                                    ))}
                                    <button
                                        onClick={() => onNavigate && onNavigate('sales')}
                                        className="w-full mt-2 text-xs text-gold-600 hover:text-gold-700 text-center py-2 border border-gold-200 rounded hover:bg-gold-50 transition-colors"
                                    >
                                        全ての媒体を見る
                                    </button>
                                </div>
                            </Card>

                            {/* Ticket Alert */}
                            <div className={`p-6 rounded-lg shadow-lg ${expiringCustomers.length > 0 ? 'bg-gradient-to-br from-rose-600 to-rose-700' : 'bg-gradient-to-br from-emerald-600 to-emerald-700'} text-white`}>
                                <div className="flex items-center mb-3">
                                    <Icon name={expiringCustomers.length > 0 ? "alert-circle" : "check-circle"} size={20} className="text-white mr-2" />
                                    <h3 className="font-bold serif">有効期限アラート</h3>
                                </div>
                                {expiringCustomers.length > 0 ? (
                                    <>
                                        <p className="text-sm opacity-90 mb-4">
                                            30日以内に有効期限が切れる回数券を持つ顧客が <span className="font-bold text-white text-lg">{expiringCustomers.length}名</span> います。
                                        </p>
                                        <div className="bg-white/20 rounded p-3 mb-4 max-h-32 overflow-y-auto">
                                            {expiringCustomers.map(customer => (
                                                <div key={customer.id} className="text-xs mb-2 last:mb-0 flex justify-between items-center">
                                                    <span>{customer.name}</span>
                                                    <span className="opacity-75">{customer.expiryDate} (残{customer.remainingSessions}回)</span>
                                                </div>
                                            ))}
                                        </div>
                                    </>
                                ) : (
                                    <p className="text-sm opacity-90 mb-4">
                                        現在、30日以内に有効期限が切れる回数券はありません。
                                    </p>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Monthly Trend Chart (when period > month) */}
                    {periodMode !== 'month' && monthlyData.length > 0 && (
                        <Card mobileOptimized={mobileOptimized}>
                            <div className={mobileOptimized ? 'mb-3' : 'mb-6'}>
                                <h2 className={`font-bold text-brown-800 serif ${fontSize.title}`}>月次推移グラフ</h2>
                                {!mobileOptimized && (
                                    <p className="text-xs text-gray-500">選択期間の月ごとの売上推移を確認</p>
                                )}
                            </div>
                            <ResponsiveContainer width="100%" height={mobileOptimized ? 240 : 300}>
                                <LineChart data={monthlyData}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e5e7eb" />
                                    <XAxis dataKey="month" tick={{fontSize: mobileOptimized ? 9 : 10}} />
                                    <YAxis tick={{fontSize: mobileOptimized ? 9 : 10}} tickFormatter={(val) => `¥${val/10000}万`} />
                                    <Tooltip
                                        formatter={(value) => `¥${value.toLocaleString()}`}
                                        contentStyle={{
                                            backgroundColor: '#fff',
                                            borderColor: '#d4af37',
                                            fontSize: mobileOptimized ? '13px' : '14px',
                                            padding: mobileOptimized ? '6px 10px' : '8px 12px'
                                        }}
                                    />
                                    <Legend wrapperStyle={{fontSize: mobileOptimized ? '11px' : '12px'}} />
                                    <Line type="monotone" dataKey="accountingSales" name="会計上売上" stroke="#d4af37" strokeWidth={2} dot={{r: 4}} />
                                    <Line type="monotone" dataKey="cashIn" name="キャッシュイン" stroke="#10b981" strokeWidth={2} dot={{r: 4}} />
                                    <Line type="monotone" dataKey="ticketSales" name="回数券販売" stroke="#3b82f6" strokeWidth={2} dot={{r: 4}} />
                                </LineChart>
                            </ResponsiveContainer>

                            {/* Summary Statistics */}
                            <div className={`grid grid-cols-2 gap-3 ${mobileOptimized ? 'mt-4' : 'mt-6 md:grid-cols-4 gap-4'}`}>
                                <div className={`bg-gold-50 rounded ${mobileOptimized ? 'p-2.5' : 'p-3'}`}>
                                    <p className={`text-gray-600 ${mobileOptimized ? 'mobile-label' : 'text-xs'}`}>期間合計売上</p>
                                    <p className={`font-bold text-gold-700 ${mobileOptimized ? 'text-base mt-1' : 'text-lg'}`}>¥{monthlyData.reduce((sum, m) => sum + m.accountingSales, 0).toLocaleString()}</p>
                                </div>
                                <div className={`bg-emerald-50 rounded ${mobileOptimized ? 'p-2.5' : 'p-3'}`}>
                                    <p className={`text-gray-600 ${mobileOptimized ? 'mobile-label' : 'text-xs'}`}>期間合計入金</p>
                                    <p className={`font-bold text-emerald-700 ${mobileOptimized ? 'text-base mt-1' : 'text-lg'}`}>¥{monthlyData.reduce((sum, m) => sum + m.cashIn, 0).toLocaleString()}</p>
                                </div>
                                <div className={`bg-blue-50 rounded ${mobileOptimized ? 'p-2.5' : 'p-3'}`}>
                                    <p className={`text-gray-600 ${mobileOptimized ? 'mobile-label' : 'text-xs'}`}>月平均売上</p>
                                    <p className={`font-bold text-blue-700 ${mobileOptimized ? 'text-base mt-1' : 'text-lg'}`}>¥{Math.round(monthlyData.reduce((sum, m) => sum + m.accountingSales, 0) / monthlyData.length).toLocaleString()}</p>
                                </div>
                                <div className={`bg-rose-50 rounded ${mobileOptimized ? 'p-2.5' : 'p-3'}`}>
                                    <p className={`text-gray-600 ${mobileOptimized ? 'mobile-label' : 'text-xs'}`}>対象期間</p>
                                    <p className={`font-bold text-rose-700 ${mobileOptimized ? 'text-base mt-1' : 'text-lg'}`}>{monthlyData.length}ヶ月</p>
                                </div>
                            </div>
                        </Card>
                    )}
                </div>
            );
        };

        // --- Media Analysis Section (New) ---
        const SalesAnalysisView = ({ dailySalesData, mediaSourcesData = [], onUpdateMediaSource }) => {
             if (!window.Recharts) return <div>Loading Charts...</div>;

            const [editingAdCostId, setEditingAdCostId] = useState(null);
            const [adCostInput, setAdCostInput] = useState('');
            const [selectedMonth, setSelectedMonth] = useState(() => {
                const today = new Date();
                return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            });
            const [monthFilterEnabled, setMonthFilterEnabled] = useState(false);

            // 月を変更する関数
            const changeMonth = (offset) => {
                const [year, month] = selectedMonth.split('-').map(Number);
                const date = new Date(year, month - 1 + offset, 1);
                setSelectedMonth(`${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`);
            };

            // 空データチェック
            const hasData = (dailySalesData && dailySalesData.length > 0) || (mediaSourcesData && mediaSourcesData.length > 0);

            // 広告費の編集を開始
            const startEditAdCost = (media) => {
                setEditingAdCostId(media.id);
                setAdCostInput(String(media.adCost || 0));
            };

            // 広告費の保存
            const saveAdCost = (media) => {
                const processedValue = normalizeNumberInput(adCostInput);
                const newAdCost = processedValue === '' ? 0 : Number(processedValue);

                if (onUpdateMediaSource) {
                    onUpdateMediaSource(media.id, {
                        ...media,
                        adCost: newAdCost
                    });
                }

                setEditingAdCostId(null);
                setAdCostInput('');
            };

            // 編集をキャンセル
            const cancelEditAdCost = () => {
                setEditingAdCostId(null);
                setAdCostInput('');
            };

            // 月フィルターを適用したデータ
            const filteredDailySalesData = useMemo(() => {
                if (!dailySalesData || dailySalesData.length === 0) return [];

                if (monthFilterEnabled) {
                    const [year, month] = selectedMonth.split('-').map(Number);
                    return dailySalesData.filter(d => {
                        if (!d.date) return false;
                        const saleDate = new Date(d.date);
                        return saleDate.getFullYear() === year && (saleDate.getMonth() + 1) === month;
                    });
                }

                return dailySalesData;
            }, [dailySalesData, monthFilterEnabled, selectedMonth]);

            // データを整形（dayフィールドを追加）
            const formattedDailySalesData = useMemo(() => {
                if (!filteredDailySalesData || filteredDailySalesData.length === 0) return [];
                return filteredDailySalesData.map(entry => ({
                    ...entry,
                    day: entry.day || (entry.date ? new Date(entry.date).getDate() + '日' : '')
                }));
            }, [filteredDailySalesData]);

            if (!hasData) {
                return (
                    <div className="flex flex-col items-center justify-center py-20">
                        <div className="bg-white rounded-xl p-12 shadow-lg border border-gold-200 text-center max-w-2xl">
                            <div className="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                <Icon name="trending-up" size={40} className="text-amber-600" />
                            </div>
                            <h2 className="text-2xl font-bold text-brown-800 mb-4 serif">売上・媒体分析データがありません</h2>
                            <p className="text-gray-600 mb-8 leading-relaxed">
                                売上データと媒体データを入力すると、詳細な分析が表示されます。<br/>
                                まずは日次売上データを入力してください。
                            </p>
                            <div className="text-left space-y-4 bg-amber-50 rounded-lg p-6">
                                <div className="flex items-start">
                                    <Icon name="info" size={20} className="text-amber-600 mr-3 flex-shrink-0 mt-0.5" />
                                    <div>
                                        <p className="font-bold text-brown-800 mb-2">データ入力方法</p>
                                        <ul className="text-sm text-gray-600 space-y-1 list-disc list-inside">
                                            <li>「実績入力」メニューから日次売上を登録</li>
                                            <li>媒体別の集客データを入力</li>
                                            <li>スプレッドシートに保存して管理</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    {/* 月選択コントロール */}
                    <div className="bg-white rounded-lg shadow-sm border border-blue-200 p-4">
                        <div className="flex items-center justify-between flex-wrap gap-4">
                            <h3 className="font-bold text-gray-600 serif text-sm">表示期間</h3>
                            <div className="flex items-center gap-4">
                                <label className="flex items-center cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={monthFilterEnabled}
                                        onChange={(e) => setMonthFilterEnabled(e.target.checked)}
                                        className="mr-2 accent-blue-500"
                                    />
                                    <span className="text-sm text-gray-700">月次フィルター</span>
                                </label>
                                {monthFilterEnabled && (
                                    <div className="flex items-center gap-2 bg-blue-50 px-3 py-2 rounded-lg border border-blue-200">
                                        <button
                                            onClick={() => changeMonth(-1)}
                                            className="p-1 hover:bg-blue-100 rounded transition-colors"
                                            title="前月"
                                        >
                                            <Icon name="chevron-left" size={18} />
                                        </button>
                                        <input
                                            type="month"
                                            value={selectedMonth}
                                            onChange={(e) => setSelectedMonth(e.target.value)}
                                            className="px-2 py-1 border border-blue-300 rounded text-sm focus:outline-none focus:border-blue-500 bg-white"
                                        />
                                        <button
                                            onClick={() => changeMonth(1)}
                                            className="p-1 hover:bg-blue-100 rounded transition-colors"
                                            title="次月"
                                        >
                                            <Icon name="chevron-right" size={18} />
                                        </button>
                                        <span className="text-xs text-gray-600 ml-2">
                                            {filteredDailySalesData.length}件
                                        </span>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Media Source Performance Table */}
                        <Card className="col-span-1">
                             <div className="flex justify-between items-center mb-6">
                                <h2 className="text-lg font-bold text-brown-800 serif">媒体別パフォーマンス分析</h2>
                                {monthFilterEnabled && (
                                    <span className="text-xs text-gray-500 bg-blue-50 px-2 py-1 rounded">
                                        {selectedMonth.split('-')[0]}年{selectedMonth.split('-')[1]}月
                                    </span>
                                )}
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse">
                                    <thead>
                                        <tr className="border-b border-gold-100 text-xs text-gray-500 uppercase">
                                            <th className="py-3 font-medium">媒体名</th>
                                            <th className="py-3 font-medium text-right">新規数</th>
                                            <th className="py-3 font-medium text-right">獲得単価(CPA)</th>
                                            <th className="py-3 font-medium text-right">広告費</th>
                                            <th className="py-3 font-medium text-right">リピート率</th>
                                            <th className="py-3 font-medium text-right">総売上貢献</th>
                                            <th className="py-3 font-medium text-center">ROAS</th>
                                        </tr>
                                    </thead>
                                    <tbody className="text-sm divide-y divide-gray-50">
                                        {mediaSourcesData && mediaSourcesData.length > 0 ? (
                                            mediaSourcesData.map((media) => {
                                                const roas = media.adCost > 0 ? ((media.sales / media.adCost) * 100).toFixed(0) : '-';
                                                return (
                                                    <tr key={media.id} className="hover:bg-gold-50/50">
                                                        <td className="py-3 font-medium text-brown-800">{media.name}</td>
                                                        <td className="py-3 text-right">{media.newVisits}</td>
                                                        <td className="py-3 text-right">¥{media.cpa.toLocaleString()}</td>
                                                        <td className="py-3 text-right">
                                                            {editingAdCostId === media.id ? (
                                                                <div className="flex items-center justify-end gap-1">
                                                                    <input
                                                                        type="text"
                                                                        inputMode="numeric"
                                                                        value={adCostInput}
                                                                        onChange={(e) => setAdCostInput(e.target.value)}
                                                                        onKeyDown={(e) => {
                                                                            if (e.key === 'Enter') saveAdCost(media);
                                                                            if (e.key === 'Escape') cancelEditAdCost();
                                                                        }}
                                                                        className="w-24 px-2 py-1 border border-blue-400 rounded text-sm text-right focus:outline-none focus:border-blue-600"
                                                                        autoFocus
                                                                    />
                                                                    <button
                                                                        onClick={() => saveAdCost(media)}
                                                                        className="text-green-600 hover:text-green-700"
                                                                    >
                                                                        <Icon name="check" size={14} />
                                                                    </button>
                                                                    <button
                                                                        onClick={cancelEditAdCost}
                                                                        className="text-red-600 hover:text-red-700"
                                                                    >
                                                                        <Icon name="x" size={14} />
                                                                    </button>
                                                                </div>
                                                            ) : (
                                                                <button
                                                                    onClick={() => startEditAdCost(media)}
                                                                    className="text-blue-600 hover:text-blue-700 hover:underline"
                                                                >
                                                                    ¥{(media.adCost || 0).toLocaleString()}
                                                                </button>
                                                            )}
                                                        </td>
                                                        <td className="py-3 text-right">
                                                            <span className={`px-2 py-1 rounded-full text-xs ${media.repeatRate >= 40 ? 'bg-emerald-100 text-emerald-700' : 'bg-gray-100 text-gray-600'}`}>
                                                                {media.repeatRate}%
                                                            </span>
                                                        </td>
                                                        <td className="py-3 text-right font-medium">¥{media.sales.toLocaleString()}</td>
                                                        <td className="py-3 text-center">
                                                            {roas !== '-' ? (
                                                                <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                                                                    Number(roas) >= 300 ? 'bg-green-100 text-green-700' :
                                                                    Number(roas) >= 150 ? 'bg-yellow-100 text-yellow-700' :
                                                                    'bg-red-100 text-red-700'
                                                                }`}>
                                                                    {roas}%
                                                                </span>
                                                            ) : (
                                                                <span className="text-gray-400 text-xs">-</span>
                                                            )}
                                                        </td>
                                                    </tr>
                                                );
                                            })
                                        ) : (
                                            <tr>
                                                <td colSpan="7" className="py-6 text-center text-gray-400 text-sm">
                                                    媒体データがありません
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                            <div className="mt-4 p-4 bg-gold-50 rounded text-xs text-brown-800 space-y-2">
                                <div>
                                    <strong>広告費の入力方法:</strong> 各媒体の広告費（青色の金額）をクリックすると編集できます。月間の広告費を入力してください。
                                </div>
                                <div>
                                    <strong>ROAS (Return On Ad Spend):</strong> 広告費1円あたりの売上を示します。300%以上=優秀、150-300%=良好、150%未満=改善必要
                                </div>
                                <div>
                                    <strong>分析:</strong> 紹介媒体は広告費ゼロで高いリピート率を実現しています。有料媒体のROASを確認し、費用対効果の高い媒体に予算を集中させることを推奨します。
                                </div>
                            </div>
                        </Card>

                        {/* Sales Trend Chart */}
                         <Card className="col-span-1">
                            <h2 className="text-lg font-bold text-brown-800 mb-6 serif">売上推移（キャッシュイン vs 役務消化）</h2>
                             <ResponsiveContainer width="100%" height={300}>
                                <AreaChart data={formattedDailySalesData}>
                                    <defs>
                                        <linearGradient id="colorCash" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor="#10b981" stopOpacity={0.1}/>
                                            <stop offset="95%" stopColor="#10b981" stopOpacity={0}/>
                                        </linearGradient>
                                        <linearGradient id="colorSales" x1="0" y1="0" x2="0" y2="1">
                                            <stop offset="5%" stopColor="#d4af37" stopOpacity={0.1}/>
                                            <stop offset="95%" stopColor="#d4af37" stopOpacity={0}/>
                                        </linearGradient>
                                    </defs>
                                    <XAxis dataKey="day" tick={{fontSize: 10}} interval={5} />
                                    <YAxis tick={{fontSize: 10}} />
                                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                    <Tooltip />
                                    <Legend verticalAlign="top" height={36}/>
                                    <Area type="monotone" dataKey="cashIn" name="キャッシュイン(現金)" stroke="#10b981" fillOpacity={1} fill="url(#colorCash)" />
                                    <Area type="monotone" dataKey="accountingSales" name="会計上売上(消化)" stroke="#d4af37" fillOpacity={1} fill="url(#colorSales)" />
                                </AreaChart>
                            </ResponsiveContainer>
                        </Card>
                    </div>
                </div>
            );
        };


        // --- Staff Management Section (Enhanced) ---

        const StaffManagementView = ({
            staffList,
            onUpdateStaff,
            onAddStaff,
            onDeleteStaff,
            exportToCSV
        }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [deletingId, setDeletingId] = useState(null);

            // Form State
            const [formData, setFormData] = useState({
                name: '',
                employmentType: '正社員', // 雇用形態
                role: 'スタッフ',
                storeId: 1,
                availableMenus: [], // 施術可能なメニュー（メニューIDの配列）
                sales: 0,
                target: 0,
                nomination: 0,
                retention: 0,
                reviewScore: 0
            });

            const handleEditClick = (staff) => {
                setIsEditing(true);
                setEditingId(staff.id);
                setFormData({
                    name: staff.name || '',
                    employmentType: staff.employmentType || '正社員',
                    role: staff.role || 'スタッフ',
                    storeId: staff.storeId || 1,
                    availableMenus: Array.isArray(staff.availableMenus) ? staff.availableMenus : [],
                    sales: staff.sales || 0,
                    target: staff.target || 0,
                    nomination: staff.nomination || 0,
                    retention: staff.retention || 0,
                    reviewScore: staff.reviewScore || 0
                });
            };

            const handleAddClick = () => {
                setIsEditing(true);
                setEditingId(null); // New
                setFormData({
                    name: '',
                    employmentType: '正社員',
                    role: 'スタッフ',
                    storeId: 1,
                    availableMenus: [],
                    sales: 0,
                    target: 0,
                    nomination: 0,
                    retention: 0,
                    reviewScore: 0
                });
            };

            const handleDeleteClick = (staffId) => {
                setDeletingId(staffId);
                setShowDeleteConfirm(true);
            };

            const confirmDelete = () => {
                onDeleteStaff(deletingId);
                setShowDeleteConfirm(false);
                setDeletingId(null);
            };

            const handleSave = () => {
                if (editingId) {
                    onUpdateStaff(editingId, formData);
                } else {
                    onAddStaff({ ...formData, id: Date.now() });
                }
                setIsEditing(false);
                setEditingId(null);
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                const isTextField = ['name', 'role', 'employmentType'].includes(name);
                const isSelectNumber = name === 'storeId';

                setFormData(prev => ({
                    ...prev,
                    [name]: isTextField ? value :
                            isSelectNumber ? Number(value) :
                            (() => {
                                const processedValue = normalizeNumberInput(value);
                                return processedValue === '' ? 0 : Number(processedValue);
                            })()
                }));
            };

            return (
                <div className="space-y-6">
                    {/* Header Action */}
                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="text-xl font-bold text-brown-800 serif">スタッフ管理・分析</h2>
                            <p className="text-sm text-gray-500">個人のパフォーマンス管理と評価データの編集</p>
                        </div>
                        <div className="flex items-center space-x-2">
                            <button
                                onClick={() => exportToCSV(staffList, 'スタッフ実績.csv')}
                                className="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-sm flex items-center text-sm font-medium transition-colors"
                            >
                                <Icon name="download" size={16} className="mr-2" />
                                CSV出力
                            </button>
                            <button
                                onClick={handleAddClick}
                                className="bg-gold-500 hover:bg-gold-600 text-white px-4 py-2 rounded-lg shadow-sm flex items-center text-sm font-medium transition-colors"
                            >
                                <Icon name="plus" size={16} className="mr-2" />
                                スタッフ新規登録
                            </button>
                        </div>
                    </div>

                    {/* Staff List Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        {!Array.isArray(staffList) || staffList.length === 0 ? (
                            <div className="col-span-full text-center py-12 text-gray-400">
                                <Icon name="users" size={48} className="mx-auto mb-4 opacity-30" />
                                <p className="text-sm">スタッフが登録されていません</p>
                                <p className="text-xs mt-2">「スタッフ新規登録」ボタンから追加してください</p>
                            </div>
                        ) : (
                            staffList.map(staff => (
                                <div key={staff.id} className="bg-white border border-gold-100 rounded-xl p-5 hover:shadow-md transition-shadow group relative">
                                    <div className="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button
                                            onClick={() => handleEditClick(staff)}
                                            className="text-gray-300 hover:text-gold-500 p-1"
                                        >
                                            <Icon name="edit-2" size={16} />
                                        </button>
                                        <button
                                            onClick={() => handleDeleteClick(staff.id)}
                                            className="text-gray-300 hover:text-rose-500 p-1"
                                        >
                                            <Icon name="trash-2" size={16} />
                                        </button>
                                    </div>

                                    <div className="flex items-center mb-4">
                                        <div className="w-12 h-12 rounded-full bg-gold-50 border border-gold-200 flex items-center justify-center text-gold-700 font-bold text-lg">
                                            {staff.name ? staff.name.charAt(0) : '?'}
                                        </div>
                                        <div className="ml-3">
                                            <h3 className="font-bold text-brown-800">{staff.name}</h3>
                                            <p className="text-xs text-gray-500 bg-gray-100 inline-block px-2 py-0.5 rounded mt-1">
                                                {staff.role} - {stores.find(s => s.id === staff.storeId)?.name || '店舗不明'}
                                            </p>
                                        </div>
                                    </div>
                                <div className="space-y-3">
                                    <div className="flex justify-between text-sm items-end">
                                        <span className="text-gray-500 text-xs">売上実績</span>
                                        <span className="font-bold text-brown-800">¥{staff.sales.toLocaleString()}</span>
                                    </div>
                                    <div className="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden">
                                        <div
                                            className={`h-full ${staff.sales >= staff.target ? 'bg-emerald-500' : 'bg-gold-500'}`}
                                            style={{width: `${staff.target > 0 ? Math.min(100, (staff.sales/staff.target)*100) : 0}%`}}
                                        ></div>
                                    </div>
                                    <div className="flex justify-between text-xs text-gray-400">
                                        <span>目標: ¥{staff.target.toLocaleString()}</span>
                                        <span>{staff.target > 0 ? Math.round((staff.sales/staff.target)*100) : 0}%</span>
                                    </div>
                                    
                                    <div className="grid grid-cols-3 gap-2 pt-2 border-t border-gray-50 mt-2">
                                        <div className="text-center">
                                            <div className="text-xs text-gray-400">指名</div>
                                            <div className="font-bold text-brown-800">{staff.nomination}</div>
                                        </div>
                                        <div className="text-center border-l border-gray-100">
                                            <div className="text-xs text-gray-400">リピート</div>
                                            <div className="font-bold text-brown-800">{staff.retention}%</div>
                                        </div>
                                        <div className="text-center border-l border-gray-100">
                                            <div className="text-xs text-gray-400">口コミ評価</div>
                                            <div className="font-bold text-gold-600 flex justify-center items-center">
                                                {staff.reviewScore || 0}<Icon name="star" size={10} className="ml-0.5 fill-current" />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="mt-4 pt-4 border-t border-gray-100">
                                        <button
                                            onClick={() => {
                                                const staffUrl = `${window.location.origin}${window.location.pathname}?staffId=${staff.id}`;
                                                navigator.clipboard.writeText(staffUrl);
                                                alert(`スタッフURL をコピーしました！\n\n${staffUrl}\n\nこのURLを ${staff.name} さんに共有してください。`);
                                            }}
                                            className="w-full text-xs bg-blue-50 hover:bg-blue-100 text-blue-700 py-2 rounded flex items-center justify-center transition-colors"
                                        >
                                            <Icon name="link" size={12} className="mr-1" />
                                            スタッフURLをコピー
                                        </button>
                                    </div>
                                </div>
                            </div>
                            ))
                        )}
                    </div>

                    {/* Edit Modal */}
                    {isEditing && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md border border-gold-200">
                                <h3 className="text-lg font-bold text-brown-800 mb-4 serif">
                                    {editingId ? 'スタッフ情報編集' : '新規スタッフ登録'}
                                </h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">氏名</label>
                                        <input name="name" value={formData.name} onChange={handleChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" placeholder="氏名" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">雇用形態</label>
                                            <select name="employmentType" value={formData.employmentType} onChange={handleChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none">
                                                <option value="正社員">正社員</option>
                                                <option value="契約社員">契約社員</option>
                                                <option value="アルバイト">アルバイト</option>
                                                <option value="業務委託">業務委託</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">役職</label>
                                            <select name="role" value={formData.role} onChange={handleChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none">
                                                <option value="店長">店長</option>
                                                <option value="シニア">シニア</option>
                                                <option value="スタッフ">スタッフ</option>
                                                <option value="新人">新人</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">所属店舗</label>
                                        <select name="storeId" value={formData.storeId} onChange={handleChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none">
                                            {stores.map(store => (
                                                <option key={store.id} value={store.id}>{store.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-2">施術可能なメニュー</label>
                                        <div className="space-y-2 max-h-40 overflow-y-auto border border-gray-300 rounded p-3 bg-gray-50">
                                            {menus.filter(m => m.availableStores.includes(formData.storeId)).map(menu => (
                                                <label key={menu.id} className="flex items-center cursor-pointer hover:bg-white px-2 py-1 rounded transition-colors">
                                                    <input
                                                        type="checkbox"
                                                        checked={Array.isArray(formData.availableMenus) && formData.availableMenus.includes(menu.id)}
                                                        onChange={(e) => {
                                                            const currentMenus = Array.isArray(formData.availableMenus) ? formData.availableMenus : [];
                                                            const newMenus = e.target.checked
                                                                ? [...currentMenus, menu.id]
                                                                : currentMenus.filter(id => id !== menu.id);
                                                            setFormData(prev => ({ ...prev, availableMenus: newMenus }));
                                                        }}
                                                        className="mr-2 accent-gold-500"
                                                    />
                                                    <span className="text-sm text-gray-700">{menu.name}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <div className="flex justify-end space-x-3 mt-6">
                                    <button onClick={() => setIsEditing(false)} className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded">キャンセル</button>
                                    <button onClick={handleSave} className="px-4 py-2 text-sm bg-gold-500 hover:bg-gold-600 text-white rounded font-medium shadow-sm">保存する</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Delete Confirmation Modal */}
                    {showDeleteConfirm && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm border border-rose-200">
                                <div className="flex items-center mb-4">
                                    <Icon name="alert-triangle" size={24} className="text-rose-500 mr-3" />
                                    <h3 className="text-lg font-bold text-brown-800">削除の確認</h3>
                                </div>
                                <p className="text-sm text-gray-600 mb-6">
                                    このスタッフを削除してもよろしいですか？この操作は取り消せません。
                                </p>
                                <div className="flex justify-end space-x-3">
                                    <button onClick={() => setShowDeleteConfirm(false)} className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded">キャンセル</button>
                                    <button onClick={confirmDelete} className="px-4 py-2 text-sm bg-rose-500 hover:bg-rose-600 text-white rounded font-medium shadow-sm">削除する</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Customer & Ticket Management View ---
        const CustomerTicketManagementView = ({
            ticketMasterList,
            customerList,
            onUpdateTicketMaster,
            onAddTicketMaster,
            onDeleteTicketMaster,
            onUpdateCustomer,
            onAddCustomer,
            onDeleteCustomer,
            exportToCSV
        }) => {
            const [activeView, setActiveView] = useState('master'); // 'master' or 'customers'
            const [isEditing, setIsEditing] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [deletingId, setDeletingId] = useState(null);
            const [editingType, setEditingType] = useState('master'); // 'master' or 'customer'

            // Form State
            const [ticketFormData, setTicketFormData] = useState({
                name: '', sessions: 0, price: 0, validMonths: 0, description: ''
            });

            const [customerFormData, setCustomerFormData] = useState({
                name: '', phone: '', email: '', purchaseDate: '', ticketMasterId: '', remainingSessions: 0, expiryDate: '', storeId: 1
            });

            // Ticket Master Handlers
            const handleEditTicketMaster = (ticket) => {
                setIsEditing(true);
                setEditingId(ticket.id);
                setEditingType('master');
                setTicketFormData({ ...ticket });
            };

            const handleAddTicketMaster = () => {
                setIsEditing(true);
                setEditingId(null);
                setEditingType('master');
                setTicketFormData({
                    name: '', sessions: 5, price: 0, validMonths: 6, description: ''
                });
            };

            const handleDeleteTicketMaster = (id) => {
                setDeletingId(id);
                setEditingType('master');
                setShowDeleteConfirm(true);
            };

            // Customer Handlers
            const handleEditCustomer = (customer) => {
                setIsEditing(true);
                setEditingId(customer.id);
                setEditingType('customer');
                setCustomerFormData({ ...customer });
            };

            const handleAddCustomer = () => {
                setIsEditing(true);
                setEditingId(null);
                setEditingType('customer');
                const today = new Date().toISOString().split('T')[0];
                setCustomerFormData({
                    name: '', phone: '', email: '', purchaseDate: today, ticketMasterId: ticketMasterList[0]?.id || '', remainingSessions: 0, expiryDate: '', storeId: 1
                });
            };

            const handleDeleteCustomer = (id) => {
                setDeletingId(id);
                setEditingType('customer');
                setShowDeleteConfirm(true);
            };

            const confirmDelete = () => {
                if (editingType === 'master') {
                    onDeleteTicketMaster(deletingId);
                } else {
                    onDeleteCustomer(deletingId);
                }
                setShowDeleteConfirm(false);
                setDeletingId(null);
            };

            const handleSave = () => {
                if (editingType === 'master') {
                    if (editingId) {
                        onUpdateTicketMaster(editingId, ticketFormData);
                    } else {
                        onAddTicketMaster({ ...ticketFormData, id: Date.now() });
                    }
                } else {
                    // 選択された回数券マスターから残りセッション数を設定
                    const selectedMaster = ticketMasterList.find(t => t.id === Number(customerFormData.ticketMasterId));
                    if (selectedMaster && !editingId) {
                        customerFormData.remainingSessions = selectedMaster.sessions;
                        // 有効期限を計算
                        const purchaseDate = new Date(customerFormData.purchaseDate);
                        purchaseDate.setMonth(purchaseDate.getMonth() + selectedMaster.validMonths);
                        customerFormData.expiryDate = purchaseDate.toISOString().split('T')[0];
                    }

                    if (editingId) {
                        onUpdateCustomer(editingId, customerFormData);
                    } else {
                        onAddCustomer({ ...customerFormData, id: Date.now() });
                    }
                }
                setIsEditing(false);
                setEditingId(null);
            };

            const handleTicketFormChange = (e) => {
                const { name, value } = e.target;
                const isTextField = ['name', 'description'].includes(name);
                const processedValue = isTextField ? value : normalizeNumberInput(value);
                setTicketFormData(prev => ({
                    ...prev,
                    [name]: isTextField ? processedValue : (processedValue === '' ? 0 : Number(processedValue))
                }));
            };

            const handleCustomerFormChange = (e) => {
                const { name, value } = e.target;
                const isTextField = ['name', 'phone', 'email', 'purchaseDate', 'expiryDate'].includes(name);
                const isSelectNumber = ['ticketMasterId', 'storeId'].includes(name);

                setCustomerFormData(prev => ({
                    ...prev,
                    [name]: isTextField ? value :
                            isSelectNumber ? Number(value) :
                            (() => {
                                const processedValue = normalizeNumberInput(value);
                                return processedValue === '' ? 0 : Number(processedValue);
                            })()
                }));
            };

            return (
                <div className="space-y-6">
                    {/* Tab Navigation */}
                    <div className="flex justify-between items-center">
                        <div className="flex gap-2 bg-white rounded-lg p-1 border border-gold-200">
                            <button
                                onClick={() => setActiveView('master')}
                                className={`px-6 py-2 rounded text-sm font-medium transition-colors ${
                                    activeView === 'master' ? 'bg-gold-500 text-white' : 'text-gray-600 hover:bg-gold-50'
                                }`}
                            >
                                回数券マスター管理
                            </button>
                            <button
                                onClick={() => setActiveView('customers')}
                                className={`px-6 py-2 rounded text-sm font-medium transition-colors ${
                                    activeView === 'customers' ? 'bg-gold-500 text-white' : 'text-gray-600 hover:bg-gold-50'
                                }`}
                            >
                                顧客・購入者管理
                            </button>
                        </div>
                        <div className="flex items-center space-x-2">
                            <button
                                onClick={() => exportToCSV(activeView === 'master' ? ticketMasterList : customerList, activeView === 'master' ? '回数券マスター.csv' : '顧客リスト.csv')}
                                className="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-sm flex items-center text-sm font-medium transition-colors"
                            >
                                <Icon name="download" size={16} className="mr-2" />
                                CSV出力
                            </button>
                            <button
                                onClick={activeView === 'master' ? handleAddTicketMaster : handleAddCustomer}
                                className="bg-gold-500 hover:bg-gold-600 text-white px-4 py-2 rounded-lg shadow-sm flex items-center text-sm font-medium transition-colors"
                            >
                                <Icon name="plus" size={16} className="mr-2" />
                                {activeView === 'master' ? '回数券マスター追加' : '顧客追加'}
                            </button>
                        </div>
                    </div>

                    {/* Master Ticket List */}
                    {activeView === 'master' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {ticketMasterList.length === 0 ? (
                                <div className="col-span-full text-center py-12 text-gray-400">
                                    <Icon name="ticket" size={48} className="mx-auto mb-4 opacity-30" />
                                    <p className="text-sm">回数券マスターが登録されていません</p>
                                    <p className="text-xs mt-2">「回数券マスター追加」ボタンから追加してください</p>
                                </div>
                            ) : (
                                ticketMasterList.map(ticket => (
                                    <div key={ticket.id} className="bg-white border border-gold-100 rounded-xl p-5 hover:shadow-md transition-shadow group relative">
                                        <div className="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button
                                                onClick={() => handleEditTicketMaster(ticket)}
                                                className="text-gray-300 hover:text-gold-500 p-1"
                                            >
                                                <Icon name="edit-2" size={16} />
                                            </button>
                                            <button
                                                onClick={() => handleDeleteTicketMaster(ticket.id)}
                                                className="text-gray-300 hover:text-rose-500 p-1"
                                            >
                                                <Icon name="trash-2" size={16} />
                                            </button>
                                        </div>

                                        <div className="mb-4">
                                            <h3 className="font-bold text-brown-800 text-lg mb-1">{ticket.name}</h3>
                                            <p className="text-xs text-gray-500">{ticket.description}</p>
                                        </div>

                                        <div className="space-y-2 border-t border-gray-100 pt-3">
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-500">回数</span>
                                                <span className="font-bold text-brown-800">{ticket.sessions}回</span>
                                            </div>
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-500">価格</span>
                                                <span className="font-bold text-gold-600">¥{ticket.price.toLocaleString()}</span>
                                            </div>
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-500">有効期限</span>
                                                <span className="font-bold text-brown-800">{ticket.validMonths}ヶ月</span>
                                            </div>
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-500">1回単価</span>
                                                <span className="text-emerald-600">¥{Math.round(ticket.price / ticket.sessions).toLocaleString()}</span>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    )}

                    {/* Customer List */}
                    {activeView === 'customers' && (
                        <div className="bg-white rounded-xl border border-gold-100 overflow-hidden">
                            {!Array.isArray(customerList) || customerList.length === 0 ? (
                                <div className="text-center py-12 text-gray-400">
                                    <Icon name="users" size={48} className="mx-auto mb-4 opacity-30" />
                                    <p className="text-sm">顧客が登録されていません</p>
                                    <p className="text-xs mt-2">「顧客追加」ボタンから追加してください</p>
                                </div>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="w-full">
                                        <thead className="bg-gold-50 border-b border-gold-100">
                                            <tr className="text-left text-xs text-gray-500 uppercase">
                                                <th className="py-3 px-4 font-medium">氏名</th>
                                                <th className="py-3 px-4 font-medium">連絡先</th>
                                                <th className="py-3 px-4 font-medium">回数券</th>
                                                <th className="py-3 px-4 font-medium">残回数</th>
                                                <th className="py-3 px-4 font-medium">有効期限</th>
                                                <th className="py-3 px-4 font-medium">店舗</th>
                                                <th className="py-3 px-4 font-medium text-center">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {customerList.map(customer => {
                                                const ticket = ticketMasterList.find(t => t.id === customer.ticketMasterId);
                                                const store = stores.find(s => s.id === customer.storeId);
                                                const isExpired = customer.expiryDate ? new Date(customer.expiryDate) < new Date() : false;

                                                return (
                                                    <tr key={customer.id} className="hover:bg-gold-50/30 text-sm">
                                                        <td className="py-3 px-4 font-medium text-brown-800">{customer.name}</td>
                                                        <td className="py-3 px-4 text-gray-600">
                                                            <div>{customer.phone}</div>
                                                            <div className="text-xs text-gray-400">{customer.email}</div>
                                                        </td>
                                                        <td className="py-3 px-4 text-gray-600">{ticket?.name || '不明'}</td>
                                                        <td className="py-3 px-4">
                                                            <span className={`font-bold ${customer.remainingSessions > 0 ? 'text-emerald-600' : 'text-gray-400'}`}>
                                                                {customer.remainingSessions}回
                                                            </span>
                                                        </td>
                                                        <td className="py-3 px-4">
                                                            <span className={`text-xs px-2 py-1 rounded ${isExpired ? 'bg-rose-100 text-rose-700' : 'bg-emerald-100 text-emerald-700'}`}>
                                                                {customer.expiryDate}
                                                            </span>
                                                        </td>
                                                        <td className="py-3 px-4 text-gray-600">{store?.name || '不明'}</td>
                                                        <td className="py-3 px-4">
                                                            <div className="flex justify-center gap-2">
                                                                <button
                                                                    onClick={() => handleEditCustomer(customer)}
                                                                    className="text-gray-400 hover:text-gold-500 p-1"
                                                                >
                                                                    <Icon name="edit-2" size={16} />
                                                                </button>
                                                                <button
                                                                    onClick={() => handleDeleteCustomer(customer.id)}
                                                                    className="text-gray-400 hover:text-rose-500 p-1"
                                                                >
                                                                    <Icon name="trash-2" size={16} />
                                                                </button>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Edit Modal - Ticket Master */}
                    {isEditing && editingType === 'master' && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md border border-gold-200">
                                <h3 className="text-lg font-bold text-brown-800 mb-4 serif">
                                    {editingId ? '回数券マスター編集' : '回数券マスター新規登録'}
                                </h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">回数券名</label>
                                        <input name="name" value={ticketFormData.name} onChange={handleTicketFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" placeholder="例: 5回券" />
                                    </div>
                                    <div className="grid grid-cols-3 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">回数</label>
                                            <input type="text" inputMode="numeric" name="sessions" value={ticketFormData.sessions} onChange={handleTicketFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">価格(円)</label>
                                            <input type="text" inputMode="numeric" name="price" value={ticketFormData.price} onChange={handleTicketFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">有効(月)</label>
                                            <input type="text" inputMode="numeric" name="validMonths" value={ticketFormData.validMonths} onChange={handleTicketFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">説明</label>
                                        <textarea name="description" value={ticketFormData.description} onChange={handleTicketFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" rows="2" placeholder="回数券の説明"></textarea>
                                    </div>
                                </div>
                                <div className="flex justify-end space-x-3 mt-6">
                                    <button onClick={() => setIsEditing(false)} className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded">キャンセル</button>
                                    <button onClick={handleSave} className="px-4 py-2 text-sm bg-gold-500 hover:bg-gold-600 text-white rounded font-medium shadow-sm">保存する</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Edit Modal - Customer */}
                    {isEditing && editingType === 'customer' && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md border border-gold-200">
                                <h3 className="text-lg font-bold text-brown-800 mb-4 serif">
                                    {editingId ? '顧客情報編集' : '顧客新規登録'}
                                </h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">氏名</label>
                                        <input name="name" value={customerFormData.name} onChange={handleCustomerFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" placeholder="氏名" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">電話番号</label>
                                            <input name="phone" value={customerFormData.phone} onChange={handleCustomerFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" placeholder="090-1234-5678" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">店舗</label>
                                            <select name="storeId" value={customerFormData.storeId} onChange={handleCustomerFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none">
                                                {stores.map(store => (
                                                    <option key={store.id} value={store.id}>{store.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">メールアドレス</label>
                                        <input name="email" type="email" value={customerFormData.email} onChange={handleCustomerFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" placeholder="example@email.com" />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">購入回数券</label>
                                        <select name="ticketMasterId" value={customerFormData.ticketMasterId} onChange={handleCustomerFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none">
                                            {ticketMasterList.map(ticket => (
                                                <option key={ticket.id} value={ticket.id}>{ticket.name} ({ticket.sessions}回 / ¥{ticket.price.toLocaleString()})</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">購入日</label>
                                            <input name="purchaseDate" type="date" value={customerFormData.purchaseDate} onChange={handleCustomerFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">残回数</label>
                                            <input name="remainingSessions" type="text" inputMode="numeric" value={customerFormData.remainingSessions} onChange={handleCustomerFormChange} className="w-full border border-gray-300 rounded p-2 text-sm focus:border-gold-500 outline-none" />
                                        </div>
                                    </div>
                                </div>
                                <div className="flex justify-end space-x-3 mt-6">
                                    <button onClick={() => setIsEditing(false)} className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded">キャンセル</button>
                                    <button onClick={handleSave} className="px-4 py-2 text-sm bg-gold-500 hover:bg-gold-600 text-white rounded font-medium shadow-sm">保存する</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Delete Confirmation Modal */}
                    {showDeleteConfirm && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm border border-rose-200">
                                <div className="flex items-center mb-4">
                                    <Icon name="alert-triangle" size={24} className="text-rose-500 mr-3" />
                                    <h3 className="text-lg font-bold text-brown-800">削除の確認</h3>
                                </div>
                                <p className="text-sm text-gray-600 mb-6">
                                    この{editingType === 'master' ? '回数券マスター' : '顧客'}を削除してもよろしいですか？この操作は取り消せません。
                                </p>
                                <div className="flex justify-end space-x-3">
                                    <button onClick={() => setShowDeleteConfirm(false)} className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded">キャンセル</button>
                                    <button onClick={confirmDelete} className="px-4 py-2 text-sm bg-rose-500 hover:bg-rose-600 text-white rounded font-medium shadow-sm">削除する</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- LINE Integration View ---
        const LineIntegrationView = ({ customerList }) => {
            const [activeLineTab, setActiveLineTab] = useState('individual'); // 'individual', 'broadcast', 'received', 'reminder'
            const [lineConfig, setLineConfig] = useState(() => {
                const saved = localStorage.getItem('lineConfig');
                return saved ? JSON.parse(saved) : {
                    channelAccessToken: '',
                    channelSecret: '',
                    isConnected: false
                };
            });
            const [selectedCustomer, setSelectedCustomer] = useState(null);
            const [messageContent, setMessageContent] = useState('');
            const [broadcastMessage, setBroadcastMessage] = useState('');
            const [receivedMessages, setReceivedMessages] = useState([]);
            const [reminderSettings, setReminderSettings] = useState(() => {
                const saved = localStorage.getItem('reminderSettings');
                return saved ? JSON.parse(saved) : {
                    enabled: false,
                    daysBefore: 1,
                    message: 'ご予約の確認をお願いいたします。明日のご来店をお待ちしております。'
                };
            });
            const [sendStatus, setSendStatus] = useState('');
            const [isSending, setIsSending] = useState(false);

            // LINE設定を保存
            const saveLineConfig = () => {
                localStorage.setItem('lineConfig', JSON.stringify(lineConfig));
                setSendStatus('✓ LINE設定を保存しました');
                setTimeout(() => setSendStatus(''), 3000);
            };

            // リマインド設定を保存
            const saveReminderSettings = () => {
                localStorage.setItem('reminderSettings', JSON.stringify(reminderSettings));
                setSendStatus('✓ リマインド設定を保存しました');
                setTimeout(() => setSendStatus(''), 3000);
            };

            // 個別メッセージ送信（シミュレーション）
            const sendIndividualMessage = async () => {
                if (!selectedCustomer || !messageContent.trim()) {
                    setSendStatus('✗ 顧客とメッセージを入力してください');
                    return;
                }
                setIsSending(true);
                // 実際のLINE API連携はバックエンドで行う
                await new Promise(resolve => setTimeout(resolve, 1000));
                setSendStatus(`✓ ${selectedCustomer.name}様にメッセージを送信しました`);
                setMessageContent('');
                setIsSending(false);
                setTimeout(() => setSendStatus(''), 3000);
            };

            // 一斉配信（シミュレーション）
            const sendBroadcastMessage = async () => {
                if (!broadcastMessage.trim()) {
                    setSendStatus('✗ メッセージを入力してください');
                    return;
                }
                setIsSending(true);
                await new Promise(resolve => setTimeout(resolve, 1500));
                setSendStatus(`✓ ${customerList.length}名の顧客に一斉配信しました`);
                setBroadcastMessage('');
                setIsSending(false);
                setTimeout(() => setSendStatus(''), 3000);
            };

            const LineTabButton = ({ id, icon, label }) => (
                <button
                    onClick={() => setActiveLineTab(id)}
                    className={`flex items-center space-x-2 px-4 py-3 rounded-lg transition-all ${
                        activeLineTab === id
                            ? 'bg-green-600 text-white shadow-md'
                            : 'bg-white text-gray-600 hover:bg-green-50 border border-gray-200'
                    }`}
                >
                    <Icon name={icon} size={18} />
                    <span className="font-medium">{label}</span>
                </button>
            );

            return (
                <div className="space-y-6">
                    {/* LINE設定セクション */}
                    <Card>
                        <div className="flex items-center justify-between mb-6">
                            <div className="flex items-center space-x-3">
                                <div className="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center">
                                    <Icon name="message-circle" size={24} className="text-white" />
                                </div>
                                <div>
                                    <h2 className="text-xl font-bold text-brown-800 serif">LINE公式アカウント連携</h2>
                                    <p className="text-sm text-gray-500">顧客とのコミュニケーションを管理</p>
                                </div>
                            </div>
                            <div className={`flex items-center space-x-2 px-3 py-1.5 rounded-full ${lineConfig.channelAccessToken ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`}>
                                <div className={`w-2 h-2 rounded-full ${lineConfig.channelAccessToken ? 'bg-green-500' : 'bg-gray-400'}`}></div>
                                <span className="text-sm font-medium">{lineConfig.channelAccessToken ? '設定済み' : '未設定'}</span>
                            </div>
                        </div>

                        {/* API設定 */}
                        <div className="bg-gray-50 rounded-lg p-4 mb-6">
                            <h3 className="text-sm font-bold text-gray-700 mb-3 flex items-center">
                                <Icon name="settings" size={16} className="mr-2" />
                                LINE Messaging API 設定
                            </h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs text-gray-500 mb-1">チャネルアクセストークン</label>
                                    <input
                                        type="password"
                                        value={lineConfig.channelAccessToken}
                                        onChange={(e) => setLineConfig({...lineConfig, channelAccessToken: e.target.value})}
                                        placeholder="チャネルアクセストークンを入力"
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs text-gray-500 mb-1">チャネルシークレット</label>
                                    <input
                                        type="password"
                                        value={lineConfig.channelSecret}
                                        onChange={(e) => setLineConfig({...lineConfig, channelSecret: e.target.value})}
                                        placeholder="チャネルシークレットを入力"
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                    />
                                </div>
                            </div>
                            <button
                                onClick={saveLineConfig}
                                className="mt-3 px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors"
                            >
                                設定を保存
                            </button>
                        </div>

                        {/* タブナビゲーション */}
                        <div className="flex flex-wrap gap-2 mb-6">
                            <LineTabButton id="individual" icon="user" label="個別メッセージ" />
                            <LineTabButton id="broadcast" icon="megaphone" label="一斉配信" />
                            <LineTabButton id="received" icon="inbox" label="受信メッセージ" />
                            <LineTabButton id="reminder" icon="bell" label="自動リマインド" />
                        </div>

                        {/* ステータスメッセージ */}
                        {sendStatus && (
                            <div className={`mb-4 p-3 rounded-lg text-sm font-medium ${sendStatus.includes('✓') ? 'bg-green-50 text-green-700' : 'bg-rose-50 text-rose-700'}`}>
                                {sendStatus}
                            </div>
                        )}
                    </Card>

                    {/* 個別メッセージ送信 */}
                    {activeLineTab === 'individual' && (
                        <Card>
                            <h3 className="text-lg font-bold text-brown-800 mb-4 flex items-center">
                                <Icon name="user" size={20} className="mr-2 text-green-600" />
                                個別メッセージ送信
                            </h3>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm text-gray-600 mb-2">送信先顧客を選択</label>
                                    <select
                                        value={selectedCustomer?.id || ''}
                                        onChange={(e) => {
                                            const customer = customerList.find(c => c.id === Number(e.target.value));
                                            setSelectedCustomer(customer || null);
                                        }}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                    >
                                        <option value="">顧客を選択してください</option>
                                        {customerList.map(customer => (
                                            <option key={customer.id} value={customer.id}>
                                                {customer.name} ({customer.phone || 'LINE未登録'})
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm text-gray-600 mb-2">メッセージ内容</label>
                                    <textarea
                                        value={messageContent}
                                        onChange={(e) => setMessageContent(e.target.value)}
                                        placeholder="送信するメッセージを入力してください..."
                                        rows={4}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none"
                                    />
                                    <p className="text-xs text-gray-400 mt-1">{messageContent.length} / 2000文字</p>
                                </div>
                                <div className="flex space-x-2">
                                    <button
                                        onClick={sendIndividualMessage}
                                        disabled={isSending || !selectedCustomer || !messageContent.trim()}
                                        className="flex-1 flex items-center justify-center space-x-2 px-4 py-3 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-medium rounded-lg transition-colors"
                                    >
                                        <Icon name={isSending ? "loader" : "send"} size={18} className={isSending ? 'animate-spin' : ''} />
                                        <span>{isSending ? '送信中...' : 'メッセージを送信'}</span>
                                    </button>
                                </div>
                            </div>
                            {/* テンプレート */}
                            <div className="mt-6 pt-4 border-t border-gray-200">
                                <h4 className="text-sm font-bold text-gray-700 mb-3">クイックテンプレート</h4>
                                <div className="flex flex-wrap gap-2">
                                    {['ご来店ありがとうございました', 'ご予約の確認', 'キャンペーンのご案内', '次回ご予約のお願い'].map((template, i) => (
                                        <button
                                            key={i}
                                            onClick={() => setMessageContent(template === 'ご来店ありがとうございました'
                                                ? 'いつもご利用いただき、誠にありがとうございます。\n\n本日はご来店いただきありがとうございました。\nまたのご来店を心よりお待ちしております。'
                                                : template === 'ご予約の確認'
                                                ? '○○様\n\nご予約の確認をさせていただきます。\n\n【ご予約内容】\n日時：\nメニュー：\n\nご不明な点がございましたら、お気軽にお問い合わせください。'
                                                : template === 'キャンペーンのご案内'
                                                ? '【期間限定キャンペーン】\n\nいつもご愛顧いただきありがとうございます。\n\n只今、特別キャンペーンを実施中です！\n\n詳しくはスタッフまでお問い合わせください。'
                                                : '○○様\n\nいつもご利用いただきありがとうございます。\n\n次回のご予約はいかがでしょうか？\nご希望の日時がございましたら、お気軽にご連絡ください。'
                                            )}
                                            className="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 text-sm rounded-full transition-colors"
                                        >
                                            {template}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </Card>
                    )}

                    {/* 一斉配信 */}
                    {activeLineTab === 'broadcast' && (
                        <Card>
                            <h3 className="text-lg font-bold text-brown-800 mb-4 flex items-center">
                                <Icon name="megaphone" size={20} className="mr-2 text-green-600" />
                                一斉配信
                            </h3>
                            <div className="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-4">
                                <p className="text-sm text-amber-800">
                                    <Icon name="alert-circle" size={16} className="inline mr-1" />
                                    登録されている全顧客（{customerList.length}名）にメッセージが送信されます
                                </p>
                            </div>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm text-gray-600 mb-2">配信メッセージ</label>
                                    <textarea
                                        value={broadcastMessage}
                                        onChange={(e) => setBroadcastMessage(e.target.value)}
                                        placeholder="一斉配信するメッセージを入力してください..."
                                        rows={6}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none"
                                    />
                                    <p className="text-xs text-gray-400 mt-1">{broadcastMessage.length} / 2000文字</p>
                                </div>
                                <button
                                    onClick={sendBroadcastMessage}
                                    disabled={isSending || !broadcastMessage.trim()}
                                    className="w-full flex items-center justify-center space-x-2 px-4 py-3 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-medium rounded-lg transition-colors"
                                >
                                    <Icon name={isSending ? "loader" : "send"} size={18} className={isSending ? 'animate-spin' : ''} />
                                    <span>{isSending ? '配信中...' : '一斉配信を実行'}</span>
                                </button>
                            </div>
                            {/* 配信履歴（サンプル） */}
                            <div className="mt-6 pt-4 border-t border-gray-200">
                                <h4 className="text-sm font-bold text-gray-700 mb-3">最近の配信履歴</h4>
                                <div className="space-y-2 text-sm text-gray-500">
                                    <p className="text-center py-4">配信履歴はまだありません</p>
                                </div>
                            </div>
                        </Card>
                    )}

                    {/* 受信メッセージ確認 */}
                    {activeLineTab === 'received' && (
                        <Card>
                            <h3 className="text-lg font-bold text-brown-800 mb-4 flex items-center">
                                <Icon name="inbox" size={20} className="mr-2 text-green-600" />
                                受信メッセージ
                            </h3>
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                <p className="text-sm text-blue-800">
                                    <Icon name="info" size={16} className="inline mr-1" />
                                    LINE Messaging APIのWebhookを設定すると、顧客からのメッセージをリアルタイムで受信できます。
                                </p>
                            </div>
                            <div className="border border-gray-200 rounded-lg overflow-hidden">
                                <div className="bg-gray-50 px-4 py-3 border-b border-gray-200">
                                    <div className="flex items-center justify-between">
                                        <span className="text-sm font-medium text-gray-700">受信トレイ</span>
                                        <button className="text-sm text-green-600 hover:text-green-700 font-medium">
                                            更新
                                        </button>
                                    </div>
                                </div>
                                <div className="divide-y divide-gray-100">
                                    {receivedMessages.length === 0 ? (
                                        <div className="p-8 text-center text-gray-500">
                                            <Icon name="mail" size={48} className="mx-auto mb-3 text-gray-300" />
                                            <p className="text-sm">受信メッセージはありません</p>
                                            <p className="text-xs text-gray-400 mt-1">Webhook設定後、メッセージが表示されます</p>
                                        </div>
                                    ) : (
                                        receivedMessages.map((msg, i) => (
                                            <div key={i} className="p-4 hover:bg-gray-50 cursor-pointer">
                                                <div className="flex items-start space-x-3">
                                                    <div className="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                                        <Icon name="user" size={20} className="text-green-600" />
                                                    </div>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="flex items-center justify-between">
                                                            <p className="text-sm font-medium text-gray-900">{msg.sender}</p>
                                                            <p className="text-xs text-gray-400">{msg.time}</p>
                                                        </div>
                                                        <p className="text-sm text-gray-600 truncate">{msg.content}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </Card>
                    )}

                    {/* 自動リマインド設定 */}
                    {activeLineTab === 'reminder' && (
                        <Card>
                            <h3 className="text-lg font-bold text-brown-800 mb-4 flex items-center">
                                <Icon name="bell" size={20} className="mr-2 text-green-600" />
                                自動リマインド送信
                            </h3>
                            <p className="text-sm text-gray-600 mb-6">
                                予約日の前に自動でリマインドメッセージを送信します。
                            </p>
                            <div className="space-y-6">
                                {/* 有効/無効トグル */}
                                <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                    <div>
                                        <p className="font-medium text-gray-800">自動リマインドを有効にする</p>
                                        <p className="text-sm text-gray-500">予約前に自動でメッセージを送信</p>
                                    </div>
                                    <button
                                        onClick={() => setReminderSettings({...reminderSettings, enabled: !reminderSettings.enabled})}
                                        className={`relative w-14 h-7 rounded-full transition-colors ${reminderSettings.enabled ? 'bg-green-500' : 'bg-gray-300'}`}
                                    >
                                        <div className={`absolute top-0.5 w-6 h-6 bg-white rounded-full shadow transition-transform ${reminderSettings.enabled ? 'translate-x-7' : 'translate-x-0.5'}`}></div>
                                    </button>
                                </div>

                                {/* 送信タイミング */}
                                <div>
                                    <label className="block text-sm text-gray-600 mb-2">送信タイミング</label>
                                    <select
                                        value={reminderSettings.daysBefore}
                                        onChange={(e) => setReminderSettings({...reminderSettings, daysBefore: Number(e.target.value)})}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                    >
                                        <option value={1}>予約日の1日前</option>
                                        <option value={2}>予約日の2日前</option>
                                        <option value={3}>予約日の3日前</option>
                                        <option value={7}>予約日の1週間前</option>
                                    </select>
                                </div>

                                {/* リマインドメッセージ */}
                                <div>
                                    <label className="block text-sm text-gray-600 mb-2">リマインドメッセージ</label>
                                    <textarea
                                        value={reminderSettings.message}
                                        onChange={(e) => setReminderSettings({...reminderSettings, message: e.target.value})}
                                        rows={4}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none"
                                    />
                                    <p className="text-xs text-gray-400 mt-1">
                                        ※ 顧客名は自動で挿入されます
                                    </p>
                                </div>

                                <button
                                    onClick={saveReminderSettings}
                                    className="w-full px-4 py-3 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors"
                                >
                                    設定を保存
                                </button>
                            </div>

                            {/* 設定プレビュー */}
                            <div className="mt-6 pt-4 border-t border-gray-200">
                                <h4 className="text-sm font-bold text-gray-700 mb-3">メッセージプレビュー</h4>
                                <div className="bg-green-50 rounded-lg p-4">
                                    <div className="flex items-start space-x-3">
                                        <div className="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                                            <Icon name="message-circle" size={16} className="text-white" />
                                        </div>
                                        <div className="bg-white rounded-lg p-3 shadow-sm flex-1">
                                            <p className="text-sm text-gray-800 whitespace-pre-wrap">
                                                ○○様へ{'\n\n'}{reminderSettings.message}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </Card>
                    )}

                    {/* ヘルプセクション */}
                    <Card>
                        <h3 className="text-lg font-bold text-brown-800 mb-4 flex items-center">
                            <Icon name="help-circle" size={20} className="mr-2 text-gold-600" />
                            LINE連携の設定方法
                        </h3>
                        <div className="space-y-4 text-sm text-gray-600">
                            <div className="flex items-start space-x-3">
                                <div className="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <span className="text-green-600 text-xs font-bold">1</span>
                                </div>
                                <div>
                                    <p className="font-medium text-gray-800">LINE Developersでチャネルを作成</p>
                                    <p className="text-gray-500">LINE Developers Consoleでプロバイダーとチャネルを作成します。</p>
                                </div>
                            </div>
                            <div className="flex items-start space-x-3">
                                <div className="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <span className="text-green-600 text-xs font-bold">2</span>
                                </div>
                                <div>
                                    <p className="font-medium text-gray-800">アクセストークンを取得</p>
                                    <p className="text-gray-500">Messaging APIの設定からチャネルアクセストークンを発行します。</p>
                                </div>
                            </div>
                            <div className="flex items-start space-x-3">
                                <div className="w-6 h-6 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 mt-0.5">
                                    <span className="text-green-600 text-xs font-bold">3</span>
                                </div>
                                <div>
                                    <p className="font-medium text-gray-800">上記フォームに設定を入力</p>
                                    <p className="text-gray-500">取得したトークンとシークレットを入力して保存します。</p>
                                </div>
                            </div>
                        </div>
                        <div className="mt-4 pt-4 border-t border-gray-200">
                            <a
                                href="https://developers.line.biz/console/"
                                target="_blank"
                                rel="noopener noreferrer"
                                className="inline-flex items-center text-green-600 hover:text-green-700 text-sm font-medium"
                            >
                                <Icon name="external-link" size={14} className="mr-1" />
                                LINE Developers Consoleを開く
                            </a>
                        </div>
                    </Card>
                </div>
            );
        };

        // --- Menu Management View ---
        const MenuManagementView = ({ menuList, onUpdateMenu, onAddMenu, onDeleteMenu }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [deletingId, setDeletingId] = useState(null);
            const [formData, setFormData] = useState({
                name: '',
                price: 0,
                cost: 0,
                availableStores: []
            });

            const startEdit = (menu) => {
                setEditingId(menu.id);
                setFormData({
                    name: menu.name,
                    price: menu.price,
                    cost: menu.cost || 0,
                    availableStores: Array.isArray(menu.availableStores) ? menu.availableStores : []
                });
                setIsEditing(true);
            };

            const startAdd = () => {
                setEditingId(null);
                setFormData({
                    name: '',
                    price: 0,
                    cost: 0,
                    availableStores: []
                });
                setIsEditing(true);
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                const isTextField = ['name'].includes(name);

                setFormData(prev => ({
                    ...prev,
                    [name]: isTextField ? value : (() => {
                        const processedValue = normalizeNumberInput(value);
                        return processedValue === '' ? 0 : Number(processedValue);
                    })()
                }));
            };

            const handleStoreToggle = (storeId) => {
                setFormData(prev => ({
                    ...prev,
                    availableStores: prev.availableStores.includes(storeId)
                        ? prev.availableStores.filter(id => id !== storeId)
                        : [...prev.availableStores, storeId]
                }));
            };

            const handleSubmit = () => {
                if (!formData.name.trim()) {
                    alert('メニュー名を入力してください');
                    return;
                }

                if (editingId) {
                    onUpdateMenu(editingId, { ...formData, id: editingId });
                } else {
                    const newMenu = {
                        ...formData,
                        id: Date.now()
                    };
                    onAddMenu(newMenu);
                }
                setIsEditing(false);
                setEditingId(null);
            };

            const confirmDelete = () => {
                if (deletingId) {
                    onDeleteMenu(deletingId);
                }
                setShowDeleteConfirm(false);
                setDeletingId(null);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold text-brown-800 serif">メニュー管理</h2>
                            <p className="text-sm text-gray-600 mt-1">施術メニューの登録・編集・削除</p>
                        </div>
                        <button
                            onClick={startAdd}
                            className="flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium shadow-sm transition-colors"
                        >
                            <Icon name="plus" size={18} className="mr-2" />
                            メニュー新規登録
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {!Array.isArray(menuList) || menuList.length === 0 ? (
                            <div className="col-span-full text-center py-12 text-gray-400">
                                <Icon name="package" size={48} className="mx-auto mb-4 opacity-30" />
                                <p className="text-sm">メニューが登録されていません</p>
                                <p className="text-xs mt-2">「メニュー新規登録」ボタンから追加してください</p>
                            </div>
                        ) : (
                            menuList.map(menu => (
                                <div key={menu.id} className="bg-white border border-purple-100 rounded-xl p-5 hover:shadow-md transition-shadow group relative">
                                    <div className="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                        <button
                                            onClick={() => startEdit(menu)}
                                            className="text-gray-300 hover:text-blue-500 p-1"
                                        >
                                            <Icon name="edit-2" size={16} />
                                        </button>
                                        <button
                                            onClick={() => { setDeletingId(menu.id); setShowDeleteConfirm(true); }}
                                            className="text-gray-300 hover:text-rose-500 p-1"
                                        >
                                            <Icon name="trash-2" size={16} />
                                        </button>
                                    </div>

                                    <div className="mb-4">
                                        <div className="w-12 h-12 rounded-full bg-purple-50 border border-purple-200 flex items-center justify-center text-purple-700 mb-3">
                                            <Icon name="package" size={24} />
                                        </div>
                                        <h3 className="font-bold text-brown-800 text-lg mb-1">{menu.name}</h3>
                                        <p className="text-2xl font-bold text-purple-600">¥{menu.price.toLocaleString()}</p>

                                        {/* 原価・粗利表示 */}
                                        {menu.cost !== undefined && menu.cost > 0 && (
                                            <div className="mt-3 pt-3 border-t border-purple-100 space-y-1">
                                                <div className="flex justify-between text-xs">
                                                    <span className="text-gray-500">原価</span>
                                                    <span className="text-gray-700">¥{menu.cost.toLocaleString()}</span>
                                                </div>
                                                <div className="flex justify-between text-xs">
                                                    <span className="text-gray-500">粗利</span>
                                                    <span className={`font-bold ${
                                                        ((menu.price - menu.cost) / menu.price * 100) >= 70 ? 'text-green-600' :
                                                        ((menu.price - menu.cost) / menu.price * 100) >= 50 ? 'text-yellow-600' :
                                                        'text-rose-600'
                                                    }`}>
                                                        ¥{(menu.price - menu.cost).toLocaleString()}
                                                        ({Math.round((menu.price - menu.cost) / menu.price * 100)}%)
                                                    </span>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <div className="pt-3 border-t border-gray-100">
                                        <p className="text-xs text-gray-500 mb-2">提供店舗</p>
                                        <div className="flex flex-wrap gap-1">
                                            {(menu.availableStores || []).map(storeId => {
                                                const store = stores.find(s => s.id === storeId);
                                                return store ? (
                                                    <span key={storeId} className="text-xs px-2 py-1 bg-purple-100 text-purple-700 rounded">
                                                        {store.name}
                                                    </span>
                                                ) : null;
                                            })}
                                        </div>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>

                    {/* 編集フォームモーダル */}
                    {isEditing && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl p-6 max-w-md w-full shadow-xl">
                                <h3 className="text-xl font-bold text-brown-800 mb-4 serif">
                                    {editingId ? 'メニュー編集' : 'メニュー新規登録'}
                                </h3>

                                <div className="space-y-4">
                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-1 block">メニュー名</label>
                                        <input
                                            type="text"
                                            name="name"
                                            value={formData.name}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 outline-none"
                                            placeholder="例: 剥離ありハーブピーリング(顔)"
                                        />
                                    </div>

                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-1 block">価格（円）</label>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            name="price"
                                            value={formData.price}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 outline-none"
                                        />
                                    </div>

                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-1 block">原価（円）</label>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            name="cost"
                                            value={formData.cost}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-purple-500 outline-none"
                                        />
                                        {formData.price > 0 && formData.cost > 0 && (
                                            <p className="text-xs text-gray-600 mt-1">
                                                粗利: ¥{(formData.price - formData.cost).toLocaleString()}
                                                ({Math.round((formData.price - formData.cost) / formData.price * 100)}%)
                                            </p>
                                        )}
                                    </div>

                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-2 block">提供店舗</label>
                                        <div className="space-y-2">
                                            {stores.map(store => (
                                                <label key={store.id} className="flex items-center space-x-2 cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={formData.availableStores.includes(store.id)}
                                                        onChange={() => handleStoreToggle(store.id)}
                                                        className="rounded border-gray-300 text-purple-600 focus:ring-purple-500"
                                                    />
                                                    <span className="text-sm text-gray-700">{store.name}</span>
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                <div className="flex justify-end space-x-3 mt-6">
                                    <button
                                        onClick={() => setIsEditing(false)}
                                        className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded-lg"
                                    >
                                        キャンセル
                                    </button>
                                    <button
                                        onClick={handleSubmit}
                                        className="px-4 py-2 text-sm bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium shadow-sm"
                                    >
                                        {editingId ? '更新する' : '登録する'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 削除確認モーダル */}
                    {showDeleteConfirm && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl p-6 max-w-sm w-full shadow-xl">
                                <div className="flex items-center space-x-3 mb-4">
                                    <div className="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center">
                                        <Icon name="alert-triangle" size={20} className="text-rose-600" />
                                    </div>
                                    <h3 className="text-lg font-bold text-brown-800">メニュー削除</h3>
                                </div>
                                <p className="text-sm text-gray-600 mb-6">
                                    このメニューを削除してもよろしいですか？この操作は取り消せません。
                                </p>
                                <div className="flex justify-end space-x-3">
                                    <button onClick={() => setShowDeleteConfirm(false)} className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded">キャンセル</button>
                                    <button onClick={confirmDelete} className="px-4 py-2 text-sm bg-rose-500 hover:bg-rose-600 text-white rounded font-medium shadow-sm">削除する</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Media Source Management View ---
        const MediaSourceManagementView = ({ mediaSourcesList, onUpdateMedia, onAddMedia, onDeleteMedia }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
            const [deletingId, setDeletingId] = useState(null);
            const [formData, setFormData] = useState({
                name: '',
                newVisits: 0,
                repeatRate: 0,
                cpa: 0,
                sales: 0,
                adCost: 0
            });

            const startEdit = (media) => {
                setEditingId(media.id);
                setFormData({
                    name: media.name,
                    newVisits: media.newVisits || 0,
                    repeatRate: media.repeatRate || 0,
                    cpa: media.cpa || 0,
                    sales: media.sales || 0,
                    adCost: media.adCost || 0
                });
                setIsEditing(true);
            };

            const startAdd = () => {
                setEditingId(null);
                setFormData({
                    name: '',
                    newVisits: 0,
                    repeatRate: 0,
                    cpa: 0,
                    sales: 0,
                    adCost: 0
                });
                setIsEditing(true);
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                const isTextField = ['name'].includes(name);

                setFormData(prev => ({
                    ...prev,
                    [name]: isTextField ? value : (() => {
                        const processedValue = normalizeNumberInput(value);
                        return processedValue === '' ? 0 : Number(processedValue);
                    })()
                }));
            };

            const handleSubmit = () => {
                if (!formData.name.trim()) {
                    alert('媒体名を入力してください');
                    return;
                }

                if (editingId) {
                    onUpdateMedia(editingId, { ...formData, id: editingId });
                } else {
                    const newMedia = {
                        ...formData,
                        id: Date.now()
                    };
                    onAddMedia(newMedia);
                }
                setIsEditing(false);
                setEditingId(null);
            };

            const confirmDelete = () => {
                if (deletingId) {
                    onDeleteMedia(deletingId);
                }
                setShowDeleteConfirm(false);
                setDeletingId(null);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <div>
                            <h2 className="text-2xl font-bold text-brown-800 serif">媒体マスター管理</h2>
                            <p className="text-sm text-gray-600 mt-1">集客媒体の登録・編集・削除</p>
                        </div>
                        <button
                            onClick={startAdd}
                            className="flex items-center px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-medium shadow-sm transition-colors"
                        >
                            <Icon name="plus" size={18} className="mr-2" />
                            媒体新規登録
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {!Array.isArray(mediaSourcesList) || mediaSourcesList.length === 0 ? (
                            <div className="col-span-full text-center py-12 text-gray-400">
                                <Icon name="megaphone" size={48} className="mx-auto mb-4 opacity-30" />
                                <p className="text-sm">媒体が登録されていません</p>
                                <p className="text-xs mt-2">「媒体新規登録」ボタンから追加してください</p>
                            </div>
                        ) : (
                            mediaSourcesList.map(media => {
                                const roas = media.adCost > 0 ? ((media.sales / media.adCost) * 100).toFixed(0) : '-';
                                return (
                                    <div key={media.id} className="bg-white border border-amber-100 rounded-xl p-5 hover:shadow-md transition-shadow group relative">
                                        <div className="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                            <button
                                                onClick={() => startEdit(media)}
                                                className="text-gray-300 hover:text-blue-500 p-1"
                                            >
                                                <Icon name="edit-2" size={16} />
                                            </button>
                                            <button
                                                onClick={() => { setDeletingId(media.id); setShowDeleteConfirm(true); }}
                                                className="text-gray-300 hover:text-rose-500 p-1"
                                            >
                                                <Icon name="trash-2" size={16} />
                                            </button>
                                        </div>

                                        <div className="mb-4">
                                            <div className="w-12 h-12 rounded-full bg-amber-50 border border-amber-200 flex items-center justify-center text-amber-700 mb-3">
                                                <Icon name="megaphone" size={24} />
                                            </div>
                                            <h3 className="font-bold text-brown-800 text-lg mb-1">{media.name}</h3>
                                        </div>

                                        <div className="space-y-2 text-sm">
                                            <div className="flex justify-between">
                                                <span className="text-gray-500">新規集客数</span>
                                                <span className="font-bold text-blue-600">{media.newVisits}人</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-gray-500">リピート率</span>
                                                <span className="font-bold text-emerald-600">{media.repeatRate}%</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-gray-500">獲得単価(CPA)</span>
                                                <span className="font-bold">¥{media.cpa.toLocaleString()}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-gray-500">広告費</span>
                                                <span className="font-bold text-rose-600">¥{media.adCost.toLocaleString()}</span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="text-gray-500">売上貢献</span>
                                                <span className="font-bold text-purple-600">¥{media.sales.toLocaleString()}</span>
                                            </div>
                                            {roas !== '-' && (
                                                <div className="flex justify-between pt-2 border-t border-gray-100">
                                                    <span className="text-gray-500 font-semibold">ROAS</span>
                                                    <span className={`font-bold ${
                                                        Number(roas) >= 300 ? 'text-green-600' :
                                                        Number(roas) >= 150 ? 'text-yellow-600' :
                                                        'text-red-600'
                                                    }`}>
                                                        {roas}%
                                                    </span>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })
                        )}
                    </div>

                    {/* 編集フォームモーダル */}
                    {isEditing && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl p-6 max-w-md w-full shadow-xl max-h-[90vh] overflow-y-auto">
                                <h3 className="text-xl font-bold text-brown-800 mb-4 serif">
                                    {editingId ? '媒体編集' : '媒体新規登録'}
                                </h3>

                                <div className="space-y-4">
                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-1 block">媒体名</label>
                                        <input
                                            type="text"
                                            name="name"
                                            value={formData.name}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-amber-500 outline-none"
                                            placeholder="例: ホットペッパー"
                                        />
                                    </div>

                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-1 block">新規集客数（人）</label>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            name="newVisits"
                                            value={formData.newVisits}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-amber-500 outline-none"
                                        />
                                    </div>

                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-1 block">リピート率（%）</label>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            name="repeatRate"
                                            value={formData.repeatRate}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-amber-500 outline-none"
                                        />
                                    </div>

                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-1 block">獲得単価（円）</label>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            name="cpa"
                                            value={formData.cpa}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-amber-500 outline-none"
                                        />
                                    </div>

                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-1 block">広告費（円）</label>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            name="adCost"
                                            value={formData.adCost}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-amber-500 outline-none"
                                        />
                                    </div>

                                    <div>
                                        <label className="text-sm font-medium text-gray-700 mb-1 block">売上貢献（円）</label>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            name="sales"
                                            value={formData.sales}
                                            onChange={handleChange}
                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:border-amber-500 outline-none"
                                        />
                                    </div>
                                </div>

                                <div className="flex justify-end space-x-3 mt-6">
                                    <button
                                        onClick={() => setIsEditing(false)}
                                        className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded-lg"
                                    >
                                        キャンセル
                                    </button>
                                    <button
                                        onClick={handleSubmit}
                                        className="px-4 py-2 text-sm bg-amber-600 hover:bg-amber-700 text-white rounded-lg font-medium shadow-sm"
                                    >
                                        {editingId ? '更新する' : '登録する'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* 削除確認モーダル */}
                    {showDeleteConfirm && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl p-6 max-w-sm w-full shadow-xl">
                                <div className="flex items-center space-x-3 mb-4">
                                    <div className="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center">
                                        <Icon name="alert-triangle" size={20} className="text-rose-600" />
                                    </div>
                                    <h3 className="text-lg font-bold text-brown-800">媒体削除</h3>
                                </div>
                                <p className="text-sm text-gray-600 mb-6">
                                    この媒体を削除してもよろしいですか？この操作は取り消せません。
                                </p>
                                <div className="flex justify-end space-x-3">
                                    <button onClick={() => setShowDeleteConfirm(false)} className="px-4 py-2 text-sm text-gray-500 hover:bg-gray-100 rounded">キャンセル</button>
                                    <button onClick={confirmDelete} className="px-4 py-2 text-sm bg-rose-500 hover:bg-rose-600 text-white rounded font-medium shadow-sm">削除する</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Menu Analysis View ---
        const MenuAnalysisView = ({ menuSalesData }) => {
            if (!window.Recharts) return <div>Loading Charts...</div>;

            const safeMenuSalesData = Array.isArray(menuSalesData) ? menuSalesData : [];
            const hasData = safeMenuSalesData.length > 0;

            // メニューIDごとにデータを集約
            const aggregatedMenuData = useMemo(() => {
                if (!hasData) return [];

                const menuMap = {};
                safeMenuSalesData.forEach(entry => {
                    if (!menuMap[entry.menuId]) {
                        menuMap[entry.menuId] = {
                            menuId: entry.menuId,
                            menuName: entry.menuName,
                            count: 0,
                            sales: 0,
                            storeIds: new Set()
                        };
                    }
                    menuMap[entry.menuId].count += entry.count || 0;
                    menuMap[entry.menuId].sales += entry.sales || 0;
                    menuMap[entry.menuId].storeIds.add(entry.storeId);
                });

                return Object.values(menuMap).map(menu => ({
                    ...menu,
                    storeIds: Array.from(menu.storeIds)
                }));
            }, [safeMenuSalesData, hasData]);

            const totalMenuSales = hasData ? safeMenuSalesData.reduce((sum, m) => sum + (m.sales || 0), 0) : 0;
            const totalMenuCount = hasData ? safeMenuSalesData.reduce((sum, m) => sum + (m.count || 0), 0) : 0;
            const topMenu = aggregatedMenuData.length > 0 ? [...aggregatedMenuData].sort((a, b) => (b.count || 0) - (a.count || 0))[0] : null;

            if (!hasData) {
                return (
                    <div className="text-center py-12 text-gray-400">
                        <Icon name="package" size={48} className="mx-auto mb-4 opacity-30" />
                        <p className="text-lg font-bold text-brown-800">メニュー別売上データがありません</p>
                        <p className="text-sm mt-2">日次売上の入力を行うと、メニュー別の分析が表示されます</p>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    {/* メニュー別売上カード */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <KpiCard
                            title="メニュー総売上"
                            value={`¥${totalMenuSales.toLocaleString()}`}
                            subValue={`総施術回数: ${totalMenuCount}回`}
                            trend={null}
                            icon="shopping-bag"
                            color="bg-gold-600"
                        />
                        <KpiCard
                            title="平均施術単価"
                            value={totalMenuCount > 0 ? `¥${Math.round(totalMenuSales / totalMenuCount).toLocaleString()}` : '¥0'}
                            subValue="全メニュー平均"
                            trend={null}
                            icon="trending-up"
                            color="bg-emerald-600"
                        />
                        <KpiCard
                            title="人気No.1メニュー"
                            value={topMenu ? topMenu.menuName.substring(0, 10) : '-'}
                            subValue={topMenu ? `${topMenu.count}回実施` : 'データなし'}
                            trend={null}
                            icon="award"
                            color="bg-rose-500"
                        />
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* メニュー別売上テーブル */}
                        <Card>
                            <h2 className="text-lg font-bold text-brown-800 mb-6 serif">メニュー別売上詳細</h2>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left border-collapse">
                                    <thead>
                                        <tr className="border-b border-gold-100 text-xs text-gray-500 uppercase">
                                            <th className="py-3 font-medium">メニュー名</th>
                                            <th className="py-3 font-medium text-right">回数</th>
                                            <th className="py-3 font-medium text-right">売上</th>
                                            <th className="py-3 font-medium text-center">対応店舗</th>
                                        </tr>
                                    </thead>
                                    <tbody className="text-sm divide-y divide-gray-50">
                                        {aggregatedMenuData.map((menu) => (
                                            <tr key={menu.menuId} className="hover:bg-gold-50/50">
                                                <td className="py-3 font-medium text-brown-800">{menu.menuName}</td>
                                                <td className="py-3 text-right">{menu.count}回</td>
                                                <td className="py-3 text-right font-bold">¥{menu.sales.toLocaleString()}</td>
                                                <td className="py-3 text-center">
                                                    <span className="text-xs px-2 py-1 bg-gray-100 rounded">
                                                        {menu.storeIds.length === 2 ? '両店舗' : menu.storeIds.includes(1) ? '新宿店のみ' : '新宿南口店のみ'}
                                                    </span>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </Card>

                        {/* メニュー別売上グラフ */}
                        <Card>
                            <h2 className="text-lg font-bold text-brown-800 mb-6 serif">メニュー別売上構成比</h2>
                            <ResponsiveContainer width="100%" height={300}>
                                <BarChart data={aggregatedMenuData} layout="vertical">
                                    <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#e5e7eb" />
                                    <XAxis type="number" tick={{fontSize: 10}} tickFormatter={(val) => `¥${val/10000}万`} />
                                    <YAxis type="category" dataKey="menuName" tick={{fontSize: 9}} width={120} />
                                    <Tooltip
                                        formatter={(value) => `¥${value.toLocaleString()}`}
                                        contentStyle={{backgroundColor: '#fff', borderColor: '#d4af37'}}
                                    />
                                    <Bar dataKey="sales" name="売上" fill="#d4af37" radius={[0, 4, 4, 0]} />
                                </BarChart>
                            </ResponsiveContainer>
                        </Card>
                    </div>

                    {/* 店舗限定メニューの注意書き */}
                    <Card className="bg-gold-50 border-gold-300">
                        <div className="flex items-start">
                            <Icon name="info" size={20} className="text-gold-600 mr-3 mt-1" />
                            <div>
                                <h3 className="font-bold text-brown-800 mb-2">店舗限定メニュー情報</h3>
                                <p className="text-sm text-gray-700">
                                    「よもぎ蒸し」と「セルフホワイトニング」は<span className="font-bold text-gold-700">新宿南口店でのみ</span>提供しているメニューです。
                                    新宿店でも提供を検討する場合は、設備投資と収益性のシミュレーションをお勧めします。
                                </p>
                            </div>
                        </div>
                    </Card>
                </div>
            );
        };

        // --- Performance Input View ---
        const PerformanceInputView = ({ dailySalesData, setDailySalesData, menuSalesData, setMenuSalesData, staffList = [] }) => {
            const [activeInputTab, setActiveInputTab] = useState('daily'); // 'daily' or 'menu'

            // 日次売上入力フォーム
            const [dailyForm, setDailyForm] = useState({
                date: new Date().toISOString().split('T')[0],
                storeId: 1,
                staffId: null, // スタッフ選択（オプション）
                spotSales: 0,
                ticketSales: 0,
                ticketUsage: 0,
                product: 0
            });

            // メニュー売上入力フォーム
            const [menuForm, setMenuForm] = useState({
                date: new Date().toISOString().split('T')[0],
                menuId: 1,
                storeId: 1,
                staffId: null, // スタッフ選択（オプション）
                count: 0
            });

            const handleDailyFormChange = (e) => {
                const { name, value } = e.target;
                const isTextField = ['date'].includes(name);
                const isSelectNumber = ['staffId', 'storeId', 'menuId'].includes(name);

                setDailyForm(prev => ({
                    ...prev,
                    [name]: isTextField ? value :
                            (name === 'staffId' && value === '') ? null :
                            isSelectNumber ? (value === '' ? null : Number(value)) :
                            (() => {
                                const processedValue = normalizeNumberInput(value);
                                return processedValue === '' ? 0 : Number(processedValue);
                            })()
                }));
            };

            const handleMenuFormChange = (e) => {
                const { name, value } = e.target;
                const isTextField = ['date'].includes(name);
                const isSelectNumber = ['staffId', 'storeId', 'menuId'].includes(name);

                setMenuForm(prev => ({
                    ...prev,
                    [name]: isTextField ? value :
                            (name === 'staffId' && value === '') ? null :
                            isSelectNumber ? (value === '' ? null : Number(value)) :
                            (() => {
                                const processedValue = normalizeNumberInput(value);
                                return processedValue === '' ? 0 : Number(processedValue);
                            })()
                }));
            };

            const handleDailySalesSubmit = () => {
                const store = stores.find(s => s.id === dailyForm.storeId);
                if (!store) {
                    alert('店舗を選択してください');
                    return;
                }
                const accountingSales = dailyForm.spotSales + dailyForm.ticketUsage + dailyForm.product;
                const cashIn = dailyForm.spotSales + dailyForm.ticketSales + dailyForm.product;

                const newEntry = {
                    day: new Date(dailyForm.date).getDate() + '日',
                    date: dailyForm.date,
                    storeId: dailyForm.storeId,
                    storeName: store.name,
                    spotSales: dailyForm.spotSales,
                    ticketSales: dailyForm.ticketSales,
                    ticketUsage: dailyForm.ticketUsage,
                    product: dailyForm.product,
                    accountingSales,
                    cashIn,
                    storeData: [{
                        storeId: dailyForm.storeId,
                        storeName: store.name,
                        spotSales: dailyForm.spotSales,
                        ticketSales: dailyForm.ticketSales,
                        ticketUsage: dailyForm.ticketUsage,
                        product: dailyForm.product,
                        accountingSales,
                        cashIn
                    }]
                };

                setDailySalesData(prev => [...prev, newEntry]);

                // フォームをリセット
                setDailyForm({
                    date: new Date().toISOString().split('T')[0],
                    storeId: 1,
                    spotSales: 0,
                    ticketSales: 0,
                    ticketUsage: 0,
                    product: 0
                });

                alert('日次売上を登録しました！');
            };

            const handleMenuSalesSubmit = () => {
                const menu = menus.find(m => m.id === menuForm.menuId);
                const sales = menuForm.count * menu.price;

                const newEntry = {
                    id: Date.now(),
                    date: menuForm.date,
                    menuId: menuForm.menuId,
                    menuName: menu.name,
                    storeId: menuForm.storeId,
                    count: menuForm.count,
                    sales,
                    availableStores: menu.availableStores
                };

                setMenuSalesData(prev => [...prev, newEntry]);

                // フォームをリセット
                setMenuForm({
                    date: new Date().toISOString().split('T')[0],
                    menuId: 1,
                    storeId: 1,
                    count: 0
                });

                alert('メニュー売上を登録しました！');
            };

            return (
                <div className="space-y-6">
                    {/* タブ切り替え */}
                    <div className="flex gap-2 bg-white rounded-lg p-1 border border-gold-200 inline-flex">
                        <button
                            onClick={() => setActiveInputTab('daily')}
                            className={`px-6 py-2 rounded text-sm font-medium transition-colors ${
                                activeInputTab === 'daily' ? 'bg-gold-500 text-white' : 'text-gray-600 hover:bg-gold-50'
                            }`}
                        >
                            日次売上入力
                        </button>
                        <button
                            onClick={() => setActiveInputTab('menu')}
                            className={`px-6 py-2 rounded text-sm font-medium transition-colors ${
                                activeInputTab === 'menu' ? 'bg-gold-500 text-white' : 'text-gray-600 hover:bg-gold-50'
                            }`}
                        >
                            メニュー別売上入力
                        </button>
                    </div>

                    {/* 日次売上入力フォーム */}
                    {activeInputTab === 'daily' && (
                        <Card>
                            <h2 className="text-xl font-bold text-brown-800 mb-6 serif">日次売上データ入力</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">日付</label>
                                    <input
                                        type="date"
                                        name="date"
                                        value={dailyForm.date}
                                        onChange={handleDailyFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">店舗</label>
                                    <select
                                        name="storeId"
                                        value={dailyForm.storeId}
                                        onChange={handleDailyFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                    >
                                        {stores.map(store => (
                                            <option key={store.id} value={store.id}>{store.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">スタッフ（任意）</label>
                                    <select
                                        name="staffId"
                                        value={dailyForm.staffId || ''}
                                        onChange={handleDailyFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                    >
                                        <option value="">全体（スタッフ指定なし）</option>
                                        {(staffList || []).filter(s => s.storeId === dailyForm.storeId).map(staff => (
                                            <option key={staff.id} value={staff.id}>{staff.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">都度払い売上 (円)</label>
                                    <input
                                        type="text"
                                        inputMode="numeric"
                                        name="spotSales"
                                        value={dailyForm.spotSales}
                                        onChange={handleDailyFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                        placeholder="0"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">回数券販売 (円)</label>
                                    <input
                                        type="text"
                                        inputMode="numeric"
                                        name="ticketSales"
                                        value={dailyForm.ticketSales}
                                        onChange={handleDailyFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                        placeholder="0"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">回数券消化 (円)</label>
                                    <input
                                        type="text"
                                        inputMode="numeric"
                                        name="ticketUsage"
                                        value={dailyForm.ticketUsage}
                                        onChange={handleDailyFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                        placeholder="0"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">物販売上 (円)</label>
                                    <input
                                        type="text"
                                        inputMode="numeric"
                                        name="product"
                                        value={dailyForm.product}
                                        onChange={handleDailyFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                        placeholder="0"
                                    />
                                </div>
                            </div>
                            <div className="mt-6 flex justify-end">
                                <button
                                    onClick={handleDailySalesSubmit}
                                    className="px-6 py-3 bg-gold-500 hover:bg-gold-600 text-white font-bold rounded-lg shadow-sm transition-colors"
                                >
                                    登録する
                                </button>
                            </div>
                        </Card>
                    )}

                    {/* メニュー別売上入力フォーム */}
                    {activeInputTab === 'menu' && (
                        <Card>
                            <h2 className="text-xl font-bold text-brown-800 mb-6 serif">メニュー別売上データ入力</h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">日付</label>
                                    <input
                                        type="date"
                                        name="date"
                                        value={menuForm.date}
                                        onChange={handleMenuFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">店舗</label>
                                    <select
                                        name="storeId"
                                        value={menuForm.storeId}
                                        onChange={handleMenuFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                    >
                                        {stores.map(store => (
                                            <option key={store.id} value={store.id}>{store.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">メニュー</label>
                                    <select
                                        name="menuId"
                                        value={menuForm.menuId}
                                        onChange={handleMenuFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                    >
                                        {menus.filter(m => m.availableStores.includes(menuForm.storeId)).map(menu => (
                                            <option key={menu.id} value={menu.id}>
                                                {menu.name} (¥{menu.price.toLocaleString()})
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">スタッフ（任意）</label>
                                    <select
                                        name="staffId"
                                        value={menuForm.staffId || ''}
                                        onChange={handleMenuFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                    >
                                        <option value="">全体（スタッフ指定なし）</option>
                                        {(staffList || []).filter(s => s.storeId === menuForm.storeId).map(staff => (
                                            <option key={staff.id} value={staff.id}>{staff.name}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">施術回数</label>
                                    <input
                                        type="text"
                                        inputMode="numeric"
                                        name="count"
                                        value={menuForm.count}
                                        onChange={handleMenuFormChange}
                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-gold-500 outline-none"
                                        placeholder="0"
                                    />
                                </div>
                            </div>
                            <div className="mt-6 bg-gold-50 rounded-lg p-4">
                                <p className="text-sm text-gray-700">
                                    <strong>予想売上:</strong> ¥{(menuForm.count * (menus.find(m => m.id === menuForm.menuId)?.price || 0)).toLocaleString()}
                                </p>
                            </div>
                            <div className="mt-6 flex justify-end">
                                <button
                                    onClick={handleMenuSalesSubmit}
                                    className="px-6 py-3 bg-gold-500 hover:bg-gold-600 text-white font-bold rounded-lg shadow-sm transition-colors"
                                >
                                    登録する
                                </button>
                            </div>
                        </Card>
                    )}

                    {/* 登録済みデータ一覧 */}
                    {activeInputTab === 'daily' && dailySalesData.length > 0 && (
                        <Card>
                            <h3 className="text-lg font-bold text-brown-800 mb-4">登録済み日次売上（最新10件）</h3>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gold-50 border-b border-gold-100">
                                        <tr className="text-left text-xs text-gray-500 uppercase">
                                            <th className="py-2 px-3">日付</th>
                                            <th className="py-2 px-3">店舗</th>
                                            <th className="py-2 px-3 text-right">都度払い</th>
                                            <th className="py-2 px-3 text-right">回数券販売</th>
                                            <th className="py-2 px-3 text-right">回数券消化</th>
                                            <th className="py-2 px-3 text-right">物販</th>
                                            <th className="py-2 px-3 text-right">合計売上</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {dailySalesData.slice(-10).reverse().map((item, index) => (
                                            <tr key={index} className="hover:bg-gold-50/30">
                                                <td className="py-2 px-3">{item.date || item.day}</td>
                                                <td className="py-2 px-3">{item.storeName}</td>
                                                <td className="py-2 px-3 text-right">¥{item.spotSales.toLocaleString()}</td>
                                                <td className="py-2 px-3 text-right">¥{item.ticketSales.toLocaleString()}</td>
                                                <td className="py-2 px-3 text-right">¥{item.ticketUsage.toLocaleString()}</td>
                                                <td className="py-2 px-3 text-right">¥{item.product.toLocaleString()}</td>
                                                <td className="py-2 px-3 text-right font-bold">¥{item.accountingSales.toLocaleString()}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </Card>
                    )}

                    {activeInputTab === 'menu' && menuSalesData.length > 0 && (
                        <Card>
                            <h3 className="text-lg font-bold text-brown-800 mb-4">登録済みメニュー売上（最新10件）</h3>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gold-50 border-b border-gold-100">
                                        <tr className="text-left text-xs text-gray-500 uppercase">
                                            <th className="py-2 px-3">日付</th>
                                            <th className="py-2 px-3">メニュー</th>
                                            <th className="py-2 px-3 text-right">回数</th>
                                            <th className="py-2 px-3 text-right">売上</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-100">
                                        {(menuSalesData || []).slice(-10).reverse().map((item, index) => (
                                            <tr key={index} className="hover:bg-gold-50/30">
                                                <td className="py-2 px-3">{item.date}</td>
                                                <td className="py-2 px-3">{item.menuName}</td>
                                                <td className="py-2 px-3 text-right">{item.count}回</td>
                                                <td className="py-2 px-3 text-right font-bold">¥{item.sales.toLocaleString()}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </Card>
                    )}
                </div>
            );
        };

        // --- Simulation View (Reused but Styled) ---
        // --- Calendar View Component ---
        const CalendarView = ({ dailySalesData, staffId = null }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null);

            // 月の最初の日と最後の日を取得
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            // カレンダーグリッドを生成
            const startingDayOfWeek = firstDay.getDay(); // 0 (日曜) ~ 6 (土曜)
            const daysInMonth = lastDay.getDate();

            // 月を変更
            const changeMonth = (offset) => {
                setCurrentDate(new Date(year, month + offset, 1));
                setSelectedDate(null);
            };

            // 日付から売上データを取得（date形式: '2026-01-15'に対応）
            const getSalesForDay = (day) => {
                if (!dailySalesData || dailySalesData.length === 0) return null;

                // 現在の年月と日から日付文字列を生成
                const targetDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                // その日の売上データをすべて取得してフィルタリング
                let dayData = dailySalesData.filter(d => {
                    if (!d.date) return false;
                    return d.date === targetDate;
                });

                // スタッフIDでフィルタリング（スタッフモードの場合）
                if (staffId) {
                    dayData = dayData.filter(d => d.staffId === staffId);
                }

                if (dayData.length === 0) return null;

                // 同じ日の複数データを合算
                const aggregated = {
                    date: targetDate,
                    spotSales: 0,
                    ticketSales: 0,
                    ticketUsage: 0,
                    product: 0,
                    accountingSales: 0,
                    cashIn: 0,
                    storeData: []
                };

                // 店舗別データを集計
                const storeMap = {};

                dayData.forEach(d => {
                    aggregated.spotSales += d.spotSales || 0;
                    aggregated.ticketSales += d.ticketSales || 0;
                    aggregated.ticketUsage += d.ticketUsage || 0;
                    aggregated.product += d.product || 0;
                    aggregated.accountingSales += d.accountingSales || 0;
                    aggregated.cashIn += d.cashIn || 0;

                    // 店舗別データを集計
                    if (d.storeId && d.storeName) {
                        if (!storeMap[d.storeId]) {
                            storeMap[d.storeId] = {
                                storeId: d.storeId,
                                storeName: d.storeName,
                                cashIn: 0,
                                accountingSales: 0
                            };
                        }
                        storeMap[d.storeId].cashIn += d.cashIn || 0;
                        storeMap[d.storeId].accountingSales += d.accountingSales || 0;
                    }
                });

                aggregated.storeData = Object.values(storeMap);

                return aggregated;
            };

            // 売上額に応じた色を返す
            const getSalesColor = (sales) => {
                if (!sales) return 'bg-gray-50 border-gray-200';
                if (sales.cashIn >= 250000) return 'bg-rose-50 border-rose-300';
                if (sales.cashIn >= 180000) return 'bg-orange-50 border-orange-300';
                if (sales.cashIn >= 120000) return 'bg-yellow-50 border-yellow-300';
                if (sales.cashIn >= 60000) return 'bg-blue-50 border-blue-300';
                return 'bg-gray-50 border-gray-200';
            };

            // カレンダーグリッドを作成
            const calendarDays = [];

            // 空白セル（月の最初の曜日まで）
            for (let i = 0; i < startingDayOfWeek; i++) {
                calendarDays.push(<div key={`empty-${i}`} className="min-h-24"></div>);
            }

            // 日付セル
            for (let day = 1; day <= daysInMonth; day++) {
                const salesData = getSalesForDay(day);
                const colorClass = getSalesColor(salesData);
                const isSelected = selectedDate === day;

                calendarDays.push(
                    <div
                        key={day}
                        onClick={() => setSelectedDate(day)}
                        className={`min-h-24 border-2 rounded-lg p-2 cursor-pointer transition-all ${colorClass} ${
                            isSelected ? 'ring-2 ring-gold-500 scale-105' : 'hover:shadow-md'
                        }`}
                    >
                        <div className="font-bold text-brown-800 text-sm mb-1">{day}</div>
                        {salesData ? (
                            <div className="space-y-1">
                                <div className="text-xs text-gray-600">
                                    ¥{salesData.cashIn.toLocaleString()}
                                </div>
                                <div className="text-xs text-gray-500">
                                    {salesData.storeData && salesData.storeData.length > 0 ? (
                                        salesData.storeData.map((store, idx) => (
                                            <div key={idx}>{store.storeName}: ¥{store.cashIn.toLocaleString()}</div>
                                        ))
                                    ) : null}
                                </div>
                            </div>
                        ) : (
                            <div className="text-xs text-gray-400">休業</div>
                        )}
                    </div>
                );
            }

            const selectedDayData = selectedDate ? getSalesForDay(selectedDate) : null;

            return (
                <div className="space-y-6">
                    <Card>
                        {/* ヘッダー */}
                        <div className="flex justify-between items-center mb-6">
                            <div>
                                <h2 className="text-2xl font-bold text-brown-800 serif">
                                    {staffId ? 'マイカレンダー' : 'カレンダービュー'}
                                </h2>
                                <p className="text-sm text-gray-500 mt-1">
                                    {staffId ? '個人の月間売上を確認' : '月間売上を一目で確認'}
                                </p>
                            </div>
                            <div className="flex items-center space-x-4">
                                <button
                                    onClick={() => changeMonth(-1)}
                                    className="p-2 hover:bg-gray-100 rounded-full transition-colors"
                                >
                                    <Icon name="chevron-left" size={20} />
                                </button>
                                <h3 className="text-xl font-bold text-brown-800 min-w-[160px] text-center">
                                    {year}年{month + 1}月
                                </h3>
                                <button
                                    onClick={() => changeMonth(1)}
                                    className="p-2 hover:bg-gray-100 rounded-full transition-colors"
                                >
                                    <Icon name="chevron-right" size={20} />
                                </button>
                            </div>
                        </div>

                        {/* 曜日ヘッダー */}
                        <div className="grid grid-cols-7 gap-2 mb-2">
                            {['日', '月', '火', '水', '木', '金', '土'].map(day => (
                                <div key={day} className="text-center font-bold text-sm text-gray-600 py-2">
                                    {day}
                                </div>
                            ))}
                        </div>

                        {/* カレンダーグリッド */}
                        <div className="grid grid-cols-7 gap-2">
                            {calendarDays}
                        </div>

                        {/* 凡例 */}
                        <div className="mt-6 pt-6 border-t border-gray-200">
                            <p className="text-xs text-gray-600 mb-2 font-semibold">売上レベル</p>
                            <div className="flex flex-wrap gap-3 text-xs">
                                <div className="flex items-center space-x-2">
                                    <div className="w-4 h-4 rounded bg-gray-50 border border-gray-200"></div>
                                    <span className="text-gray-600">休業</span>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <div className="w-4 h-4 rounded bg-blue-50 border border-blue-300"></div>
                                    <span className="text-gray-600">~¥60k</span>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <div className="w-4 h-4 rounded bg-yellow-50 border border-yellow-300"></div>
                                    <span className="text-gray-600">¥60k~¥120k</span>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <div className="w-4 h-4 rounded bg-orange-50 border border-orange-300"></div>
                                    <span className="text-gray-600">¥120k~¥180k</span>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <div className="w-4 h-4 rounded bg-rose-50 border border-rose-300"></div>
                                    <span className="text-gray-600">¥180k~</span>
                                </div>
                            </div>
                        </div>
                    </Card>

                    {/* 選択された日の詳細 */}
                    {selectedDayData && (
                        <Card>
                            <h3 className="text-lg font-bold text-brown-800 mb-4">
                                {month + 1}月{selectedDate}日の詳細
                            </h3>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <p className="text-xs text-gray-600 mb-1">都度払い</p>
                                    <p className="text-xl font-bold text-blue-700">¥{selectedDayData.spotSales.toLocaleString()}</p>
                                </div>
                                <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                    <p className="text-xs text-gray-600 mb-1">回数券販売</p>
                                    <p className="text-xl font-bold text-purple-700">¥{selectedDayData.ticketSales.toLocaleString()}</p>
                                </div>
                                <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                                    <p className="text-xs text-gray-600 mb-1">回数券消化</p>
                                    <p className="text-xl font-bold text-emerald-700">¥{selectedDayData.ticketUsage.toLocaleString()}</p>
                                </div>
                                <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                                    <p className="text-xs text-gray-600 mb-1">物販</p>
                                    <p className="text-xl font-bold text-amber-700">¥{selectedDayData.product.toLocaleString()}</p>
                                </div>
                                <div className="bg-rose-50 border border-rose-200 rounded-lg p-4">
                                    <p className="text-xs text-gray-600 mb-1">会計上売上</p>
                                    <p className="text-xl font-bold text-rose-700">¥{selectedDayData.accountingSales.toLocaleString()}</p>
                                </div>
                                <div className="bg-gold-50 border border-gold-200 rounded-lg p-4">
                                    <p className="text-xs text-gray-600 mb-1">キャッシュイン</p>
                                    <p className="text-xl font-bold text-gold-600">¥{selectedDayData.cashIn.toLocaleString()}</p>
                                </div>
                            </div>

                            {/* 店舗別データ */}
                            {selectedDayData.storeData && selectedDayData.storeData.length > 0 && (
                                <div className="mt-6 pt-6 border-t border-gray-200">
                                    <h4 className="text-sm font-bold text-gray-700 mb-3">店舗別</h4>
                                    <div className="space-y-3">
                                        {selectedDayData.storeData.map((store, idx) => (
                                            <div key={idx} className="bg-gray-50 rounded-lg p-3">
                                                <p className="font-bold text-brown-800 mb-2">{store.storeName}</p>
                                                <div className="grid grid-cols-2 gap-2 text-xs">
                                                    <div>キャッシュイン: ¥{store.cashIn.toLocaleString()}</div>
                                                    <div>会計上売上: ¥{store.accountingSales.toLocaleString()}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </Card>
                    )}
                </div>
            );
        };

        const SimulationView = ({ staffList, onUpdateStaff }) => {
            const [selectedStaffId, setSelectedStaffId] = useState(null);
            const [targetSales, setTargetSales] = useState(0);
            const [manualTarget, setManualTarget] = useState('');

            // 新規・リピート関連
            const [newCustomers, setNewCustomers] = useState(0);
            const [repeatCustomers, setRepeatCustomers] = useState(0);
            const [newCustomerPrice, setNewCustomerPrice] = useState(0);
            const [repeatCustomerPrice, setRepeatCustomerPrice] = useState(0);

            // 選択されたスタッフ
            const selectedStaff = selectedStaffId ? staffList.find(s => s.id === selectedStaffId) : null;

            // 回数券関連
            const [ticketPurchaseRate, setTicketPurchaseRate] = useState(0); // %
            const [ticketAvgPrice, setTicketAvgPrice] = useState(0);

            // オプション・物販
            const [optionRate, setOptionRate] = useState(0); // %
            const [optionAvgPrice, setOptionAvgPrice] = useState(0);
            const [productSalesPerMonth, setProductSalesPerMonth] = useState(0);

            // 計算
            const totalCustomers = newCustomers + repeatCustomers;
            const ticketPurchaseCount = Math.round((newCustomers * ticketPurchaseRate) / 100);
            const optionCount = Math.round((totalCustomers * optionRate) / 100);

            const newCustomerSales = newCustomers * newCustomerPrice;
            const repeatCustomerSales = repeatCustomers * repeatCustomerPrice;
            const ticketSales = ticketPurchaseCount * ticketAvgPrice;
            const optionSales = optionCount * optionAvgPrice;

            const projectedSales = newCustomerSales + repeatCustomerSales + optionSales + productSalesPerMonth;
            const displayTarget = manualTarget ? Number(manualTarget) : targetSales;
            const progress = Math.min(100, (projectedSales / displayTarget) * 100);
            const diff = projectedSales - displayTarget;

            return (
                <div className="space-y-6">
                    <Card>
                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <h2 className="text-xl font-bold text-brown-800 mb-2 serif">詳細売上シミュレーション</h2>
                                <p className="text-sm text-gray-500">新規・リピート・回数券・オプション・物販を含めた詳細な売上予測</p>
                            </div>
                            <div className="w-64">
                                <label className="text-xs font-medium text-gray-700 mb-1 block">スタッフを選択</label>
                                <select
                                    value={selectedStaffId || ''}
                                    onChange={(e) => setSelectedStaffId(e.target.value ? Number(e.target.value) : null)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:border-gold-500 outline-none bg-white"
                                >
                                    <option value="">全体目標</option>
                                    {(staffList || []).map(staff => (
                                        <option key={staff.id} value={staff.id}>
                                            {staff.name} ({staff.role})
                                        </option>
                                    ))}
                                </select>
                                {selectedStaff && (
                                    <div className="mt-2 space-y-2">
                                        <div className="text-xs text-gray-600">
                                            <p>現在の売上: <span className="font-bold text-brown-800">¥{selectedStaff.sales.toLocaleString()}</span></p>
                                            <p>現在の目標: <span className="font-bold text-brown-800">¥{selectedStaff.target.toLocaleString()}</span></p>
                                        </div>
                                        <button
                                            onClick={() => {
                                                if (onUpdateStaff && selectedStaff) {
                                                    const newTarget = displayTarget || 0;
                                                    onUpdateStaff(selectedStaff.id, {
                                                        ...selectedStaff,
                                                        target: newTarget
                                                    });
                                                    alert(`${selectedStaff.name}の目標を¥${newTarget.toLocaleString()}に設定しました`);
                                                }
                                            }}
                                            className="w-full px-3 py-2 bg-gold-600 hover:bg-gold-700 text-white text-xs font-medium rounded-lg transition-colors shadow-sm"
                                        >
                                            この目標を{selectedStaff.name}に設定
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            {/* 左カラム: 目標設定 */}
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-xs font-bold text-gray-500 uppercase mb-2">月間目標売上（手入力可）</label>
                                    <div className="relative">
                                        <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">¥</span>
                                        <input
                                            type="text"
                                            inputMode="numeric"
                                            value={manualTarget || targetSales}
                                            onChange={(e) => setManualTarget(normalizeNumberInput(e.target.value))}
                                            className="w-full pl-8 pr-4 py-2 text-xl font-bold text-brown-800 bg-gold-50 border border-gold-200 rounded-lg focus:border-gold-500 outline-none"
                                        />
                                    </div>
                                </div>

                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h4 className="font-bold text-sm text-blue-900 mb-3">新規顧客</h4>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="text-xs text-gray-600">新規人数</label>
                                            <input type="text" inputMode="numeric" value={newCustomers} onChange={(e) => setNewCustomers(Number(normalizeNumberInput(e.target.value)) || 0)} className="w-full mt-1 px-3 py-2 border border-gray-300 rounded text-sm focus:border-blue-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-600">新規単価</label>
                                            <input type="text" inputMode="numeric" value={newCustomerPrice} onChange={(e) => setNewCustomerPrice(Number(normalizeNumberInput(e.target.value)) || 0)} className="w-full mt-1 px-3 py-2 border border-gray-300 rounded text-sm focus:border-blue-500 outline-none" />
                                        </div>
                                        <div className="pt-2 border-t border-blue-200 text-sm font-bold text-blue-900">
                                            売上: ¥{newCustomerSales.toLocaleString()}
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                                    <h4 className="font-bold text-sm text-emerald-900 mb-3">リピート顧客</h4>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="text-xs text-gray-600">リピート人数</label>
                                            <input type="text" inputMode="numeric" value={repeatCustomers} onChange={(e) => setRepeatCustomers(Number(normalizeNumberInput(e.target.value)) || 0)} className="w-full mt-1 px-3 py-2 border border-gray-300 rounded text-sm focus:border-emerald-500 outline-none" />
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-600">リピート単価</label>
                                            <input type="text" inputMode="numeric" value={repeatCustomerPrice} onChange={(e) => setRepeatCustomerPrice(Number(normalizeNumberInput(e.target.value)) || 0)} className="w-full mt-1 px-3 py-2 border border-gray-300 rounded text-sm focus:border-emerald-500 outline-none" />
                                        </div>
                                        <div className="pt-2 border-t border-emerald-200 text-sm font-bold text-emerald-900">
                                            売上: ¥{repeatCustomerSales.toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* 中央カラム: 回数券・オプション */}
                            <div className="space-y-6">
                                <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                    <h4 className="font-bold text-sm text-purple-900 mb-3">回数券販売</h4>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="text-xs text-gray-600">購入率（新規の%）</label>
                                            <div className="flex items-center gap-2">
                                                <input type="range" min="0" max="100" value={ticketPurchaseRate} onChange={(e) => setTicketPurchaseRate(Number(e.target.value))} className="flex-1 accent-purple-500" />
                                                <span className="text-sm font-bold text-purple-900 w-12">{ticketPurchaseRate}%</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-600">回数券平均価格</label>
                                            <input type="text" inputMode="numeric" value={ticketAvgPrice} onChange={(e) => setTicketAvgPrice(Number(normalizeNumberInput(e.target.value)) || 0)} className="w-full mt-1 px-3 py-2 border border-gray-300 rounded text-sm focus:border-purple-500 outline-none" />
                                        </div>
                                        <div className="text-xs text-gray-500">
                                            予想購入件数: {ticketPurchaseCount}件
                                        </div>
                                        <div className="pt-2 border-t border-purple-200 text-sm font-bold text-purple-900">
                                            売上: ¥{ticketSales.toLocaleString()}
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                                    <h4 className="font-bold text-sm text-amber-900 mb-3">オプション追加</h4>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="text-xs text-gray-600">追加率（全体の%）</label>
                                            <div className="flex items-center gap-2">
                                                <input type="range" min="0" max="100" value={optionRate} onChange={(e) => setOptionRate(Number(e.target.value))} className="flex-1 accent-amber-500" />
                                                <span className="text-sm font-bold text-amber-900 w-12">{optionRate}%</span>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-xs text-gray-600">オプション平均価格</label>
                                            <input type="text" inputMode="numeric" value={optionAvgPrice} onChange={(e) => setOptionAvgPrice(Number(normalizeNumberInput(e.target.value)) || 0)} className="w-full mt-1 px-3 py-2 border border-gray-300 rounded text-sm focus:border-amber-500 outline-none" />
                                        </div>
                                        <div className="text-xs text-gray-500">
                                            予想追加件数: {optionCount}件
                                        </div>
                                        <div className="pt-2 border-t border-amber-200 text-sm font-bold text-amber-900">
                                            売上: ¥{optionSales.toLocaleString()}
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-rose-50 border border-rose-200 rounded-lg p-4">
                                    <h4 className="font-bold text-sm text-rose-900 mb-3">物販売上</h4>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="text-xs text-gray-600">月間物販売上</label>
                                            <input type="text" inputMode="numeric" value={productSalesPerMonth} onChange={(e) => setProductSalesPerMonth(Number(normalizeNumberInput(e.target.value)) || 0)} className="w-full mt-1 px-3 py-2 border border-gray-300 rounded text-sm focus:border-rose-500 outline-none" />
                                        </div>
                                        <div className="pt-2 border-t border-rose-200 text-sm font-bold text-rose-900">
                                            売上: ¥{productSalesPerMonth.toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* 右カラム: 結果表示 */}
                            <div className="space-y-6">
                                <div className="relative bg-gradient-to-br from-brown-900 to-brown-800 rounded-xl p-6 text-white overflow-hidden">
                                    <div className="absolute top-0 right-0 w-48 h-48 bg-gold-500 opacity-10 rounded-full blur-3xl -mr-12 -mt-12"></div>
                                    <div className="relative z-10">
                                        <h3 className="text-gold-200 font-medium mb-1 text-sm">予測月間売上</h3>
                                        <div className="text-4xl font-bold mb-4">¥{projectedSales.toLocaleString()}</div>

                                        <div className="w-full bg-white/20 rounded-full h-2 mb-4">
                                            <div
                                                className={`h-full rounded-full transition-all duration-500 ${diff >= 0 ? 'bg-gold-400' : 'bg-white/50'}`}
                                                style={{width: `${progress}%`}}
                                            ></div>
                                        </div>

                                        {diff < 0 ? (
                                            <div className="bg-white/10 backdrop-blur rounded p-3 border border-white/10">
                                                <p className="text-sm font-bold text-rose-300 mb-1 flex items-center"><Icon name="alert-triangle" size={14} className="mr-2"/> 目標未達成</p>
                                                <p className="text-xs text-gray-300">不足額: ¥{Math.abs(diff).toLocaleString()}</p>
                                            </div>
                                        ) : (
                                            <div className="bg-white/10 backdrop-blur rounded p-3 border border-white/10">
                                                <p className="text-sm font-bold text-emerald-300 mb-1 flex items-center"><Icon name="check" size={14} className="mr-2"/> 目標達成</p>
                                                <p className="text-xs text-gray-300">余剰: +¥{diff.toLocaleString()}</p>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="bg-white border border-gold-200 rounded-xl p-5">
                                    <h4 className="font-bold text-brown-800 mb-4 text-sm">売上内訳</h4>
                                    <div className="space-y-2 text-sm">
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">新規顧客売上</span>
                                            <span className="font-bold text-blue-700">¥{newCustomerSales.toLocaleString()}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">リピート売上</span>
                                            <span className="font-bold text-emerald-700">¥{repeatCustomerSales.toLocaleString()}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">回数券売上</span>
                                            <span className="font-bold text-purple-700">¥{ticketSales.toLocaleString()}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">オプション売上</span>
                                            <span className="font-bold text-amber-700">¥{optionSales.toLocaleString()}</span>
                                        </div>
                                        <div className="flex justify-between items-center">
                                            <span className="text-gray-600">物販売上</span>
                                            <span className="font-bold text-rose-700">¥{productSalesPerMonth.toLocaleString()}</span>
                                        </div>
                                        <div className="pt-3 mt-3 border-t border-gray-200 flex justify-between items-center">
                                            <span className="font-bold text-brown-800">合計</span>
                                            <span className="font-bold text-xl text-gold-600">¥{projectedSales.toLocaleString()}</span>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-gold-50 border border-gold-200 rounded-lg p-4">
                                    <h4 className="font-bold text-brown-800 mb-3 text-sm">サマリー</h4>
                                    <div className="space-y-1 text-xs text-gray-700">
                                        <p>• 総来客予測: {totalCustomers}人</p>
                                        <p>• 客単価平均: ¥{Math.round(projectedSales / totalCustomers).toLocaleString()}</p>
                                        <p>• 回数券購入予測: {ticketPurchaseCount}件</p>
                                        <p>• オプション追加予測: {optionCount}件</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </Card>
                </div>
            );
        };


        // --- Master Data Management View ---
        const MasterDataManagementView = ({ onSelectMaster }) => {
            const masterOptions = [
                {
                    id: 'staff',
                    icon: 'users',
                    title: 'スタッフ管理',
                    description: 'スタッフの追加・編集・削除',
                    bgColor: 'bg-blue-50',
                    borderColor: 'border-blue-200',
                    hoverBorder: 'hover:border-blue-400',
                    iconBg: 'bg-blue-100',
                    iconBgHover: 'group-hover:bg-blue-200',
                    iconColor: 'text-blue-600',
                    chevronColor: 'text-blue-400',
                    chevronHover: 'group-hover:text-blue-600'
                },
                {
                    id: 'menus',
                    icon: 'package',
                    title: 'メニュー管理',
                    description: 'メニューの追加・編集・削除',
                    bgColor: 'bg-purple-50',
                    borderColor: 'border-purple-200',
                    hoverBorder: 'hover:border-purple-400',
                    iconBg: 'bg-purple-100',
                    iconBgHover: 'group-hover:bg-purple-200',
                    iconColor: 'text-purple-600',
                    chevronColor: 'text-purple-400',
                    chevronHover: 'group-hover:text-purple-600'
                },
                {
                    id: 'customers',
                    icon: 'heart',
                    title: '顧客・回数券管理',
                    description: '顧客情報と回数券の管理',
                    bgColor: 'bg-rose-50',
                    borderColor: 'border-rose-200',
                    hoverBorder: 'hover:border-rose-400',
                    iconBg: 'bg-rose-100',
                    iconBgHover: 'group-hover:bg-rose-200',
                    iconColor: 'text-rose-600',
                    chevronColor: 'text-rose-400',
                    chevronHover: 'group-hover:text-rose-600'
                },
                {
                    id: 'media',
                    icon: 'megaphone',
                    title: '媒体マスター',
                    description: '集客媒体の追加・編集',
                    bgColor: 'bg-amber-50',
                    borderColor: 'border-amber-200',
                    hoverBorder: 'hover:border-amber-400',
                    iconBg: 'bg-amber-100',
                    iconBgHover: 'group-hover:bg-amber-200',
                    iconColor: 'text-amber-600',
                    chevronColor: 'text-amber-400',
                    chevronHover: 'group-hover:text-amber-600'
                },
            ];

            return (
                <div className="space-y-6">
                    <Card>
                        <div className="mb-6">
                            <h2 className="text-2xl font-bold text-brown-800 serif mb-2">マスターデータ管理</h2>
                            <p className="text-sm text-gray-600">基本データの登録・編集を行います</p>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {masterOptions.map(option => (
                                <button
                                    key={option.id}
                                    onClick={() => onSelectMaster(option.id)}
                                    className={`group p-6 rounded-xl border-2 transition-all duration-200 text-left hover:shadow-lg hover:scale-[1.02] ${option.bgColor} ${option.borderColor} ${option.hoverBorder}`}
                                >
                                    <div className="flex items-start space-x-4">
                                        <div className={`p-3 rounded-lg ${option.iconBg} ${option.iconBgHover} transition-colors`}>
                                            <Icon name={option.icon} size={24} className={option.iconColor} />
                                        </div>
                                        <div className="flex-1">
                                            <h3 className="text-lg font-bold text-brown-800 mb-1 group-hover:text-brown-900">
                                                {option.title}
                                            </h3>
                                            <p className="text-sm text-gray-600">{option.description}</p>
                                        </div>
                                        <Icon name="chevron-right" size={20} className={`${option.chevronColor} ${option.chevronHover} transition-colors`} />
                                    </div>
                                </button>
                            ))}
                        </div>

                        <div className="mt-8 p-4 bg-gold-50 rounded-lg border border-gold-200">
                            <div className="flex items-start space-x-3">
                                <Icon name="info" size={20} className="text-gold-600 flex-shrink-0 mt-0.5" />
                                <div className="text-sm text-brown-800">
                                    <p className="font-bold mb-2">マスターデータについて</p>
                                    <ul className="space-y-1 text-gray-600">
                                        <li>• マスターデータは実績入力や分析の基礎となる重要なデータです</li>
                                        <li>• 変更内容はスプレッドシートに保存することで永続化されます</li>
                                        <li>• 削除したデータは復元できませんのでご注意ください</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </Card>
                </div>
            );
        };


        // --- App Layout & Navigation ---

        const Layout = () => {
            // URLパラメータからスタッフIDを取得
            const urlParams = new URLSearchParams(window.location.search);
            const staffIdFromUrl = urlParams.get('staffId');
            const isStaffMode = staffIdFromUrl !== null;
            const currentStaffId = isStaffMode ? Number(staffIdFromUrl) : null;

            const [activeTab, setActiveTab] = useState('dashboard');
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [mobileOptimized, setMobileOptimized] = useState(false);
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [selectedMaster, setSelectedMaster] = useState(null);
            const [darkMode, setDarkMode] = useState(() => {
                try {
                    const saved = localStorage.getItem('darkMode');
                    if (!saved) return false;
                    // JSONとして解析を試みる
                    return JSON.parse(saved);
                } catch (error) {
                    // エラーが発生した場合はlocalStorageをクリアしてデフォルト値を返す
                    console.warn('darkMode設定の読み込みに失敗しました。デフォルト値を使用します。', error);
                    localStorage.removeItem('darkMode');
                    return false;
                }
            });
            const [staffList, setStaffList] = useState(initialStaffData);
            const [menuList, setMenuList] = useState(menus);
            const [ticketMasterList, setTicketMasterList] = useState(initialTicketMasterData);
            const [customerList, setCustomerList] = useState(initialCustomerData);
            const [mediaSourcesList, setMediaSourcesList] = useState(initialMediaSourcesData);
            const [dailySalesData, setDailySalesData] = useState(initialDailySalesData);
            const [menuSalesData, setMenuSalesData] = useState(initialMenuSalesData);
            const [isSaving, setIsSaving] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            const [saveMessage, setSaveMessage] = useState('');
            const currentDate = new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });

            // 現在のスタッフ情報を取得
            const currentStaff = isStaffMode ? staffList.find(s => s.id === currentStaffId) : null;

            // マスターデータ選択時の処理
            const handleSelectMaster = (masterId) => {
                setSelectedMaster(masterId);
                setActiveTab(masterId); // staff, menus, customers, media
                setMobileMenuOpen(false); // モバイルメニューを閉じる
            };

            // スタッフ管理関数
            const updateStaff = (id, newData) => {
                setStaffList(prev => prev.map(staff => staff.id === id ? newData : staff));
            };

            const addStaff = (newData) => {
                setStaffList(prev => [...prev, newData]);
            };

            const deleteStaff = (id) => {
                setStaffList(prev => prev.filter(staff => staff.id !== id));
            };

            // 回数券マスター管理関数
            const updateTicketMaster = (id, newData) => {
                setTicketMasterList(prev => prev.map(ticket => ticket.id === id ? newData : ticket));
            };

            const addTicketMaster = (newData) => {
                setTicketMasterList(prev => [...prev, newData]);
            };

            const deleteTicketMaster = (id) => {
                setTicketMasterList(prev => prev.filter(ticket => ticket.id !== id));
            };

            // 顧客管理関数
            const updateCustomer = (id, newData) => {
                setCustomerList(prev => prev.map(customer => customer.id === id ? newData : customer));
            };

            const addCustomer = (newData) => {
                setCustomerList(prev => [...prev, newData]);
            };

            const deleteCustomer = (id) => {
                setCustomerList(prev => prev.filter(customer => customer.id !== id));
            };

            // 媒体ソース管理関数
            const updateMediaSource = (id, newData) => {
                setMediaSourcesList(prev => prev.map(media => media.id === id ? newData : media));
            };

            const addMediaSource = (newData) => {
                setMediaSourcesList(prev => [...prev, newData]);
            };

            const deleteMediaSource = (id) => {
                setMediaSourcesList(prev => prev.filter(media => media.id !== id));
            };

            // メニュー管理関数
            const updateMenu = (id, newData) => {
                setMenuList(prev => prev.map(menu => menu.id === id ? newData : menu));
            };

            const addMenu = (newData) => {
                setMenuList(prev => [...prev, newData]);
            };

            const deleteMenu = (id) => {
                setMenuList(prev => prev.filter(menu => menu.id !== id));
            };

            // CSVエクスポート機能
            const handleExportToCSV = (data, filename) => {
                if (!data || data.length === 0) {
                    alert('エクスポートするデータがありません');
                    return;
                }

                // ヘッダー行を取得
                const headers = Object.keys(data[0]);

                // CSVコンテンツを生成
                let csv = '\uFEFF'; // UTF-8 BOM（Excelで文字化け防止）
                csv += headers.join(',') + '\n';

                data.forEach(row => {
                    const values = headers.map(header => {
                        let value = row[header];

                        // 配列の場合はJSON文字列に変換
                        if (Array.isArray(value)) {
                            value = JSON.stringify(value);
                        }

                        // null/undefinedの場合は空文字
                        if (value === null || value === undefined) {
                            value = '';
                        }

                        // 文字列の場合、カンマや改行を含む場合はダブルクォートで囲む
                        value = String(value);
                        if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                            value = '"' + value.replace(/"/g, '""') + '"';
                        }

                        return value;
                    });
                    csv += values.join(',') + '\n';
                });

                // Blobを作成してダウンロード
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            // スプレッドシートに全データを保存
            const handleSaveToSpreadsheet = async () => {
                setIsSaving(true);
                setSaveMessage('');

                try {
                    await saveToSpreadsheet('saveAllData', {
                        staffData: staffList,
                        ticketData: ticketMasterList,
                        customerData: customerList,
                        menuData: menuList,
                        mediaData: mediaSourcesList,
                        dailySalesData: dailySalesData,
                        menuSalesData: menuSalesData
                    });

                    setSaveMessage('✓ データをスプレッドシートに保存しました');
                    setTimeout(() => setSaveMessage(''), 3000);
                } catch (error) {
                    setSaveMessage('✗ 保存エラー: ' + error.message);
                }

                setIsSaving(false);
            };

            // スプレッドシートから全データを読み込み
            const handleLoadFromSpreadsheet = async () => {
                setIsLoading(true);
                setSaveMessage('');

                // GAS URLが設定されているかチェック
                if (!GAS_WEB_APP_URL || GAS_WEB_APP_URL === 'YOUR_GAS_WEB_APP_URL_HERE') {
                    setSaveMessage('✗ スプレッドシートURLが設定されていません。index.htmlのGAS_WEB_APP_URLを設定してください。');
                    setIsLoading(false);
                    return;
                }

                try {
                    const response = await fetch(GAS_WEB_APP_URL + '?action=getAllData', {
                        method: 'GET'
                    });

                    // レスポンスのステータスチェック
                    if (!response.ok) {
                        throw new Error(`HTTPエラー: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();

                    if (result.success && result.data) {
                        // データの読み込み
                        if (result.data.staff) {
                            setStaffList(result.data.staff);
                        }
                        if (result.data.ticketMasters) {
                            setTicketMasterList(result.data.ticketMasters);
                        }
                        if (result.data.customers) {
                            setCustomerList(result.data.customers);
                        }
                        if (result.data.menus) {
                            setMenuList(result.data.menus);
                        }
                        if (result.data.mediaSources) {
                            setMediaSourcesList(result.data.mediaSources);
                        }

                        setSaveMessage('✓ データをスプレッドシートから読み込みました');
                        setTimeout(() => setSaveMessage(''), 3000);
                    } else {
                        const errorMsg = result.error || 'データの読み込みに失敗しました';
                        setSaveMessage('✗ ' + errorMsg);
                        console.error('読み込みエラー:', result);
                    }
                } catch (error) {
                    console.error('読み込みエラー詳細:', error);
                    let errorMessage = '読み込みエラー: ';

                    if (error.message.includes('Failed to fetch')) {
                        errorMessage += 'ネットワークエラー。スプレッドシートURLを確認してください。';
                    } else if (error.message.includes('JSON')) {
                        errorMessage += 'レスポンス形式エラー。GASスクリプトを確認してください。';
                    } else {
                        errorMessage += error.message;
                    }

                    setSaveMessage('✗ ' + errorMessage);
                }

                setIsLoading(false);
            };

            // ダークモード切り替え
            const toggleDarkMode = () => {
                setDarkMode(prev => {
                    const newMode = !prev;
                    localStorage.setItem('darkMode', JSON.stringify(newMode));
                    return newMode;
                });
            };

            // ダークモード適用
            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [darkMode]);

            // 初回ロード時にデータを自動取得（全モード対応）
            // 注意: 初回自動読み込みは無効化されています。必要に応じて手動で「読み込み」ボタンを使用してください。
            useEffect(() => {
                // GAS URLが設定されている場合、自動的にデータを読み込む
                // 一時的に無効化: GAS設定が完了してから有効化してください
                // if (GAS_WEB_APP_URL && GAS_WEB_APP_URL !== 'YOUR_GAS_WEB_APP_URL_HERE') {
                //     handleLoadFromSpreadsheet();
                // }
            }, []); // 初回マウント時のみ実行

            const NavItem = ({ id, icon, label }) => (
                <button
                    onClick={() => {
                        setActiveTab(id);
                        setSelectedMaster(null);
                        if (mobileOptimized) setMobileMenuOpen(false);
                    }}
                    className={`w-full flex items-center space-x-3 px-4 my-1 rounded-lg transition-all duration-200 border-l-4 ${
                        activeTab === id
                        ? 'border-gold-500 bg-gold-50 text-brown-800 font-bold shadow-sm'
                        : 'border-transparent text-gray-500 hover:text-brown-800 hover:bg-white'
                    } ${mobileOptimized ? 'py-4 text-base touch-feedback' : 'py-3'}`}
                >
                    <Icon name={icon} size={mobileOptimized ? 24 : 20} className={activeTab === id ? 'text-gold-600' : 'text-gray-400'} />
                    {(sidebarOpen || mobileOptimized) && <span className={activeTab === id ? 'serif font-semibold' : ''}>{label}</span>}
                </button>
            );

            return (
                <div className="flex h-screen bg-brown-50 font-sans text-brown-900 overflow-hidden">
                    {/* Mobile Overlay */}
                    {mobileOptimized && mobileMenuOpen && (
                        <div
                            className="fixed inset-0 bg-black/50 z-30 lg:hidden"
                            onClick={() => setMobileMenuOpen(false)}
                        ></div>
                    )}

                    {/* Sidebar */}
                    <div className={`
                        ${mobileOptimized ? (
                            mobileMenuOpen ? 'translate-x-0' : '-translate-x-full'
                        ) : (
                            sidebarOpen ? 'w-64' : 'w-20'
                        )}
                        ${mobileOptimized ? 'fixed inset-y-0 left-0 w-64 z-40' : 'relative'}
                        bg-white border-r border-gold-200 flex flex-col transition-all duration-300 shadow-xl
                    `}>
                        <div className="h-20 flex items-center justify-center border-b border-gold-100 bg-white">
                            {sidebarOpen ? (
                                <h1 className="text-2xl font-bold text-brown-800 flex items-center serif tracking-wider">
                                    <span className="text-gold-500 mr-2 text-3xl">✦</span> LuxeMetrics
                                </h1>
                            ) : (
                                <span className="text-gold-500 text-3xl">✦</span>
                            )}
                        </div>

                        <div className="flex-1 py-6 px-2 space-y-1">
                            {isStaffMode ? (
                                <>
                                    <NavItem id="dashboard" icon="layout-dashboard" label="マイダッシュボード" />
                                    <NavItem id="input" icon="edit" label="実績入力" />
                                    <NavItem id="calendar" icon="calendar" label="マイカレンダー" />
                                </>
                            ) : (
                                <>
                                    <NavItem id="dashboard" icon="layout-dashboard" label="ダッシュボード" />
                                    <NavItem id="input" icon="edit" label="実績入力" />
                                    <NavItem id="simulation" icon="target" label="目標シミュレーション" />
                                    <NavItem id="calendar" icon="calendar" label="カレンダービュー" />
                                    <NavItem id="sales" icon="bar-chart-2" label="売上・媒体分析" />
                                    <NavItem id="menus" icon="package" label="メニュー別分析" />
                                    <NavItem id="staff" icon="users" label="スタッフ管理" />
                                    <NavItem id="customers" icon="heart" label="顧客・回数券管理" />
                                    <NavItem id="line" icon="message-circle" label="LINE連携" />
                                </>
                            )}
                        </div>

                        <div className={`border-t border-gold-100 bg-gold-50/50 ${mobileOptimized ? 'p-3' : 'p-4'}`}>
                             <button
                                onClick={() => {
                                    setActiveTab('master');
                                    setSelectedMaster(null);
                                    if (mobileOptimized) setMobileMenuOpen(false);
                                }}
                                className={`w-full flex items-center space-x-3 px-4 rounded-lg transition-colors ${
                                    activeTab === 'master' ? 'bg-gold-200 text-brown-800 font-bold' : 'text-gray-500 hover:bg-white hover:text-brown-800'
                                } ${mobileOptimized ? 'py-4 text-base font-semibold touch-feedback' : 'py-3'} ${(!sidebarOpen && !mobileOptimized) && 'justify-center'}`}
                            >
                                <Icon name="database" size={mobileOptimized ? 24 : 20} />
                                {(sidebarOpen || mobileOptimized) && <span>マスターデータ</span>}
                            </button>
                            {!mobileOptimized && (
                                <button
                                    onClick={() => setSidebarOpen(!sidebarOpen)}
                                    className="mt-2 w-full flex items-center justify-center p-2 text-gold-400 hover:text-gold-600"
                                >
                                    <Icon name={sidebarOpen ? "chevrons-left" : "chevrons-right"} size={20} />
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 flex flex-col overflow-hidden relative bg-[#f9f8f4]">
                        {/* Topbar */}
                        <header className={`bg-white/95 backdrop-blur-md border-b border-gold-100 flex justify-between items-center shadow-sm z-10 sticky top-0 safe-top hw-accelerate ${
                            mobileOptimized ? 'mobile-header' : 'h-20 px-8'
                        }`}>
                            <div className="flex items-center space-x-3">
                                {mobileOptimized && (
                                    <button
                                        onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
                                        className="p-2.5 rounded-lg hover:bg-gold-50 transition-colors touch-feedback"
                                        aria-label="メニューを開く"
                                    >
                                        <Icon name="menu" size={24} className="text-brown-800" />
                                    </button>
                                )}
                                <div>
                                    <h2 className={`font-bold text-brown-800 serif ${mobileOptimized ? 'text-sm' : 'text-xl'}`}>
                                        {activeTab === 'dashboard' && (isStaffMode ? (mobileOptimized ? 'ダッシュボード' : 'My Dashboard') : (mobileOptimized ? '経営サマリー' : 'Executive Summary'))}
                                        {activeTab === 'input' && (mobileOptimized ? '実績入力' : 'Performance Input')}
                                        {activeTab === 'simulation' && (mobileOptimized ? 'シミュレーション' : 'Strategy Simulation')}
                                        {activeTab === 'sales' && (mobileOptimized ? '売上分析' : 'Sales & Marketing Analytics')}
                                        {activeTab === 'menus' && (mobileOptimized ? 'メニュー分析' : 'Menu Performance Analysis')}
                                        {activeTab === 'staff' && (mobileOptimized ? 'スタッフ管理' : 'Staff Performance & Management')}
                                        {activeTab === 'customers' && (mobileOptimized ? '顧客管理' : 'Customer & Ticket Management')}
                                        {activeTab === 'master' && (mobileOptimized ? 'マスター管理' : 'Master Data Management')}
                                        {activeTab === 'line' && (mobileOptimized ? 'LINE連携' : 'LINE Integration')}
                                    </h2>
                                    {!mobileOptimized && (
                                        <p className="text-xs text-gold-600 font-medium tracking-widest uppercase mt-1">
                                            {activeTab === 'dashboard' && (isStaffMode ? 'マイダッシュボード' : '経営サマリー')}
                                            {activeTab === 'input' && '実績入力'}
                                            {activeTab === 'simulation' && '経営シミュレーション'}
                                            {activeTab === 'sales' && '売上詳細・媒体分析'}
                                            {activeTab === 'menus' && 'メニュー別分析'}
                                            {activeTab === 'staff' && 'スタッフ管理・編集'}
                                            {activeTab === 'customers' && '顧客リスト・回数券管理'}
                                            {activeTab === 'master' && 'マスターデータ管理'}
                                            {activeTab === 'line' && 'LINE公式アカウント連携'}
                                        </p>
                                    )}
                                </div>
                            </div>
                            <div className={`flex items-center ${mobileOptimized ? 'space-x-2' : 'space-x-6'}`}>
                                {/* 予約管理ボタン */}
                                <button
                                    onClick={() => window.open('https://salonboard.com/login/', '_blank')}
                                    className={`flex items-center bg-gold-600 hover:bg-gold-700 text-white font-medium rounded-lg shadow-sm transition-colors touch-feedback ${
                                        mobileOptimized ? 'px-2.5 py-2.5' : 'px-4 py-2 text-sm'
                                    }`}
                                    aria-label="予約管理を開く"
                                >
                                    <Icon name="calendar-check" size={mobileOptimized ? 16 : 16} className={mobileOptimized ? '' : 'mr-2'} />
                                    {!mobileOptimized && '予約管理'}
                                </button>
                                {!mobileOptimized && <div className="h-8 w-px bg-gold-200"></div>}
                                {/* スプレッドシート保存・読み込みボタン */}
                                <div className="flex flex-col items-end">
                                    <div className="flex gap-2">
                                        <button
                                            onClick={handleLoadFromSpreadsheet}
                                            disabled={isLoading}
                                            className={`flex items-center bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium rounded-lg shadow-sm transition-colors touch-feedback ${
                                                mobileOptimized ? 'px-2.5 py-2.5' : 'px-4 py-2 text-sm'
                                            }`}
                                            aria-label="データを読み込む"
                                        >
                                            <Icon name={isLoading ? "loader" : "download"} size={mobileOptimized ? 16 : 16} className={`${isLoading ? 'animate-spin' : ''} ${mobileOptimized ? '' : 'mr-2'}`} />
                                            {!mobileOptimized && (isLoading ? '読込中...' : '読み込み')}
                                        </button>
                                        <button
                                            onClick={handleSaveToSpreadsheet}
                                            disabled={isSaving}
                                            className={`flex items-center bg-emerald-600 hover:bg-emerald-700 disabled:bg-gray-400 text-white font-medium rounded-lg shadow-sm transition-colors touch-feedback ${
                                                mobileOptimized ? 'px-2.5 py-2.5' : 'px-4 py-2 text-sm'
                                            }`}
                                            aria-label="データを保存する"
                                        >
                                            <Icon name={isSaving ? "loader" : "save"} size={mobileOptimized ? 16 : 16} className={`${isSaving ? 'animate-spin' : ''} ${mobileOptimized ? '' : 'mr-2'}`} />
                                            {!mobileOptimized && (isSaving ? '保存中...' : '保存')}
                                        </button>
                                    </div>
                                    {saveMessage && (
                                        <span className={`text-xs mt-1 ${saveMessage.includes('✓') ? 'text-emerald-600' : 'text-rose-600'}`}>
                                            {saveMessage}
                                        </span>
                                    )}
                                </div>
                                {!mobileOptimized && <div className="h-8 w-px bg-gold-200"></div>}
                                {/* Dark Mode Toggle */}
                                <button
                                    onClick={toggleDarkMode}
                                    className={`flex items-center rounded-lg font-semibold transition-all touch-feedback ${
                                        mobileOptimized
                                            ? 'bg-gray-700 text-yellow-300 shadow-md px-2.5 py-2.5'
                                            : 'bg-white text-gray-600 border border-gray-300 hover:bg-gray-50 px-3 py-2 text-sm'
                                    }`}
                                    title={darkMode ? 'ライトモードに切替' : 'ダークモードに切替'}
                                    aria-label={darkMode ? 'ライトモードに切替' : 'ダークモードに切替'}
                                >
                                    <Icon name={darkMode ? "sun" : "moon"} size={mobileOptimized ? 20 : 16} className={mobileOptimized ? '' : 'mr-2'} />
                                    {!mobileOptimized && <span className="hidden lg:inline">{darkMode ? 'Light' : 'Dark'}</span>}
                                </button>
                                {!mobileOptimized && <div className="h-8 w-px bg-gold-200"></div>}
                                {/* Mobile/PC Toggle */}
                                <button
                                    onClick={() => setMobileOptimized(!mobileOptimized)}
                                    className={`flex items-center rounded-lg font-semibold transition-all touch-feedback ${
                                        mobileOptimized
                                            ? 'bg-purple-600 text-white shadow-md px-2.5 py-2.5'
                                            : 'bg-white text-gray-600 border border-gray-300 hover:bg-purple-50 px-3 py-2 text-sm'
                                    }`}
                                    title={mobileOptimized ? 'PC表示に切替' : 'スマホ表示に切替'}
                                    aria-label={mobileOptimized ? 'PC表示に切替' : 'スマホ表示に切替'}
                                >
                                    <Icon name={mobileOptimized ? "smartphone" : "monitor"} size={mobileOptimized ? 20 : 16} className={mobileOptimized ? '' : 'mr-2'} />
                                    {!mobileOptimized && <span className="hidden lg:inline">{mobileOptimized ? 'モバイル' : 'PC'}</span>}
                                </button>
                                {!mobileOptimized && (
                                    <>
                                        <div className="h-8 w-px bg-gold-200"></div>
                                        <div className="text-right hidden md:block">
                                            <p className="text-sm font-bold text-brown-800">{currentDate}</p>
                                            <p className="text-xs text-gray-400">Tokyo, Japan</p>
                                        </div>
                                        <div className="h-8 w-px bg-gold-200"></div>
                                        <div className="flex items-center space-x-3">
                                            <div className="w-10 h-10 rounded-full bg-brown-800 border-2 border-gold-300 flex items-center justify-center text-gold-100 text-sm font-serif">
                                                {isStaffMode && currentStaff ? currentStaff.name.charAt(0) : 'OP'}
                                            </div>
                                            <div className="hidden md:block">
                                                <p className="text-sm font-bold text-brown-800">
                                                    {isStaffMode && currentStaff ? currentStaff.name : 'オーナー様'}
                                                </p>
                                                <p className="text-xs text-gold-600">
                                                    {isStaffMode && currentStaff ? currentStaff.role : 'Administrator'}
                                                </p>
                                            </div>
                                        </div>
                                    </>
                                )}
                            </div>
                        </header>

                        {/* Content Area */}
                        <main className={`flex-1 overflow-y-auto transition-all safe-bottom ${mobileOptimized ? 'p-3 pt-4' : 'p-8'}`}>
                            <div className={`mx-auto ${mobileOptimized ? 'max-w-full pb-6' : 'max-w-7xl pb-10'}`}>
                                {activeTab === 'dashboard' && (
                                    isStaffMode && currentStaff ? (
                                        // スタッフモード: 自分の成績と店舗目標のみ表示
                                        <div className="space-y-6">
                                            <Card>
                                                <h2 className="text-2xl font-bold text-brown-800 mb-6 serif">あなたの実績</h2>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                    <div>
                                                        <p className="text-sm text-gray-500 mb-1">今月の売上実績</p>
                                                        <p className="text-3xl font-bold text-gold-600">¥{currentStaff.sales.toLocaleString()}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-sm text-gray-500 mb-1">売上目標</p>
                                                        <p className="text-3xl font-bold text-brown-800">¥{currentStaff.target.toLocaleString()}</p>
                                                    </div>
                                                </div>
                                                <div className="mt-4">
                                                    <p className="text-sm text-gray-500 mb-2">達成率</p>
                                                    <div className="w-full bg-gray-200 rounded-full h-4">
                                                        <div className={`h-4 rounded-full ${currentStaff.sales >= currentStaff.target ? 'bg-emerald-500' : 'bg-gold-500'}`}
                                                            style={{width: `${currentStaff.target > 0 ? Math.min(100, (currentStaff.sales / currentStaff.target) * 100) : 0}%`}}></div>
                                                    </div>
                                                    <p className="text-right text-sm font-bold text-gray-700 mt-1">
                                                        {currentStaff.target > 0 ? Math.round((currentStaff.sales / currentStaff.target) * 100) : 0}%
                                                    </p>
                                                </div>
                                                <div className="grid grid-cols-3 gap-4 mt-6 pt-6 border-t border-gray-200">
                                                    <div className="text-center">
                                                        <p className="text-sm text-gray-500">指名数</p>
                                                        <p className="text-2xl font-bold text-brown-800">{currentStaff.nomination}</p>
                                                    </div>
                                                    <div className="text-center border-l border-gray-200">
                                                        <p className="text-sm text-gray-500">リピート率</p>
                                                        <p className="text-2xl font-bold text-emerald-600">{currentStaff.retention}%</p>
                                                    </div>
                                                    <div className="text-center border-l border-gray-200">
                                                        <p className="text-sm text-gray-500">口コミ評価</p>
                                                        <p className="text-2xl font-bold text-gold-600">{currentStaff.reviewScore || 0}</p>
                                                    </div>
                                                </div>
                                            </Card>

                                            <Card>
                                                <h2 className="text-xl font-bold text-brown-800 mb-4 serif">店舗全体の目標</h2>
                                                <div className="space-y-4">
                                                    <div>
                                                        <p className="text-sm text-gray-500 mb-1">今月の店舗目標</p>
                                                        <p className="text-2xl font-bold text-brown-800">
                                                            ¥{staffList.filter(s => s.storeId === currentStaff.storeId).reduce((sum, s) => sum + s.target, 0).toLocaleString()}
                                                        </p>
                                                    </div>
                                                    <div>
                                                        <p className="text-sm text-gray-500 mb-1">現在の実績</p>
                                                        <p className="text-2xl font-bold text-gold-600">
                                                            ¥{staffList.filter(s => s.storeId === currentStaff.storeId).reduce((sum, s) => sum + s.sales, 0).toLocaleString()}
                                                        </p>
                                                    </div>
                                                </div>
                                            </Card>

                                            <div className="bg-gold-50 border border-gold-200 rounded-lg p-6">
                                                <h3 className="font-bold text-brown-800 mb-2">💡 スタッフURLについて</h3>
                                                <p className="text-sm text-gray-700">
                                                    このページはあなた専用のURLです。他のスタッフの詳細情報は表示されません。<br/>
                                                    「実績入力」から日々の売上を記録しましょう！
                                                </p>
                                            </div>
                                        </div>
                                    ) : (
                                        <DashboardView
                                            staffList={staffList}
                                            dailySalesData={dailySalesData}
                                            menuSalesData={menuSalesData}
                                            mediaSourcesData={mediaSourcesList}
                                            customerList={customerList}
                                            onNavigate={setActiveTab}
                                            mobileOptimized={mobileOptimized}
                                            storeData={[
                                                { id: 1, name: '新宿店' },
                                                { id: 2, name: '新宿南口店' }
                                            ]}
                                        />
                                    )
                                )}
                                {activeTab === 'input' && <PerformanceInputView
                                    dailySalesData={dailySalesData}
                                    setDailySalesData={setDailySalesData}
                                    menuSalesData={menuSalesData}
                                    setMenuSalesData={setMenuSalesData}
                                    staffList={staffList}
                                />}
                                {!isStaffMode && activeTab === 'staff' && <StaffManagementView staffList={staffList} onUpdateStaff={updateStaff} onAddStaff={addStaff} onDeleteStaff={deleteStaff} exportToCSV={handleExportToCSV} />}
                                {!isStaffMode && activeTab === 'simulation' && <SimulationView staffList={staffList} onUpdateStaff={updateStaff} />}
                                {!isStaffMode && activeTab === 'master' && !selectedMaster && (
                                    <MasterDataManagementView onSelectMaster={handleSelectMaster} />
                                )}
                                {!isStaffMode && activeTab === 'sales' && (
                                    <SalesAnalysisView
                                        dailySalesData={dailySalesData}
                                        mediaSourcesData={mediaSourcesList}
                                        onUpdateMediaSource={updateMediaSource}
                                    />
                                )}
                                {!isStaffMode && activeTab === 'menus' && selectedMaster === 'menus' && (
                                    <MenuManagementView
                                        menuList={menuList}
                                        onUpdateMenu={updateMenu}
                                        onAddMenu={addMenu}
                                        onDeleteMenu={deleteMenu}
                                    />
                                )}
                                {activeTab === 'calendar' && <CalendarView dailySalesData={dailySalesData} staffId={isStaffMode ? currentStaffId : null} />}
                                {!isStaffMode && activeTab === 'menus' && !selectedMaster && <MenuAnalysisView menuSalesData={menuSalesData} />}
                                {!isStaffMode && activeTab === 'media' && (
                                    <MediaSourceManagementView
                                        mediaSourcesList={mediaSourcesList}
                                        onUpdateMedia={updateMediaSource}
                                        onAddMedia={addMediaSource}
                                        onDeleteMedia={deleteMediaSource}
                                    />
                                )}
                                {!isStaffMode && activeTab === 'customers' && (
                                    <CustomerTicketManagementView
                                        ticketMasterList={ticketMasterList}
                                        customerList={customerList}
                                        onUpdateTicketMaster={updateTicketMaster}
                                        onAddTicketMaster={addTicketMaster}
                                        onDeleteTicketMaster={deleteTicketMaster}
                                        onUpdateCustomer={updateCustomer}
                                        onAddCustomer={addCustomer}
                                        exportToCSV={handleExportToCSV}
                                        onDeleteCustomer={deleteCustomer}
                                    />
                                )}
                                {!isStaffMode && activeTab === 'line' && (
                                    <LineIntegrationView
                                        customerList={customerList}
                                    />
                                )}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<Layout />);
        } catch (error) {
            console.error('レンダリングエラー:', error);
            document.body.innerHTML = `
                <div style="padding: 40px; font-family: sans-serif;">
                    <h1 style="color: red;">エラーが発生しました</h1>
                    <pre style="background: #f5f5f5; padding: 20px; overflow: auto;">${error.toString()}\n\n${error.stack}</pre>
                    <p>ブラウザのコンソール（F12キー）で詳細を確認してください。</p>
                </div>
            `;
        }
    </script>
</body>
</html>
